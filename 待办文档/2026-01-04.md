# 2026-01-04 待办

> [!IMPORTANT]
> **后期所有技能完成后，统一调整技能互斥关系**（Ability Blocked Tags / Cancel Tags）

## 当前阶段：关卡1 耐力之匣 - Phase 1 闪避/摔倒系统

### 今日任务

- [x] **闪避系统（GA_Dodge）**
  - [x] IA_Endurance_Dodge 创建
  - [x] GA_Dodge 创建（Check Stamina + Effect Container）
  - [x] GE_Dodging 创建（Dodging + Danger 标签）
  - [x] GE_Invincible 创建（Invincible 标签）
  - [x] 闪避蒙太奇 + AN_GSC 无敌帧事件
  - [x] GE_StaminaCost -20
  - [x] AbilitySet_Endurance 添加

- [x] **摔倒系统（GA_Fall）**
  - [x] GA_Fall 创建（Gameplay Event 触发）
  - [x] GE_Fallen 创建（Fallen + Danger 标签）
  - [x] 摔倒蒙太奇（Fall_Down → Delay 5s → Fall_GetUp）

- [x] **修改 GA_Push 检测逻辑**
  - [x] 命中检查无敌标签
  - [x] 有无敌 → 推搡者摔倒
  - [x] 无无敌 → 目标失衡

- [x] **失衡系统（GA_Stagger）**
  - [x] GA_Stagger 创建（Gameplay Event 触发）
  - [x] GE_Staggered 创建（Staggered 标签，无 Danger）
  - [x] 失衡蒙太奇（Stagger_Start）
  - [x] 超时触发 GA_Fall
  - [x] Stagger Idle（动画蓝图 Endurance_Stagger）
  - [x] Fallen Idle（动画蓝图 Endurance_Fall）

---

## 开发计划总览

### Phase 0：测试环境搭建（✅ 完成）

### Phase 1：基础移动 + 玩家交互
- [x] 奔跑体力消耗（GE_StaminaDrain_Sprint）
- [x] 体力自动回复（GE_StaminaRegen）
- [x] 力竭机制（GE_Exhausted + GA_Exhausted）
- [x] 蹲行系统（GA_Crouch + GE_Crouch）
- [x] 速度属性同步修复（PostAttributeChange）
- [x] 蹲下/起身危险标签（Comp_Character_Endurance.HandleCrouching）
- [x] 跳跃体力消耗（GA_Jump + GE_StaminaCost）
- [x] 推搡系统（GA_Push + GE_Pushing + 检测逻辑）
- [x] 闪避系统（GA_Dodge + GE_Dodging + GE_Invincible）
- [x] 摔倒系统（GA_Fall + GE_Fallen）
- [x] 失衡系统（GA_Stagger + GE_Staggered）
- [ ] DetectionBox 组件

### Phase 2：道具系统
- [ ] 投掷类（MOTS 插件）：香蕉皮、炸弹
- [ ] Buff 类（GE）：跑鞋、护盾、磁铁
- [ ] 资源类：金币

### Phase 3：完善
- [ ] 死亡判定（HP 归零 → 淘汰）
- [ ] 死亡广播（周围玩家失衡）
- [ ] AI 完善（体力管理、遮挡策略）
- [ ] BTTask_Push / BTTask_Dodge（AI 触发）

---

## 架构备忘

**核心设计**：
- 推搡命中目标 → 检查目标 `Player.State.Invincible` 标签
  - 有无敌标签 → 推搡者激活 GA_Fall（摔倒）
  - 无无敌标签 → 目标激活 GA_Stagger（失衡）
- 推搡落空 → 无惩罚

**无敌标签获得方式**：
- 闪避蒙太奇期间（通过 AN_GSC_SendGameplayEventByTag 发送事件，GA_Dodge 添加/移除 GE_Invincible）
- 护盾道具效果期间（GE_Shield Buff）

**体力检查设计**：
- 持续消耗技能（GA_Sprint）→ 使用 `Ability.Require.Stamina` 标签
- 一次性消耗技能（GA_Push/Jump/Dodge）→ 不使用此标签，用 Check Stamina 宏

---

## 已实现动画系统总结

### GA_Stagger 动画流程 ✅
1. 播放"失衡开始"蒙太奇（Anim_Stagger_Start_Montage）
2. Stagger Idle（动画蓝图 Endurance_Stagger，通过标签切换）
3. 超时 → 触发 GA_Fall（QTE 恢复待后期实现）

### GA_Fall 动画流程 ✅
1. 播放"摔倒"蒙太奇（Anim_Fall_Down_Montage）
2. Delay 5秒（Fallen Idle 通过动画蓝图 Endurance_Fall 状态播放）
3. 播放"起身"蒙太奇（Anim_Fall_GetUp_Montage）→ End Ability

### GA_Dodge 动画流程 ✅
1. 播放闪避蒙太奇（Anim_Dodge_Montage）
2. 无敌帧由 AN_GSC_SendGameplayEventByTag 控制
   - InvincibleStart → 应用 GE_Invincible
   - InvincibleEnd → 移除 GE_Invincible

### 动作互斥
**道具系统完成后统一设计** Blocked Tags / Cancel Tags

