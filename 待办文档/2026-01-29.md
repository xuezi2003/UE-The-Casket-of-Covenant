# 2026-01-29 待办（已归档）

> [!NOTE]
> 本日完成了 Phase 0（测试环境搭建）、Phase 0.5（抽离基类架构）和 Phase 1 架构文档更新（任务1、3、7）。Phase 1 的蓝图实现任务（任务2、4、5、6、8、9、10、11）已迁移至 [2026-01-30.md](2026-01-30.md)。

---

## 📋 当日目标

关卡5（牺牲之匣）Phase 0 - 测试环境搭建 + 架构文档目录

---

## ✅ 已完成

### Phase 0：测试环境搭建

**已完成内容**：
- ✅ 创建 GM_Sacrifice 和 GS_Sacrifice（配置 Class Defaults、变量、GetSpawnPos）
- ✅ 创建 L_Dev_Sacrifice 测试地图（配置 World Settings）
- ✅ 放置场景组件（BP_BornVol、BP_StartLine、BP_FinishLine）
- ✅ 创建架构文档目录（5个空文档）
- ✅ 测试验证通过（玩家出生、SM 运行、AI 填充正常）

**完成标准达成**：
- ✅ 可运行的测试环境（地图正常启动、玩家出生、状态机运行）
- ✅ 架构框架就位（GM/GS 配置正确、GetSpawnPos 实现）
- ✅ 文档基础建立（架构文档目录和空文档就位）

---

## 🏗️ Phase 0.5：抽离基类架构（✅ 已完成）

### 目标

抽离 Comp_Character_Core 和 Comp_PC_Core 基类，避免关卡间重复实现共性逻辑，提升架构清晰度和维护性。

---

### 任务清单

#### 1. 审核基类文档（✅ 已完成）

- [x] 审核 Comp_Character_Core.md 和 Comp_PC_Core.md
- [x] 确认基类设计合理，共性逻辑抽离正确
- [x] 确认子类实现指南清晰

**关键成果**：基类文档经过三轮检查，命名统一（InitComp、GE_Start），共性逻辑抽离正确

---

#### 2. 创建基类蓝图（✅ 已完成）

- [x] 创建 Comp_Character_Core（继承 ActorComponent，Component Replicates = True）
  - [x] 实现变量：BP_Character, ASC, GSCCore
  - [x] 实现函数：BeginPlay, InitComp, HandlePlayerStart, HandlePlayerFinish, GiveAbilitySet, ClearAbilitySet
- [x] 创建 Comp_PC_Core（继承 ActorComponent，Component Replicates = False）
  - [x] 实现变量：PC_Core
  - [x] 实现函数：BeginPlay（缓存 PC_Core 引用）

**关键成果**：基类蓝图完全实现，网络配置正确（Character 复制，PC 不复制）

---

#### 3. 重构关卡1的 Comp_Character_Endurance（✅ 已完成）

- [x] 修改父类为 Comp_Character_Core
- [x] 删除基类函数（BeginPlay、HandlePlayerStart、HandlePlayerFinish、GiveAbilitySet、ClearAbilitySet）
- [x] 删除基类变量（BP_Character、ASC、GSCCore）
- [x] 重写 InitComp（Override 父类，添加子类绑定逻辑）
- [x] 保留关卡1专属逻辑（HandleAttributeChanged、HandleTagChanged、道具系统、死亡处理等）
- [x] 更新文档 Comp_Character_Endurance.md

**关键要点**：
- 变量重命名为 BP_Character_Core、ASC_Core、GSCCore_Core（UE 自动添加后缀）
- 子类必须在 InitComp 中检查 `Is Valid (GSCCore_Core)`（父类的 Is Valid 不影响子类执行）

---

#### 4. 重构关卡1的 Comp_PC_Endurance（✅ 已完成）

- [x] 修改父类为 Comp_PC_Core
- [x] 保留 BeginPlay（Override，调用 Parent: ReceiveBeginPlay）
- [x] 删除 PC_Core 变量（从基类继承）
- [x] 保留 QTE 系统完整（所有函数、RPC、变量、输入绑定）
- [x] 更新文档 Comp_PC_Endurance.md

**关键要点**：
- 必须保留 BeginPlay 并调用父类（确保 PC_Core 引用正确缓存）
- QTE 逻辑保留在子类（只有关卡1和5需要，不应在基类中）

---

#### 5. 文档一致性检查（✅ 已完成）

- [x] 第一轮：核心文档检查（继承关系、变量名、函数名）
- [x] 第二轮：相关文档搜索（搜索 Comp_Character_Core 和 Comp_PC_Core 引用）
- [x] 第三轮：细节验证（实现状态、跨文档引用、技术细节）

**检查结果**：所有检查项通过，文档一致性完美

---

#### 6. 更新架构文档（✅ 已完成）

- [x] 更新 Comp_Character_Endurance.md（标注继承关系、删除基类逻辑说明）
- [x] 更新 Comp_PC_Endurance.md（标注继承关系、保留 QTE 逻辑说明）
- [x] 更新 Comp_Character_Sacrifice.md（标注继承关系）
- [x] 更新 Comp_PC_Sacrifice.md（标注继承关系、添加 QTE 参考）
- [x] 更新系统架构.md（添加 Comp_Character_Core 和 Comp_PC_Core 说明）

---

### 完成标准

**架构层面**：
- ✅ Comp_Character_Core 和 Comp_PC_Core 基类创建完成（文档 + 蓝图）
- ✅ 关卡1组件重构完成（继承基类，删除重复逻辑）
- ✅ 系统架构.md 已更新（添加基类说明）

---

## 🚀 Phase 1：核心类架构（架构文档部分）

### 已完成任务

#### 1. 更新 Comp_Character_Sacrifice.md 架构文档（✅ 已完成）

- [x] 修改父类标注为 Comp_Character_Core
- [x] 删除基类变量和函数说明
- [x] 添加"继承自基类"说明和引用
- [x] 保留 Phase 3+ 的关卡专属逻辑说明

---

#### 2. 更新 Comp_PC_Sacrifice.md 架构文档（✅ 已完成）

- [x] 修改父类标注为 Comp_PC_Core
- [x] 删除基类变量和函数说明
- [x] 添加"继承自基类"说明和引用
- [x] 添加 QTE 系统说明（参考 Comp_PC_Endurance）
- [x] 添加输入绑定说明
- [x] 保留 Phase 6+ 的关卡专属逻辑说明

---

#### 3. 更新 SM_Sacrifice.md 架构文档（✅ 已完成）

- [x] 填充状态机结构（Mermaid 图）
- [x] 填充变量定义
- [x] 填充状态详细配置（FirstHalf、SecondHalf、LevelComplete）
- [x] 填充网络配置说明
- [x] 填充组件挂载说明
- [x] 填充事件监听说明

**关键设计**：
- 变量命名：`CanObserve`（参考关卡1的 `IsRedLight` 模式）
- 事件分发器：`OnCanObserveChanged`
- 函数：`OnCanObserveChange`（手动触发）、`OnRep_CanObserve`（RepNotify 回调）
- 触发机制：居中玻璃对触发器直接调用 GS_Sacrifice 函数，不使用 GameplayTag 事件

---

## 📊 当日总结

**完成内容**：
- ✅ Phase 0：测试环境搭建（完全完成）
- ✅ Phase 0.5：抽离基类架构（完全完成）
- ✅ Phase 1：架构文档更新（Comp_Character_Sacrifice.md、Comp_PC_Sacrifice.md、SM_Sacrifice.md）

**下一步**：
- Phase 1 蓝图实现（需要在 UE 编辑器中操作）

---

## 📅 Phase 路线图

| Phase | 状态 | 内容 |
|-------|:----:|------|
| Phase 0 | ✅ | 测试环境搭建 + 架构文档目录 |
| Phase 0.5 | ✅ | 抽离基类架构 |
| Phase 1 | 🔄 | 核心类架构（架构文档 ✅ / 蓝图实现 ⚠️） |
| Phase 2 | ❌ | 玻璃桥生成系统 + 布局同步 |
| Phase 3+ | ❌ | 玻璃承重逻辑、观察系统、推搡系统等 |

---

## 参考文档

- [Comp_Character_Core.md](../关卡设计/00-通用逻辑/核心类/Comp_Character_Core.md)
- [Comp_PC_Core.md](../关卡设计/00-通用逻辑/核心类/Comp_PC_Core.md)
- [Comp_Character_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/Comp_Character_Sacrifice.md)
- [Comp_PC_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/Comp_PC_Sacrifice.md)
- [SM_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/SM_Sacrifice.md)
- [GS_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/GS_Sacrifice.md)
- [总体策划.md](../关卡设计/05-牺牲之匣/总体策划.md)
