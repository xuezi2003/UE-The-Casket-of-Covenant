# 2026-01-02 待办

> [!IMPORTANT]
> **后期所有技能完成后，统一调整技能互斥关系**（Ability Blocked Tags / Cancel Tags）

## 当前阶段：关卡1 耐力之匣 - Phase 1 基础移动

### 今日完成
- [x] 🐛 调查：SpeedRate 属性在 Autonomous Proxy 上移除 GE 时不触发委托
  - [x] 排查 OnRep 触发情况（使用 UE_LOG 确认）
  - [x] 确认根本原因：Infinite GE Modifier 影响 CurrentValue 而非 BaseValue，移除时 OnRep 不触发
  - [x] 实现修复：采用蓝图 **双重保险方案**（BAS_Core PostAttributeChange + BP_Character OnAttributeChange）
  - [x] 更新文档：`BP_Character_Game.md`、`输入与属性.md`
  - [x] 恢复蓝图中的属性监听逻辑（辅助 PostAttributeChange）

### 待办
- [ ] 跳跃体力消耗
  - [ ] GE_StaminaCost_Jump（按次消耗）
  - [ ] GA_Jump 集成体力消耗


---

## 开发计划

### Phase 0：测试环境搭建（✅ 完成）

### Phase 1：基础移动 + 玩家交互

**开发顺序**：Ability → 玩家输入 → AI BTTask

- [ ] 基础移动系统
  - [x] 奔跑体力消耗（GE_StaminaDrain_Sprint）
  - [x] 体力自动回复（GE_StaminaRegen）
  - [x] 力竭机制（GE_Exhausted + GA_Exhausted）
  - [x] 蹲行系统（GA_Crouch + GE_Crouch）
  - [x] 速度属性同步修复（PostAttributeChange）
  - [ ] 跳跃体力消耗（GE_StaminaCost_Jump）
- [ ] 推搡系统
  - [ ] GA_Push（推搡 Ability）
  - [ ] 玩家输入绑定
  - [ ] BTTask_Push（AI 触发）
- [ ] 闪避系统
  - [ ] GA_Dodge（闪避 Ability）
  - [ ] 玩家输入绑定
  - [ ] BTTask_Dodge（AI 触发）
- [ ] 失衡/摔倒状态
  - [ ] GA_Stagger（失衡状态）
  - [ ] GA_Fall（摔倒状态）
  - [ ] 玩家 QTE 恢复
  - [ ] AI 概率判定
- [ ] DetectionBox 组件（检测前方可交互对象）

### Phase 2：道具系统
- [ ] 投掷类（MOTS 插件）：香蕉皮、炸弹
- [ ] Buff 类（GE）：跑鞋、护盾、磁铁
- [ ] 资源类：金币

### Phase 3：完善
- [ ] 死亡判定（HP 归零 → 淘汰）
- [ ] 死亡广播（周围玩家失衡）
- [ ] AI 完善（体力管理、遮挡策略）

---

## 架构备忘

**职责分离**：
- Comp_Endurance：检测逻辑（移动检测、Danger 标签）
- AbilitySet_Endurance：GAS 操作（推搡、闪避、投掷、失衡、摔倒、麻痹）
- GE 系列：状态效果
- IMC_Endurance：关卡1/5 专属输入
- BT_Endurance：AI 行为

**AI 设计原则**：
- 操作层统一，触发层分离
- 玩家和 AI 共用同一套 GAS Ability
- 失衡 QTE：玩家走 UI，AI 按概率判定

---

## 今日调试历程记录

### 问题
- **现象**：Client 1（Autonomous Proxy）在松开 Shift 停止冲刺时，速度没有从 525 恢复到 350
- **验证**：用 Tick 打印 SpeedRate 确认值已经是 1.0，但 MaxWalkSpeed 没更新

### 根本原因
1. `GE_Sprint` 使用 **Infinite Duration + Modifier（乘法 ×1.5）**
2. Modifier 只影响 **CurrentValue**，不改变 **BaseValue**
3. `OnRep` 只在 **BaseValue 复制时触发**
4. 由于 **GE 移除不可预测**，Autonomous Proxy 的属性变化委托不触发
5. Simulated Proxy 不预测，所以复制正常工作

### 尝试的方案
1. ❌ GSCCore OnAttributeChange - 不触发
2. ❌ Wait for Attribute Changed Async Task - 值不准确、多次触发
3. ❌ OnRep_SpeedRate 打印 - Client 1 移除时没有调用
4. ✅ PostAttributeChange - 被调用，但传入的值不准确；改为直接读取 CurrentValue 解决

### 最终方案
采用蓝图 **双重保险方案**：
1. **BAS_Core (AttributeSet 蓝图)**：监听 `PostAttributeChange`，作为服务器端和模拟端的兜底保障。
2. **BP_Character_Game**: 监听 `OnAttributeChange`，处理本地预测的即时反馈。

这种组合确保了无论预测是否命中，属性更新都能最终传达到 CharacterMovement。
