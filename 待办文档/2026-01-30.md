# 2026-01-30 待办

> [!NOTE]
> 本日任务来自 [2026-01-29.md](2026-01-29.md) Phase 1 的未完成部分（任务2、4、5、6、8、9、10、11）。

---

## 📋 当日目标

关卡5（牺牲之匣）Phase 1 - 核心类架构（蓝图实现）

---

## 🚀 Phase 1：核心类架构（蓝图实现）

### 目标

创建关卡5的核心类蓝图，配置 GM_Sacrifice 的关卡专属变量，实现玩家基础移动和交互能力。

---

### ⚠️ 执行顺序说明

**推荐执行顺序**：任务1 → 任务2 → 任务5 → 任务6 → 任务4 → 任务8 → 任务9 → 任务10 → 任务11

**Phase 1 范围调整**：
- Phase 1 只创建基础架构（空的组件、空的 AbilitySet、空的 IMC）
- 不包含 GAS 能力创建（Phase 5）
- 不包含 QTE 系统实现（Phase 5）
- 不包含关卡专属输入映射（Phase 5）

**依赖关系**：
- 任务1、2、5、6、4、8：无依赖，可以按顺序执行
- 任务9：依赖任务2、4、5、6、8（集成所有组件）
- 任务10：依赖任务9（测试集成结果）
- 任务11：依赖任务10（更新文档）

---

### 任务清单

#### 1. 实现 GS_Sacrifice 观察系统（✅ 已完成）

- [x] 添加变量 CanObserve（布尔，RepNotify，默认 true）
- [x] 添加事件分发器 OnCanObserveChanged（参数：CanObserve: Bool）
- [x] 实现 OnRep_CanObserve 函数（RepNotify 回调）

**说明**：为 SM_Sacrifice 状态机提供观察状态控制接口。Blueprint 中 RepNotify 函数会在服务端和客户端都自动调用，无需手动触发函数。

---

#### 2. 创建 Comp_Character_Sacrifice 蓝图类（✅ 已完成）

- [x] 创建蓝图类（继承 Comp_Character_Core）
- [x] 自动继承父类的 Component Replicates 配置

**说明**：Phase 1 只需创建空的子类蓝图，Phase 3+ 再添加关卡专属逻辑

---

#### 4. 创建 Comp_PC_Sacrifice 蓝图类（✅ 已完成）

> [!NOTE]
> **Phase 1 范围**：只创建空的子类蓝图，Phase 5 再实现 QTE 系统（配合 GAS 能力创建）。
> 
> **重要说明**：QTE 系统需要配置输入绑定 IA_Sacrifice_QTE_Stagger，但这个 Input Action 在 Phase 5 才会创建（与 GAS 能力一起）。因此 Phase 1 只创建空的蓝图类，不实现 QTE 逻辑。

- [x] 创建蓝图类（继承 Comp_PC_Core）
- [x] 自动继承父类的 Component Replicates 配置（不复制）

**说明**：Phase 1 只创建架构，QTE 系统将在 Phase 5 实现（参考 Comp_PC_Endurance）

---

#### 5. 创建 AbilitySet_Sacrifice（✅ 已完成）

> [!NOTE]
> **重要说明**：关卡5需要创建自己的 GAS 能力，不能直接复用关卡1的能力。关卡1的 GAS 能力只是提供"参考"，因为关卡5的失衡后果、推搡限制等机制与关卡1不同。

- [x] 创建数据资产：AbilitySet_Sacrifice（GSCAbilitySet）
- [x] 暂时不配置 Granted Abilities（Phase 5 再创建关卡5专属的 GAS 能力）

**说明**：Phase 1 只创建空的 AbilitySet，Phase 5 创建关卡5专属的 GAS 能力（GA_Sacrifice_Push、GA_Sacrifice_Stagger、GA_Sacrifice_Dodge、GA_Sacrifice_Jump），Phase 6 添加金币测试能力

---

#### 6. 创建 IMC_Sacrifice（✅ 已完成）

> [!NOTE]
> **Phase 1 范围**：创建 IMC_Sacrifice，复制 IMC_Core 的基础输入（Move、Look、Jump），不包含 Sprint（关卡5无奔跑机制）。

- [x] 创建输入映射：IMC_Sacrifice（Input Mapping Context）
- [x] 复制 IMC_Core 的3个基础输入映射：
  - [x] IA_Core_Move → WASD
  - [x] IA_Core_Look → 鼠标
  - [x] IA_Core_Jump → 空格
- [x] 不包含 IA_Core_Sprint（关卡5无奔跑）
- [x] 暂时不添加关卡专属输入

**说明**：Phase 1 只创建基础架构，Phase 5 再添加 IA_Sacrifice_Push、IA_Sacrifice_Dodge、IA_Sacrifice_QTE_Stagger 等输入

---

#### 8. 创建 SM_Sacrifice（✅ 已完成）

- [x] 创建状态机：SM_Sacrifice（Logic Driver State Machine）
- [x] 配置 Event OnStateMachineStart（获取 Context）
- [x] 创建状态：
  - [x] FirstHalf（前半段，视觉差异可见）
    - [x] On State Begin：使用通知设置 `Context.CanObserve = true` + 打印日志
  - [x] SecondHalf（后半段，视觉差异消失）
    - [x] On State Begin：使用通知设置 `Context.CanObserve = false` + 打印日志
  - [x] LevelComplete（结束状态，Can be End State = true）
    - [x] On State Begin：打印日志
- [x] 配置转换：
  - [x] FirstHalf → LevelComplete：事件绑定 (`OnLevelShouldEnd`)
  - [x] SecondHalf → LevelComplete：事件绑定 (`OnLevelShouldEnd`)
- [x] 网络配置：由 GS_Core.LevelSubSM 组件提供（无需额外配置）

**说明**：Phase 1 只实现基础状态切换和日志输出，FirstHalf → SecondHalf 转换将在 Phase 3.6 实现（由玻璃对触发器调用 GS_Sacrifice 函数）

---

#### 9. 配置 GM_Sacrifice 变量（✅ 已完成）

- [x] 打开 GM_Sacrifice 蓝图
- [x] 配置 Class Defaults：
  - [x] Level Ability Set = AbilitySet_Sacrifice
  - [x] Level Character Component Class = Comp_Character_Sacrifice
  - [x] Level PC Component Class = Comp_PC_Sacrifice
  - [x] Level IMC = IMC_Sacrifice
  - [x] Level Sub SM = SM_Sacrifice
  - [x] Level Behavior Tree = None（Phase 8 才配置）

---

#### 10. 测试验证（✅ 已完成）

> [!NOTE]
> **Phase 1 测试范围**：由于 Phase 1 不包含 GAS 能力创建，本阶段只验证架构完整性和基础流程，不验证推搡、闪避等 GAS 能力。

- [x] 运行 L_Dev_Sacrifice 地图
- [x] 验证玩家基础移动（移动、跳跃）
- [x] 验证 BP_StartLine 触发（碰撞切换、标签添加）
- [x] 验证 BP_FinishLine 触发（标签添加、碰撞切换）
- [x] 验证子状态机正常运行（FirstHalf 状态启动，日志输出）

**测试结果**：
- ✅ 移动、视角旋转正常
- ✅ 跳跃正常（使用 IA_Core_Jump）
- ✅ BP_StartLine 和 BP_FinishLine 触发正常
- ✅ 标签添加正常
- ✅ 子状态机日志输出：`[SM_Sacrifice] 前半段（可观察）`
- ✅ 关卡结束判定正常

**说明**：推搡、闪避、失衡等 GAS 能力将在 Phase 5 创建和测试

---

#### 11. 更新架构文档实现状态（✅ 已完成）

- [x] 更新 Comp_Character_Sacrifice.md（标记 Phase 1 已完成）
- [x] 更新 Comp_PC_Sacrifice.md（标记 Phase 1 已完成）
- [x] 更新 SM_Sacrifice.md（标记 Phase 1 已完成）
- [x] 更新 GM_Sacrifice.md（标记变量配置已完成）
- [x] 更新总体策划.md（标记 Phase 1 状态为 ✅）
- [x] 更新待办文档（标记 Phase 1 完成）

---

## 完成标准

**功能层面**：
- ✅ 玩家基础移动正常（移动、跳跃）
- ✅ BP_StartLine 和 BP_FinishLine 触发正确
- ✅ 子状态机正常运行

**架构层面**：
- ✅ GM_Sacrifice 的关卡专属变量配置完整
- ✅ 组件架构、输入映射、子状态机配置完整
- ✅ AbilitySet_Sacrifice 已创建（暂时为空，Phase 5 再配置）
- ✅ 架构文档更新完整，总体策划.md 和待办文档已更新

**Phase 5 待完成**：
- ⚠️ 创建关卡5专属的 GAS 能力（GA_Sacrifice_Push、GA_Sacrifice_Stagger、GA_Sacrifice_Dodge、GA_Sacrifice_Jump）
- ⚠️ 配置 AbilitySet_Sacrifice
- ⚠️ 测试推搡、闪避、失衡等 GAS 能力

---

## 参考文档

- [Comp_Character_Core.md](../关卡设计/00-通用逻辑/核心类/Comp_Character_Core.md) - Character 组件基类
- [Comp_PC_Core.md](../关卡设计/00-通用逻辑/核心类/Comp_PC_Core.md) - PC 组件基类
- [Comp_Character_Endurance.md](../关卡设计/01-耐力之匣/架构/Comp_Character_Endurance.md) - Character 组件参考
- [Comp_PC_Endurance.md](../关卡设计/01-耐力之匣/架构/Comp_PC_Endurance.md) - PC 组件参考（QTE 系统）
- [SM_Endurance.md](../关卡设计/01-耐力之匣/架构/SM_Endurance.md) - 子状态机参考
- [输入映射.md](../关卡设计/01-耐力之匣/输入映射.md) - 输入映射参考
- [输入系统.md](../关卡设计/00-通用逻辑/输入系统.md) - IMC_Core 通用输入
- [推搡系统.md](../关卡设计/01-耐力之匣/GAS/推搡系统.md) - GAS 能力参考
- [跳跃系统.md](../关卡设计/01-耐力之匣/GAS/跳跃系统.md) - GAS 能力参考
- [总体策划.md](../关卡设计/05-牺牲之匣/总体策划.md) - 关卡5总体策划
- [GM_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/GM_Sacrifice.md) - GM_Sacrifice 架构
- [GS_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/GS_Sacrifice.md) - GS_Sacrifice 架构
- [Comp_Character_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/Comp_Character_Sacrifice.md) - Comp_Character_Sacrifice 架构
- [Comp_PC_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/Comp_PC_Sacrifice.md) - Comp_PC_Sacrifice 架构
- [SM_Sacrifice.md](../关卡设计/05-牺牲之匣/架构/SM_Sacrifice.md) - SM_Sacrifice 架构

---

## 💡 开发提示

### QTE 系统实现参考

完全参考 Comp_PC_Endurance 的 QTE 系统实现，可以直接复制粘贴以下内容：
- 变量：WBP_QTE_Stagger（Widget 引用）
- 函数：StartQTE、EndQTE、CloseQTEWidget
- RPC：Client_StartQTE、Client_CloseQTEWidget、Server_QTESuccess
- 输入绑定：IA_Sacrifice_QTE_Stagger → WBP_QTE_Stagger.OnQTEInput()

### 状态机实现参考

参考 SM_Endurance 的实现模式：
- 使用"使用通知设置"节点设置 RepNotify 变量
- Blueprint 中 RepNotify 函数会在服务端和客户端都自动调用
- 所有逻辑仅在 Server 运行，通过 RepNotify 变量同步给客户端

### 输入映射配置

关卡5不需要的输入：
- IA_Core_Crouch（无蹲行）
- IA_Endurance_Aim / IA_Endurance_Throw（Phase 6 才实现金币测试）

关卡5需要的输入：
- IA_Sacrifice_Push（推搡）
- IA_Sacrifice_Dodge（闪避）
- IA_Sacrifice_QTE_Stagger（QTE 输入）
- 复用 IMC_Core 的通用输入（Move、Look、Jump）
