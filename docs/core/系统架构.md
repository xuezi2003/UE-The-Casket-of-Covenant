# 系统架构 - 核心类配置

> FiveBox 项目核心类继承与配置规范

---

## 〇、技术选型

### 插件依赖

| 插件 | 用途 | 备注 |
|:-----|:-----|:-----|
| **GAS Companion** | 能力系统框架 | 提供模块化 PS/PC/Character 基类 |
| **Blueprint Attributes** | GAS 属性蓝图化 | 无需 C++ 定义 AttributeSet |
| **Logic Driver Pro** | 状态机 + 行为树 | 关卡流程状态机、交互物体、**AI 行为树** |
| **Advanced Sessions** | Session 管理 | 创建/搜索/加入房间 |
| **Null Online Subsystem** | 开发用联机 | 局域网测试，无需 Steam |

### 网络架构

| 项目 | 选型 |
|:-----|:-----|
| **Server 类型** | ⚠️ **Dedicated Server** (非 Listen Server) |
| **关卡切换** | ⚠️ **Seamless Travel**（保留 PS 跨关卡） |
| **开发阶段** | Null Subsystem + LAN |
| **发布阶段** | Steam Online Subsystem |

> **重要**: Dedicated Server 下客户端 PC 永远没有 Authority，判断房主需用 `Get Net Player Index`

---

## 一、核心类总览

| 类型 | 类名 | 父类 | 生命周期 | 职责 | 详细文档 |
|:-----|:-----|:-----|:---------|:-----|:---------|
| **GI** | `GI_FiveBox` | `AdvancedFriendsGameInstance` | 全局永久 | Session 管理 | [GI_FiveBox](class/GI_FiveBox.md) |
| **GM** | `GM_Core` | `GameModeBase` | 关卡级(仅服务器) | 关卡规则 | [GM_Core](class/GM_Core.md) |
| **GS** | `GS_Core` | `GameStateBase` | 关卡级 | 关卡状态同步 | [GS_Core](class/GS_Core.md) |
| **PS** | `PS_FiveBox` | `GSCModularPlayerState` | 跨关卡保留 | GAS 宿主 | [PS_FiveBox](class/PS_FiveBox.md) |
| **PC** | `PC_Core` | `GSCModularPlayerController` | 跨关卡保留 | 输入/UI | [PC_Core](class/PC_Core.md) |
| **Character** | `BP_Character_Game` | `GSCModularCharacter` | 关卡级 | 玩家/AI 角色 | [BP_Character_Game](class/BP_Character_Game.md) |
| **AIC** | `AIC_Game` | `AAIController` | 关卡级 | AI 控制 | [AIC_Game](class/AIC_Game.md) |

---

## 二、各关卡配置

| 关卡 | GM | GS | PS | PC | 主要 UI |
|:-----|:---|:---|:---|:---|:--------|
| **L_MainMenu** | 默认 | 默认 | 默认 | 默认 | `WBP_MainMenu` |
| **L_Lobby** | `GM_Lobby` | `GS_Core` | `PS_FiveBox` | `PC_Lobby` | `WBP_Lobby` |
| **L_Endurance** | `GM_Endurance` | `GS_Endurance` | `PS_FiveBox` | `PC_Game` | `WBP_GameHUD` |
| **L_Logic** | `GM_Logic` | `GS_Logic` | `PS_FiveBox` | `PC_Game` | `WBP_GameHUD` |
| **L_Courage** | `GM_Courage` | `GS_Courage` | `PS_FiveBox` | `PC_Game` | `WBP_GameHUD` |
| **L_Insight** | `GM_Insight` | `GS_Insight` | `PS_FiveBox` | `PC_Game` | `WBP_GameHUD` |
| **L_Sacrifice** | `GM_Sacrifice` | `GS_Sacrifice` | `PS_FiveBox` | `PC_Game` | `WBP_GameHUD` |

---

## 三、继承结构

### GameMode
```
GameModeBase
└── GM_Core (基类：通用配置)
    ├── GM_Lobby      (大厅：编号分配、解散逻辑)
    ├── GM_Endurance  (耐力：红绿灯、淘汰判定)
    ├── GM_Logic      (逻辑：谜题验证)
    ├── GM_Courage    (勇气：...)
    ├── GM_Insight    (洞察：...)
    └── GM_Sacrifice  (牺牲：...)
```

### GameState
```
GameStateBase
└── GS_Core (基类：通用状态)
    ├── GS_Endurance  (当前灯状态)
    ├── GS_Logic      (题目、密码进度、房间状态)
    ├── GS_Courage    (车厢毒气状态、投票)
    ├── GS_Insight    (分组、连胜计数、站队统计)
    └── GS_Sacrifice  (待定)
```

### PlayerController
```
GSCModularPlayerController
└── PC_Core (基类)
    ├── PC_Lobby  (大厅专用：无 Pawn)
    └── PC_Game   (游戏关卡通用)
```

---

## 四、GM_Core / GS_Core 基类设计

### GM 功能对比表

| 功能 | Lobby | Endurance | Logic | Courage | Insight | 通用？ |
|:-----|:-----:|:---------:|:-----:|:-------:|:-------:|:------:|
| 开始条件：所有玩家加载完成 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| AI 填充空位 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 淘汰玩家（踢出→主菜单） | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| 检测真人全死→结束整局 | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| 掉线→AI接管 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 每关开始恢复满HP | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| 死亡掉落金币 | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| ServerTravel到下一关 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 关卡时限倒计时 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 即死惩罚（违规） | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| 红绿灯切换/移动检测 | - | ✅ | - | - | - | ❌ |
| 题目验证/房间判定 | - | - | ✅ | - | - | ❌ |
| 毒气判定/面具检查 | - | - | - | ✅ | - | ❌ |
| 异常生成/站队判定/分组 | - | - | - | - | ✅ | ❌ |

### GS 同步数据对比表

| 数据 | Lobby | Endurance | Logic | Courage | Insight | 通用？ |
|:-----|:-----:|:---------:|:-----:|:-------:|:-------:|:------:|
| **RemainingTime**（剩余时间） | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **CurrentPhase**（当前阶段） | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **PlayerRecords**（玩家记录） | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 灯状态（红/绿） | - | ✅ | - | - | - | ❌ |
| 当前题目/密码进度 | - | - | ✅ | - | - | ❌ |
| 房间状态（安全/危险） | - | - | ✅ | - | - | ❌ |
| 车厢毒气状态/投票 | - | - | - | ✅ | - | ❌ |
| 玩家分组/连胜计数 | - | - | - | - | ✅ | ❌ |

### GM_Core 基类

**配置项（子类覆盖）**

| 属性 | 类型 | 说明 |
|:-----|:-----|:-----|
| `LevelInputComponentClass` | Class | 关卡专属输入组件类 |
| `LevelHUDWidgetClass` | Class | 关卡专属 HUD Widget 类 |
| `LevelTimeLimit` | Float | 关卡时限（秒） |
| `NextLevelName` | Name | 下一关卡名 |

**通用函数**

| 函数 | 说明 |
|:-----|:-----|
| `HandleMatchHasStarted` | 关卡开始时调用 |
| `HandleLevelComplete` | 关卡完成时调用（子类覆盖） |
| `EliminatePlayer(PS)` | 淘汰玩家（踢出 + 标记） |
| `InstantKillPlayer(PS)` | 即死（违规） |
| `OnPlayerDisconnected(PS)` | 掉线 → AI 接管 |
| `SpawnAIToFillSlots` | AI 填充空位 |
| `AreAllHumansEliminated` | 检测真人是否全死 |
| `GetAlivePlayerCount` | 获取存活玩家数 |
| `TravelToNextLevel` | ServerTravel 到下一关 |
| `EndGameSession` | 结束整局（真人全死时） |
| `RestoreAllPlayersHP` | 恢复所有玩家 HP |
| `DropPlayerCoins(PS)` | 玩家死亡掉落金币 |

### GS_Core 基类

**同步数据（Replicated）**

| 属性 | 类型 | 说明 |
|:-----|:-----|:-----|
| `RemainingTime` | Float | 剩余时间 |
| `CurrentPhase` | Enum | 当前阶段（Preparing / InProgress / Settlement） |
| `PlayerRecords` | Array | 玩家记录数组 |

**通用函数**

| 函数 | 说明 |
|:-----|:-----|
| `GetAlivePlayerCount` | 获取存活玩家数 |
| `GetAliveHumanCount` | 获取存活真人数 |
| `MarkPlayerEliminated(PlayerNum)` | 标记玩家淘汰 |
| `GetPlayerRecord(PlayerNum)` | 获取玩家记录 |
| `Multicast_OnPhaseChanged(Phase)` | 广播阶段切换 |

### FPlayerRecord 结构

| 字段 | 类型 | 说明 |
|:-----|:-----|:-----|
| `PlayerNum` | Int | 编号（全程不变） |
| `AvatarData` | Struct | 头像数据 |
| `bIsHuman` | Bool | 真人 / AI |
| `bIsEliminated` | Bool | 已淘汰 |
| `bIsConnected` | Bool | 在线状态 |

### 子类只需实现关卡特有逻辑

| 子类 | GM 特有 | GS 特有 |
|:-----|:--------|:--------|
| **Endurance** | 红绿灯切换、移动检测→击杀 | `ELightState` 灯状态 |
| **Logic** | 题目验证、房间安全判定、密码管理 | 当前题目、密码进度、房间状态 |
| **Courage** | 毒气判定、面具检查、车厢推进 | 车厢毒气状态、投票结果 |
| **Insight** | 异常生成、站队判定、分组管理 | 玩家分组、连胜计数、站队统计 |

---

## 五、跨关卡数据保留

| 对象 | Seamless Travel 后 | 存储内容 |
|:-----|:--------------------|:---------|
| **GameInstance** | ✅ 保留 | Session 信息 |
| **PlayerState** | ✅ 保留 | GAS 属性、编号、头像 |
| **PlayerController** | ✅ 保留 | 输入状态 |
| **Character** | ❌ 销毁 | 不存储持久数据 |
| **GameMode/State** | ❌ 销毁 | 关卡特定数据 |

### 属性跨关卡处理

| 属性 | 处理方式 |
|:-----|:---------|
| `Health` | 每关 GM BeginPlay 重置为 MaxHealth |
| `Coins` | 保留，死亡时掉落清零 |

---

## 六、GAS 使用规范

### 什么该用 GAS

| 类型 | 示例 | 用 GAS | 原因 |
|:-----|:-----|:-------|:-----|
| 有消耗/冷却的技能 | 推搡、闪避、投掷 | ✅ | 需要耐力消耗、冷却、网络同步 |
| 状态效果 | 麻痹、失衡、护盾、加速 | ✅ | GameplayEffect 处理持续时间 |
| HP/金币变化 | 受伤、拾取 | ✅ | AttributeSet 自动同步 |
| 基础移动 | WASD、跳跃 | ❌ | CMC 已处理 |
| 简单交互 | 开门、检视物品 | ❌ | Interface 调用即可 |
| 纯 UI 操作 | 答题、站队 | ❌ | 直接 RPC |

### AttributeSet (使用 Blueprint Attributes)

```
BAS_Core (蓝图 AttributeSet)
├── Health / MaxHealth
├── Coins
└── 其他通用属性

关卡特定状态 → 使用 GameplayTags
例如：State.HasMask、State.Stunned、Item.Banana
```

---

## 七、Logic Driver Pro 使用规范

| 用途 | 使用 | 说明 |
|:-----|:----:|:-----|
| 玩家动作互斥 | ❌ | GAS Ability Tags 处理 |
| 玩家 Buff/Debuff | ❌ | GAS 处理 |
| 动画状态 | ❌ | AnimBP 处理 |
| **关卡流程控制** | ✅ | 阶段流转：准备→进行→结算 |
| **交互物体状态** | ✅ | 门、答题台、车厢等 |
| **AI 行为树** | ✅ | AI 决策逻辑 |
| **木偶/Boss 行为** | ✅ | 红绿灯切换、转头动画 |

---

## 八、待定事项

- [ ] 道具系统存储位置（PS 还是单独组件）
- [ ] L_Sacrifice 关卡具体设计

