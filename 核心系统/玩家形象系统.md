# 玩家形象系统

> 玩家角色外观的渲染与数据同步

---

## 一、角色外观

### 整体形象

- **身体**：绿色运动服人形
- **头部**：显示器屏幕
- **编号**：印在运动服上
- **头像**：显示在显示器屏幕上

---

## 二、材质系统

### 显示器材质 (M_Monitor) - ✅ 已完成

**三层架构**:

| 层级 | 名称 | 职责 |
|:-----|:-----|:-----|
| 底层 | `MF_AvatarComposite` | 四层贴图合成 (Cloth→Face→Eye→Hair) |
| 中间 | `MF_MonitorBaseColor` | UV 变换 (TRS) + BoxMask 裁剪 |
| 顶层 | `M_Monitor` | 参数化入口 (Texture Object + Scalar) |

**暴露参数**:

| 参数名 | 类型 | 说明 |
|:---------|:-----|:-----|
| `Tex_Cloth` | Texture Object | 衣服/配色层 |
| `Tex_Face` | Texture Object | 面部皮肤 |
| `Tex_Eye` | Texture Object | 表情/眼睛 |
| `Tex_Hair` | Texture Object | 头发样式 |
| `Scale` | Scalar | 缩放 |
| `Offset` | Vector2 | 平移 |
| `Rotation` | Scalar | 旋转角度 |

**关键技术**:
- 采样器源: **Shared: Clamp** (防止平铺)
- `BoxMask-2D` 节点: 裁剪 UV 范围外拉伸像素

### 身体材质 (M_Clothes / MI_Cloth) - ✅ 已完成

**三层架构** (与 M_Monitor 一致):

| 层级 | 名称 | 职责 |
|:-----|:-----|:-----|
| 底层 | `MF_NumberComposite` | 三层数字合成 (百位+十位+个位) |
| 中间 | `MF_ClothBaseColor` | UV 变换 + BoxMask 裁剪 |
| 顶层 | `M_Clothes` / `MI_Cloth` | 参数化入口 |

**暴露参数**:

| 参数名 | 类型 | 说明 |
|:---------|:-----|:-----|
| `Tex_100` | Texture Object | 百位数字 (T_Num_100_n) |
| `Tex_10` | Texture Object | 十位数字 (T_Num_10_n) |
| `Tex_1` | Texture Object | 个位数字 (T_Num_1_n) |

**材质槽位**: `clothes1` (元素 5)

---

## 三、数据存储

### FAvatarData 结构体

| 字段 | 类型 | 说明 |
|:-----|:-----|:-----|
| `HairIndex` | Int | 头发编号 |
| `EyeIndex` | Int | 眼睛编号 |
| `FaceIndex` | Int | 面部编号 |
| `ColorIndex` | Int | 配色编号 |

### 存储位置

| 数据 | 位置 | 生命周期 | 同步 |
|:-----|:-----|:---------|:-----|
| `PlayerNum` | PlayerState | 跨关卡保留 | Replicated |
| `AvatarData` | PlayerState | 跨关卡保留 | Replicated |

---

## 四、渲染流程（已实现 - 事件驱动架构）

### 触发机制：Event Dispatcher (PS → Character)

**设计思路**：使用事件分发器解耦 PlayerState 和 Character，Character 通过订阅 PS 的事件来响应数据变化。

---

#### 1️⃣ PlayerState 层 (PS_FiveBox)

**事件分发器定义**:
- `OnPlayerNumChange` (Event Dispatcher) - 参数: `NewNum` (Int)
- `OnPlayerAvatarChange` (Event Dispatcher) - 参数: `NewAvatar` (F_AvatarData)

**OnRep 触发** (蓝图中服务器端也会触发):
```
OnRep_PlayerNum:
  → Call OnPlayerNumChange (PlayerNum)

OnRep_AvatarData:
  → Call OnPlayerAvatarChange (AvatarData)
```

---

#### 2️⃣ Character 层 (BP_Character_Game)

**BeginPlay 初始化**:
```
1. Set Timer by Function Name:
   - Function: "WaitForPlayerState"
   - Time: Get World Delta Seconds
   - Looping: True

2. WaitForPlayerState (Custom Event):
   - Get Player State → Cast to PS_FiveBox
   - If Valid:
     a. Clear Timer ("WaitForPlayerState")
     b. InitPS (Custom Event, 传入 PS)
```

**InitPS 逻辑** (关键！):
```
InitPS (PS):
  1. Bind Event to OnPlayerAvatarChange → HandleAvatarChange
  2. Bind Event to OnPlayerNumChange → HandleNumChange
  
  3. 手动初始化（防止错过已有数据）:
     - Call HandleNumChange(PS.PlayerNum)
     - Call HandleAvatarChange(PS.AvatarData)
```

**事件处理**:
```
HandleAvatarChange (NewAvatar):
  → InitPlayerAvatar(NewAvatar)

HandleNumChange (NewNum):
  → InitPlayerNum(NewNum)
```

> [!IMPORTANT]
> **为什么需要手动初始化？**
> 因为 Character 绑定 Event Dispatcher 时，PS 的 PlayerNum/AvatarData 可能已经被 GM 设置过了。
> 如果只依赖 Event Dispatcher，会错过初始值，导致外观不显示。

---

#### 3️⃣ GameMode 层 (GM_Core)

**头像分配** (HandleStartingNewPlayer):
```
Cast to PS_FiveBox:
  → Get Game State → Cast to GS_Core
  → PlayerRecords.Length + 1 → SET PS.PlayerNum  // 从 1 开始
  → RandomAvatar (BPL_Common) → SET PS.AvatarData
```

**BPL_Common.RandomAvatar**:
- 随机生成 `F_AvatarData` 结构体
- **注意**: 各部位 Index 从 1 开始（Cloth/Face/Eye/Hair）
- 返回值赋给 PS

---

### 优势分析

| 设计优势 | 说明 |
|:---------|:-----|
| **解耦合** | PS 和 Character 完全解耦，PS 不需要知道 Character 的存在 |
| **灵活性** | 可以轻松添加其他订阅者（如 UI Widget）监听同样的事件 |
| **时序安全** | Timer 循环确保 PS 有效后才绑定事件 |
| **初始化完善** | 手动调用确保不错过已有数据 |
| **可扩展** | 独立的事件处理函数便于后续添加逻辑（如音效、特效） |

### 入口函数: `InitPlayerVisual` (BP_Character_Game)

```
InitPlayerVisual(PlayerNum, PlayerAvatar)
    └→ InitPlayerNum(PlayerNum)      // 衣服编号
    └→ InitPlayerAvatar(PlayerAvatar) // 显示器头像
```

### InitPlayerNum 逻辑

**Step 1: 创建动态材质实例**
```
Mesh → Get Material by Name ("Cloth")
     → Create Dynamic Material Instance
     → SET TempClothMat (变量)
```

**Step 2-4: 加载三位数字贴图**

| 位置 | 计算公式 | DataTable Row | 参数名 |
|:-----|:---------|:--------------|:-------|
| 个位 | `PlayerNum % 10` | "1" | `Tex_1` |
| 十位 | `(PlayerNum % 100) / 10` | "10" | `Tex_10` |
| 百位 | `PlayerNum / 100` | "100" | `Tex_100` |

**加载流程**:
```
Get DataTable Row (DT_Tex_Num_Format, RowName)
    → Format Text (OutRowPath, {计算结果})
    → Make Soft Object Path
    → To Soft Object Reference
    → Load Asset Blocking
    → Cast To Texture2D
    → Set Texture Parameter Value (TempClothMat, 参数名, 贴图)
```

**Step 5: 应用材质**
```
Mesh → Set Material by Name ("Cloth", TempClothMat)
```

### InitPlayerAvatar 逻辑

**同样模式**:
```
Get DataTable Row (DT_Tex_Avatar_Path, "Cloth"/"Face"/"Eye"/"Hair")
    → Format Text (OutRowPath, {Index})
    → Load Asset Blocking
    → Set Texture Parameter Value (TempMonitorMat, 参数名, 贴图)
    → Set Material by Name (SM_Monitor, "Monitor", TempMonitorMat)
```

### DataTable 结构

**DT_Tex_Num_Format**:
| RowName | OutRowPath |
|:--------|:-----------|
| 1 | `/Game/0_/Resource/Number/T_Num_1_{0}` |
| 10 | `/Game/0_/Resource/Number/T_Num_10_{0}` |
| 100 | `/Game/0_/Resource/Number/T_Num_100_{0}` |

**DT_Tex_Avatar_Path**:
| RowName | OutRowPath |
|:--------|:-----------|
| Cloth | `/Game/0_/Resource/Avatar/Cloth/T_cloth_{0}` |
| Eye | `/Game/0_/Resource/Avatar/Eye/T_eyes_{0}` |
| Face | `/Game/0_/Resource/Avatar/Face/T_face_{0}` |
| Hair | `/Game/0_/Resource/Avatar/Hair/T_hair_{0}` |

---

## 五、淘汰状态

| 状态 | 材质效果 |
|:-----|:---------|
| 存活 | 正常渲染 |
| 淘汰 | 灰度化 / 半透明 |

**实现**：材质参数 `bIsEliminated` 控制灰度混合

---

## 六、资源组织

```
0_/
├── Character/Player/
│   ├── BP_Character_Game.uasset
│   ├── Anim/
│   │   ├── ABP_Character.uasset
│   │   ├── BlendSpace/
│   │   └── Sequence/Loco/
│   └── Mesh/
│       ├── SKM_Character.uasset
│       ├── SK_Character.uasset
│       └── MonitorHead/
│           ├── SM_Monitor.uasset
│           ├── Mat/
│           │   ├── M_Monitor.uasset
│           │   ├── MI_Monitor.uasset
│           │   └── MF_MonitorBaseColor.uasset
│           └── Tex/
├── Core/
│   ├── Config/     (DT_Gameplaytags, gameplaytags.csv)
│   ├── Data/       (E_LevelPhase, F_AvatarData, F_PlayerRecord)
│   ├── Framework/  (AIC, GI, GM, GS, PC, PS)
│   ├── GAS/        (BAS_Core, DT_BAS_Core)
│   └── StateMachine/
│       ├── ST_LevelFlow.uasset
│       └── Task/
├── Level/Dev/
│   └── L_Dev_Core.umap
└── Resource/Avatar/
    ├── Cloth/      (T_cloth_1 ~ T_cloth_137)
    ├── Eye/        (T_eyes_1 ~ T_eyes_55)  ← 注意: 复数命名
    ├── Face/       (T_face_1 ~ T_face_97)
    ├── Hair/       (T_hair_1 ~ T_hair_180)
    └── Mat/
        └── MF_AvatarComposite.uasset
```

---

## 七、待完成事项

- [x] 显示器材质函数 `MF_AvatarComposite`, `MF_MonitorBaseColor`
- [x] 显示器材质 `M_Monitor`, `MI_Monitor`
- [x] 编号材质函数 `MF_NumberComposite`
- [x] 衣服材质 `M_Clothes`, `MI_Cloth`
- [x] 数字贴图生成 (T_Num_1/10/100_0~9)
- [x] 蓝图初始化函数 `InitPlayerVisual` (DataTable + Load Asset Blocking)
- [ ] 淘汰灰度化效果

---

## 更新日志

| 日期 | 内容 |
|:-----|:-----|
| 2024-12-25 | 创建玩家形象系统文档 |
| 2024-12-26 | 完成显示器材质三层架构 (MF_AvatarComposite, MF_MonitorBaseColor, M_Monitor) |
| 2024-12-26 | 完成衣服材质三层架构 (MF_NumberComposite, M_Clothes, MI_Cloth) |
| 2024-12-26 | 完成 InitPlayerVisual 蓝图 (DataTable + Load Asset Blocking) |
| 2024-12-26 | 完成事件驱动架构 (Event Dispatcher + Timer 绑定) |
