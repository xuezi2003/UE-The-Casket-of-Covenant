# 伤害系统

> 关卡1（耐力之匣）被检测伤害系统设计与实现

---

## 设计概述

**核心机制**：红灯时被木偶检测到会受到伤害，护盾可抵消一次检测。

**触发流程**：
```
BP_Monitor 检测到玩家有 Danger 标签
    ↓
SendGameplayEventToActor (Gameplay.Event.Attack.Detect)
    ↓
触发 GA_Attacked
    ↓
护盾检查 → 有护盾则抵消，无护盾则扣血
```

**数据资产**：使用 `DA_PushSystemConfig` 中的 `AttackEffectContainer`
- **Target Type**: `GSCTargetTypeUseOwner`
- **Target GE Classes**: `GE_Damage_Detect`, `GE_Attack`
- **SetByCaller**: `Effect.Cost.Health` (-34.0)

---

## GA_Attacked（被攻击能力）

**父类**：GSCGameplayAbility

### Class Defaults 配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.BeingAttacked` |
| 激活阻止标签 | `Player.State.Dead` |
| 取消带标签的能力 | `Ability.Require.Stamina`, `Player.Action.Aiming`, `Player.Action.Dodging`, `Player.Action.Pushing`, `Player.Action.Throwing` |
| 复制策略 | 请勿复制 |
| 实例化策略 | 每个 Actor 实例化 |
| 网络执行策略 | **服务器已启动** |
| 重新触发实例化能力 | ✅ |
| 冷却 GE | `GE_Cooldown_Attacked` |

### 触发器配置

| 触发标签 | 触发源 |
|----------|--------|
| `Gameplay.Event.Attack.Detect` | Gameplay 事件 |

### 变量

| 变量名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| ConfigAsset | DA_PushSystemConfig | DA_Push_Default | 数据资产引用 |

### 事件图表

```
Event ActivateAbility / Event ActivateAbilityFromEvent
    ↓
DoExecGA (自定义事件)
```

### DoExecGA（自定义事件）

```
Event DoExecGA
    ↓
CommitAbility  // 先触发冷却，防止护盾消失后立即再次受击
    ↓
Cast (GetAvatarActorFromActorInfo) To BP_Character_Game
    ↓
HasMatchingGameplayTag (Player.State.Buffed.Shield)?
    ├─ False (无护盾):
    │   MakeEffectContainerSpecFromContainer (ConfigAsset.AttackEffectContainer)
    │       ↓
    │   ApplyEffectContainerSpec → SET EffectContainer (保存句柄)
    │       ↓
    │   PlayMontageAndWait (Anim_Attacked_Montage)
    │       ├─ 中断时 → End Ability
    │       ├─ 取消时 → End Ability
    │       ├─ 完成时 → End Ability
    │       └─ 混出时 → End Ability
    │
    └─ True (有护盾):
        RemoveActiveGameplayEffectBySourceEffect (GE_Buff_Shield, -1)
            ↓
        End Ability（护盾抵消）
```

### Event OnEndAbility

```
Event OnEndAbility (bWasCancelled)
    ↓
For Each in EffectContainer
    ↓
RemoveGameplayEffectFromOwnerWithHandle
    ↓
Array Clear (EffectContainer)
```

---

## 相关 GE

### GE_Damage_Detect

**用途**：应用数值伤害（SetByCaller）

| 配置项 | 值 |
|--------|-----|
| 持续时间策略 | 实时 (Instant) |
| 修饰符 | `BAS_Core.Health`, Add, SetByCaller |
| SetByCaller Data Tag | `Effect.Cost.Health` |
| 堆叠样式 | 无 |

### GE_Attack

**用途**：受击状态标签（由 Container 统一应用）

| 配置项 | 值 |
|--------|-----|
| 持续时间策略 | 无限 (Infinite) |
| Target Tags | `Player.State.Attacked` |
| 堆叠样式 | 按源聚合 (Limit 1) |

### GE_Cooldown_Attacked

**用途**：受击冷却，防止短时间内连续扣血

| 配置项 | 值 |
|--------|-----|
| 持续时间策略 | 拥有持续时间 (Has Duration) |
| 持续时间 | 2.0 秒 |
| Granted Tags | `Effect.Cooldown.Attacked` |
| 堆叠样式 | 按源聚合 (Limit 1) |
| 刷新策略 | 应用成功时刷新 |

---

## 伤害数值

| 场景 | 伤害 | 说明 |
|------|------|------|
| 无护盾 | -34 HP | 约 3 次检测死亡 |
| 有护盾 | 0 HP | 护盾抵消，护盾消失 |

---

## 网络说明

- **GA_Attacked**：服务器已启动，伤害计算在服务器执行
- **蒙太奇同步**：Server Initiated 策略自动同步到所有客户端
- **冷却**：每个玩家独立的 2 秒冷却

---

## 相关文档

- [BP_Monitor.md](../场景/木偶与监视器/BP_Monitor.md) - 检测触发
- [DA_PushSystemConfig.md](DA_PushSystemConfig.md) - AttackEffectContainer 配置
- [推搡系统.md](推搡系统.md) - 类似的 GA 实现参考
- [道具系统.md](../道具/道具系统.md) - 护盾机制说明
- [动作互斥系统.md](动作互斥系统.md) - GA/GE 标签汇总
