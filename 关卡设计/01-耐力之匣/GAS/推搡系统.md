# 推搡系统

**父类**：GSCGameplayAbility

## 设计概述

推搡系统允许玩家对前方目标进行推搡，使其进入失衡状态。

**核心机制**：
- 推搡消耗 20 体力（激活前检查）
- 推搡动作持续期间是危险状态（红灯时会被判定死亡）
- 推搡使用根运动，期间禁用输入
- 通过动画通知触发检测，使用 Sphere Trace 判断命中
- 命中目标通过 Gameplay Event 触发目标的失衡能力

## 变量

| 变量名 | 类型 | 值 | 说明 |
|--------|------|-----|------|
| StaminaCost | Float | 20.0 | 用于激活前体力检查 |
| TraceLen | Float | 120.0 | Sphere Trace 前方检测距离 |
| TraceRadius | Float | 50.0 | Sphere Trace 球体半径 |
| Effect Container | Array | - | 保存应用的 GE Handle |
| Actor Loc | Vector | - | 缓存角色位置 |
| Forward Vec | Vector | - | 缓存角色前向向量 |

## 标签配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Pushing` |
| 激活阻止标签 | `Player.State.Exhausted` |

**设计说明**：
- `Player.State.Exhausted` → 力竭时无法激活推搡
- 不需要 `Ability.Require.Stamina` → 一次性消耗技能不会被力竭强制取消

## 高级配置

| 配置项 | 值 |
|--------|-----|
| 复制策略 | 请勿复制 |
| 实例化策略 | 每个 Actor 实例化 |
| 网络执行策略 | 本地预测 |
| 网络安全策略 | 客户端或服务器 |
| 重新触发实例化能力 | ✅ |

## Effect Container Map

| 触发标签 | GE | SetByCaller |
|----------|-----|-------------|
| `Effect.Container.Push` | GE_Pushing, GE_StaminaCost | `Effect.Cost.Stamina` = -20 |

## 事件图表

### Event ActivateAbility

```
Check Stamina (宏) → Stamina >= 20?
    ├─ False → End Ability（不扣体力）
    └─ True ↓
CommitAbility
    ↓
Apply Effect Container (Effect.Container.Push) → 保存到 Effect Container 变量
    ↓
Play Montage and Wait for Event (Anim_Push_Montage)
    │
    ├─ 【Event Received】(Gameplay.Event.Montage.Push) → DoSphereTrace
    │       ↓
    │   命中 BP_Character_Game？
    │       ├─ 是 → Send Gameplay Event to Actor (目标, Tag: Gameplay.Event.Activate.Stagger)
    │       └─ 否 → 无操作
    │
    ├─ 【Completed】 → End Ability
    ├─ 【Blend Out】 → End Ability
    ├─ 【Interrupted】 → End Ability
    └─ 【Cancelled】 → End Ability
```

### DoSphereTrace 函数

```
缓存变量：
    SET Actor Loc = Get Avatar Actor → Get Actor Location
    SET Forward Vec = Get Avatar Actor → Get Actor Forward Vector
    ↓
Sphere Trace By Profile
    ├─ Start: GetStart() = Actor Loc + Forward Vec × TraceRadius
    ├─ End: GetEnd() = Actor Loc + Forward Vec × TraceLen
    ├─ Radius: TraceRadius (50)
    ├─ Profile Name: Pawn
    ├─ Actors to Ignore: [Avatar Actor]
    └─ Ignore Self: ✅
    ↓
Branch (Out Hit)
    ├─ True → Break Hit Result → Hit Actor → Cast To BP_Character_Game
    └─ False → 无操作
```

**设计说明**：
- **起点从 Forward × TraceRadius 开始**：避免检测到身后的物体，确保检测区域从角色"正前方"开始
- **Profile Name = Pawn**：只检测其他角色，忽略场景物体

### Event OnEndAbility

```
For Each (Effect Container Handles)
    → RemoveGameplayEffectFromOwnerWithHandle (Stacks = -1)
```

## 动画配置

### 蒙太奇 (Anim_Push_Montage)

| 配置项 | 值 |
|--------|-----|
| Slot | DefaultGroup.DefaultSlot |
| Enable Root Motion | ✅ |

### 动画通知

| 通知类型 | 标签 | 时机 |
|----------|------|------|
| AN_GSC_SendGameplayEventByTag | `Gameplay.Event.Montage.Push` | 踢腿完全伸出时 |

## 相关 GE

### GE_Pushing

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA 手动移除） |
| Target Tags | `Player.Action.Pushing`, `Player.State.Danger` |
| 堆叠样式 | 按源聚合（限制1） |

**注意**：此 GE 同时添加 Action 和 Danger 标签，因为推搡是主动技能，需要明确的危险状态。

### GE_StaminaCost

通用按次体力消耗 GE，详见 [体力系统.md](体力系统.md#按次消耗通用-ge_staminacost)。

## 输入绑定

| Input Action | 按键 | 触发器 |
|--------------|------|--------|
| IA_Endurance_Push | 鼠标左键 | 已按下 |

## 实现状态

- [x] 输入绑定（鼠标左键）
- [x] GE_Pushing（Danger + Pushing 标签）
- [x] GA_Push 基础框架（Check Stamina + Effect Container）
- [x] Play Montage and Wait for Event 集成
- [x] 动画通知 AN_GSC_SendGameplayEventByTag
- [x] DoSphereTrace 检测（TraceLen=120, TraceRadius=50）
- [ ] 命中后发送 Gameplay Event 给目标
- [ ] 目标 GA_Stagger 通过事件激活
