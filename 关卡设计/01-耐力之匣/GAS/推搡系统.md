# 推搡系统

**父类**：GSCGameplayAbility

## 设计概述

推搡系统允许玩家对前方目标进行推搡，使其进入失衡状态。

**核心机制**：
- 推搡消耗 20 体力（激活前检查）
- 推搡动作持续期间是危险状态（红灯时被检测到会扣 HP）
- 推搡使用根运动，期间禁用输入
- 通过动画通知触发检测，使用 Sphere Trace 判断命中
- 命中目标通过 Gameplay Event 触发目标的失衡能力

**数据资产**：详见 [DA_PushSystemConfig.md](DA_PushSystemConfig.md)

## 变量

| 变量名 | 类型 | 值 | 说明 |
|--------|------|-----|------|
| ConfigAsset | DA_PushSystemConfig | DA_Push_Default | 数据资产引用 |
| TraceLen | Float | 120.0 | Sphere Trace 前方检测距离 |
| TraceRadius | Float | 50.0 | Sphere Trace 球体半径 |
| Effect Container | Array | - | 保存应用的 GE Handle |
| Actor Loc | Vector | - | 缓存角色位置 |
| Forward Vec | Vector | - | 缓存角色前向向量 |

## 标签配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Pushing` |
| 激活阻止标签 | `Player.State.Exhausted`, `Player.Action.Aiming` |

**设计说明**：
- `Player.State.Exhausted` → 力竭时无法激活推搡
- 不需要 `Ability.Require.Stamina` → 一次性消耗技能不会被力竭强制取消

## 高级配置

| 配置项 | 值 |
|--------|-----|
| 复制策略 | 请勿复制 |
| 实例化策略 | 每个 Actor 实例化 |
| 网络执行策略 | 本地预测 |
| 网络安全策略 | 客户端或服务器 |
| 重新触发实例化能力 | ✅ |

## Effect Container

**PushEffectContainer**：GE_Pushing, GE_StaminaCost（SetByCaller = -20）

## 事件图表

### Event ActivateAbility

```
Check Stamina (宏) → Stamina >= Abs(ConfigAsset.PushEffectContainer.SetByCallerMagnitude)?
    ├─ False → End Ability（不扣体力）
    └─ True ↓
CommitAbility
    ↓
MakeEffectContainerSpecFromContainer (ConfigAsset.PushEffectContainer)
    → ApplyEffectContainerSpec → 保存到 Effect Container 变量
    ↓
Play Montage and Wait for Event (Anim_Push_Montage)
    │
    ├─ 【Event Received】(Gameplay.Event.Montage.Push) → DoSphereTrace
    │       ↓
    │   命中 BP_Character_Game？
    │       ├─ 是 → 目标有 Player.State.Invincible？
    │       │       ├─ 有（无敌）→ Send Gameplay Event to Self (Gameplay.Event.Activate.Fall)
    │       │       │              → 推搡者自己摔倒
    │       │       └─ 无 → Send Gameplay Event to Actor (目标, Gameplay.Event.Activate.Stagger)
    │       │              → 目标进入失衡
    │       └─ 否 → 推空，无惩罚
    │
    ├─ 【Completed】 → End Ability
    ├─ 【Blend Out】 → End Ability
    ├─ 【Interrupted】 → End Ability
    └─ 【Cancelled】 → End Ability
```

### DoSphereTrace 函数

```
缓存变量：
    SET Actor Loc = Get Avatar Actor → Get Actor Location
    SET Forward Vec = Get Avatar Actor → Get Actor Forward Vector
    ↓
Sphere Trace By Profile
    ├─ Start: GetStart() = Actor Loc + Forward Vec × TraceRadius
    ├─ End: GetEnd() = Actor Loc + Forward Vec × TraceLen
    ├─ Radius: TraceRadius (50)
    ├─ Profile Name: Pawn
    ├─ Actors to Ignore: [Avatar Actor]
    └─ Ignore Self: ✅
    ↓
Branch (Out Hit)
    ├─ True → Break Hit Result → Hit Actor → Cast To BP_Character_Game
    │         → Has Gameplay Tag (Player.State.Invincible)
    │             ├─ True → 返回 "命中无敌目标"
    │             └─ False → 返回 "命中普通目标"
    └─ False → 无操作
```

**设计说明**：
- **起点从 Forward × TraceRadius 开始**：避免检测到身后的物体，确保检测区域从角色"正前方"开始
- **Profile Name = Pawn**：只检测其他角色，忽略场景物体
- **无敌检测**：命中后检查目标是否有 `Player.State.Invincible` 标签，决定后续分支

### Event OnEndAbility

```
For Each (Effect Container Handles)
    → RemoveGameplayEffectFromOwnerWithHandle (Stacks = -1)
```

## 动画配置

### 蒙太奇 (Anim_Push_Montage)

| 配置项 | 值 |
|--------|-----|
| Slot | DefaultGroup.DefaultSlot |
| Enable Root Motion | ✅ |

### 动画通知

| 通知类型 | 标签 | 时机 |
|----------|------|------|
| AN_GSC_SendGameplayEventByTag | `Gameplay.Event.Montage.Push` | 踢腿完全伸出时 |

## 相关 GE

### GE_Pushing

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA 手动移除） |
| Target Tags | `Player.Action.Pushing`, `Player.State.Danger` |
| 堆叠样式 | 按源聚合（限制1） |

**注意**：此 GE 同时添加 Action 和 Danger 标签，因为推搡是主动技能，需要明确的危险状态。

### GE_StaminaCost

通用按次体力消耗 GE，详见 [体力系统.md](体力系统.md#按次消耗通用-ge_staminacost)。

---

## 推搡交互相关 GE

以下 GE 与推搡系统的交互逻辑相关：

### GE_Staggered（失衡状态）

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA 手动移除） |
| Target Tags | `Player.State.Staggered` |
| 堆叠样式 | 按源聚合（限制1） |

> [!NOTE]
> **失衡是安全状态**：不添加 `Player.State.Danger` 标签，红灯时不会被扣 HP。

### GE_Fallen（摔倒状态）

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA 手动移除） |
| Target Tags | `Player.State.Fallen`, `Player.State.Danger` |
| 堆叠样式 | 按源聚合（限制1） |

**触发条件**：推搡命中无敌目标时，推搡者进入摔倒状态；或失衡超时。

### GE_Dodging（闪避状态）

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA 手动移除） |
| Target Tags | `Player.Action.Dodging`, `Player.State.Danger` |
| 堆叠样式 | 按源聚合（限制1） |

### GE_Invincible（无敌状态）

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA_Dodge 手动控制） |
| Target Tags | `Player.State.Invincible` |
| 堆叠样式 | 按源聚合（限制1） |

**用途**：闪避蒙太奇期间的无敌帧（通过 AN_GSC_SendGameplayEventByTag 发送事件，GA_Dodge 处理添加/移除），以及护盾道具的免伤效果。

**双重保护机制**：

| 保护层 | 实现位置 | 作用 |
|--------|----------|------|
| 推搡方检查 | GA_Push → DoSphereTrace | 命中无敌目标 → 推搡者自己摔倒 |
| 目标方阻止 | GA_Stagger/GA_Fall 激活阻止标签 | 无敌时直接阻止能力激活 |

> [!NOTE]
> 通过激活阻止标签，无论触发 Stagger/Fall 的来源是什么（推搡、道具、机关等），只要玩家处于无敌状态都不会生效。

---

## 输入绑定

| Input Action | 按键 | 触发器 |
|--------------|------|--------|
| IA_Endurance_Push | 鼠标左键 | 已按下 |

---

## 推搡交互相关 GA

### GA_Stagger（失衡能力）

**父类**：GSCGameplayAbility

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Staggering` |
| 激活阻止标签 | `Player.State.Staggered`, `Player.State.Invincible` |
| 复制策略 | 请勿复制 |
| 实例化策略 | 每个 Actor 实例化 |
| 网络执行策略 | **服务器已启动** |
| 重新触发实例化能力 | ✅ |

**触发器配置**：
| 触发标签 | 触发源 |
|----------|--------|
| `Gameplay.Event.Activate.Stagger` | Gameplay事件 |

**Effect Container**：GE_Staggered

**变量**：
| 变量名 | 类型 | 说明 |
|--------|------|------|
| ConfigAsset | DA_PushSystemConfig | 数据资产引用（Instance Editable） |
| QTE_Finished | Bool | 防止超时与事件重复处理 |
| CompEndurance | Comp_PC_Endurance | 缓存的 PC 组件引用 |
| Effect Container | Array | 保存 GE Handle |

**事件图表**：
```
Event ActivateAbilityFromEvent / Event ActivateAbility
    ↓
Has Matching Gameplay Tag (Player.State.Buffed.Shield)?
    ├─ True (有护盾) →
    │   RemoveActiveGameplayEffectBySourceEffect (GE_Buff_Shield, -1)
    │       ↓
    │   EndAbility（护盾抵消）
    │
    └─ False (无护盾) ↓
CommitAbility → MakeEffectContainerSpecFromContainer (ConfigAsset.StaggerEffectContainer)
    → ApplyEffectContainerSpec → SET Effect Container
    ↓
PlayMontageAndWaitForEvent (Anim_Stagger_Start_Montage)
    │
    ├─ 【On Completed】 → SET QTE_Finished = false
    │       ↓
    │   Cast (GetController) to PC_Core
    │       │
    │       ├─ 成功 (玩家):
    │       │   → SET CompEndurance = GetComponentByClass(Comp_PC_Endurance)
    │       │   → Has Authority?
    │       │       └─ True → Client_StartQTE()
    │       │   → 并行启动:
    │       │       ├─ WaitGameplayEvent (Gameplay.Event.QTE.Result)
    │       │       │   → SET QTE_Finished = true
    │       │       │   → EndAbility (成功)
    │       │       │
    │       │       └─ Delay (ConfigAsset.StaggerDuration)
    │       │           → If (NOT QTE_Finished)
    │       │               → CompEndurance.Client_CloseQTEWidget()
    │       │               → GA_Fall → EndAbility
    │       │
    │       └─ 失败 (AI):
    │           → Delay(ConfigAsset.StaggerDuration × Random(0.5~1.0))
    │           → Random >= ConfigAsset.AISuccessRate?
    │               ├─ True → GA_Fall → EndAbility
    │               └─ False → EndAbility (恢复)
    │
    ├─ 【On Interrupted】 → EndAbility
    └─ 【On Cancelled】 → EndAbility

Event OnEndAbility
    ↓
For Each (Effect Container) → RemoveGameplayEffectFromOwnerWithHandle(-1) → Array Clear
```

**动画实现方式**：
- "失衡开始"：蒙太奇（Anim_Stagger_Start_Montage）
- Stagger Idle：动画蓝图状态机（通过 `Player.State.Staggered` 标签切换）
- QTE 成功 → EndAbility 恢复正常
- QTE 失败/超时 → 触发 `GA_Fall`

---

### GA_Fall（摔倒能力）

**父类**：GSCGameplayAbility

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Falling` |
| 激活阻止标签 | `Player.State.Fallen`, `Player.State.Invincible` |
| 复制策略 | 请勿复制 |
| 实例化策略 | 每个 Actor 实例化 |
| 网络执行策略 | **服务器已启动** |
| 重新触发实例化能力 | ✅ |

**触发器配置**：
| 触发标签 | 触发源 |
|----------|--------|
| `Gameplay.Event.Activate.Fall` | Gameplay事件 |

**Effect Container**：GE_Fallen

**变量**：
| 变量名 | 类型 | 说明 |
|--------|------|------|
| ConfigAsset | DA_PushSystemConfig | 数据资产引用 |
| Effect Container | Array | 保存 GE Handle |

**事件图表**：
```
Event ActivateAbilityFromEvent
    ↓
Has Matching Gameplay Tag (Player.State.Buffed.Shield)?
    ├─ True (有护盾) →
    │   RemoveActiveGameplayEffectBySourceEffect (GE_Buff_Shield, -1)
    │       ↓
    │   EndAbility（护盾抵消）
    │
    └─ False (无护盾) ↓
CommitAbility → MakeEffectContainerSpecFromContainer (ConfigAsset.FallEffectContainer)
    → ApplyEffectContainerSpec → SET Effect Container
    ↓
PlayMontageAndWaitForEvent (Anim_Fall_Down_Montage)
    │
    ├─ 【On Completed】 → Delay (ConfigAsset.FallDuration)
    │       ↓
    │   PlayMontageAndWaitForEvent (Anim_Fall_GetUp_Montage)
    │       └─ 【Completed/Blend Out/Interrupted/Cancelled】 → End Ability
    │
    ├─ 【On Interrupted】 → End Ability
    └─ 【On Cancelled】 → End Ability

Event OnEndAbility
    ↓
For Each (Effect Container) → RemoveGameplayEffectFromOwnerWithHandle (-1) → CLEAR
```

**动画实现方式**：
- "摔倒"：蒙太奇（Anim_Fall_Down_Montage）
- Fallen Idle：动画蓝图状态机（通过 `Player.State.Fallen` 标签切换到 Endurance_Fall 状态）
- "起身"：蒙太奇（Anim_Fall_GetUp_Montage）
- 整个摔倒过程**不可中断**

---

### GA_Dodge（闪避能力）

**父类**：GSCGameplayAbility

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Dodging` |
| 激活阻止标签 | `Player.State.Exhausted` |
| 复制策略 | 请勿复制 |
| 实例化策略 | 每个 Actor 实例化 |
| 网络执行策略 | 本地预测 |
| 重新触发实例化能力 | ✅ |

**变量**：
| 变量名 | 类型 | 说明 |
|--------|------|------|
| ConfigAsset | DA_PushSystemConfig | 数据资产引用 |
| Effect Container | Array | 保存 GE_Dodging 等 Handle |
| Effect Invincible | Handle | 保存 GE_Invincible Handle |

**Effect Container**：GE_Dodging, GE_StaminaCost（SetByCaller = -20）

**事件图表**：
```
Event ActivateAbility
    ↓
Check Stamina (宏) → Stamina >= Abs(ConfigAsset.DodgeEffectContainer.SetByCallerMagnitude)?
    ├─ False → End Ability
    └─ True ↓
CommitAbility → MakeEffectContainerSpecFromContainer (ConfigAsset.DodgeEffectContainer)
    → ApplyEffectContainerSpec → SET Effect Container
    ↓
PlayMontageAndWaitForEvent (Anim_Dodge_Montage)
    │
    ├─ 【Event Received】→ Switch on Gameplay Tag
    │       ├─ Gameplay.Event.Dodge.InvincibleStart
    │       │   → ApplyGameplayEffectToSelf (GE_Invincible) → SET Effect Invincible
    │       │
    │       └─ Gameplay.Event.Dodge.InvincibleEnd
    │           → Remove Active Gameplay Effect (Effect Invincible, -1)
    │
    ├─ 【Completed/Blend Out/Interrupted/Cancelled】 → End Ability

Event OnEndAbility
    ↓
Sequence
    ├─ Then 0: For Each (Effect Container) → RemoveGameplayEffectFromOwnerWithHandle (-1) → CLEAR
    └─ Then 1: Remove Active Gameplay Effect (Effect Invincible, -1)
```

**蒙太奇配置 (Anim_Dodge_Montage)**：
| 配置项 | 值 |
|--------|-----|
| Slot | DefaultGroup.DefaultSlot |
| Enable Root Motion | ✅ |

**动画通知**：
| 通知类型 | 标签 | 位置 |
|----------|------|------|
| AN_GSC_SendGameplayEventByTag | `Gameplay.Event.Dodge.InvincibleStart` | 约 20% |
| AN_GSC_SendGameplayEventByTag | `Gameplay.Event.Dodge.InvincibleEnd` | 约 80% |

---

## 动画蓝图状态机配置

**位置**：ABP_Character > AnimGraph > Main States

### Endurance 特殊状态

| 状态名 | 播放动画 | 进入条件 | 离开条件 |
|--------|----------|----------|----------|
| Endurance_Stagger | Anim_Stagger_Idle（循环） | `Is Staggered == True` | `Is Staggered == False` |
| Endurance_Fall | Anim_Fall_Idle（循环） | `Is Fallen == True` | `Is Fallen == False` |

### Update_Endurance 函数

```
Update_Endurance
    ↓
Is Valid (Character)
    ↓
Get Ability System Component
    ↓
SET Is Staggered = Has Matching Gameplay Tag (Player.State.Staggered)
SET Is Fallen = Has Matching Gameplay Tag (Player.State.Fallen)
```

---

## 动作互斥设计

> [!IMPORTANT]
> **动作互斥待实现**：`GA_Push` 需添加 `Player.Action.Aiming` 阻止标签，确保瞄准时左键不触发推搡。其他互斥关系根据需要逐步配置。


