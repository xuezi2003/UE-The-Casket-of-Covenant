# 动作互斥系统

> 关卡1（耐力之匣）动作互斥系统设计与配置

---

## 一、GA/GE 标签配置汇总

### GA（Gameplay Ability）

| 技能 | 资产标签 | 激活阻止标签 | 激活所需标签 | 取消技能标签 | 网络策略 |
|------|----------|--------------|--------------|--------------|----------|
| GA_Sprint | `Ability.Require.Stamina`, `Player.Action.Running` | `Exhausted`, `Staggered`, `Fallen`, `Dead`, `Attacked` | - | - | 本地预测 |
| GA_Crouch | `Player.Action.Crouching` | `Staggered`, `Fallen`, `Dead`, `Attacked` | - | - | 本地预测 |
| GA_Jump | `Player.Action.Jumping` | `Jumping`, `Exhausted`, `Staggered`, `Fallen`, `Dead`, `Attacked` | - | - | 本地预测 |
| GA_Push | `Player.Action.Pushing` | `Aiming`, `Dodging`, `Pushing`, `Exhausted`, `Fallen`, `Staggered`, `Dead`, `Attacked` | - | - | 本地预测 |
| GA_Dodge | `Player.Action.Dodging` | `Dodging`, `Pushing`, `Exhausted`, `Fallen`, `Staggered`, `Dead`, `Attacked` | - | - | 本地预测 |
| GA_Aim | `Player.Action.Aiming` | `Aiming`, `Throwing`, `Fallen`, `Staggered`, `Dead`, `Attacked` | - | - | 本地预测 |
| GA_Throw | `Player.Action.Throwing` | `Throwing`, `Fallen`, `Staggered`, `Dead`, `Attacked` | `Aiming` | - | 服务器已启动 |
| GA_Stagger | `Player.Action.Staggering` | `Staggered`, `Invincible`, `Dead` | - | `Aiming`, `Throwing`, `Require.Stamina` | 服务器已启动 |
| GA_Fall | `Player.Action.Falling` | `Fallen`, `Invincible`, `Dead` | - | `Aiming`, `Throwing`, `Require.Stamina` | 服务器已启动 |
| GA_Attacked | `Player.Action.BeingAttacked` | `Dead` | - | `Require.Stamina`, `Aiming`, `Dodging`, `Pushing`, `Throwing` | 服务器已启动 |
| GA_Exhausted | - | - | - | `Ability.Require.Stamina` | - |

### GE（Gameplay Effect）

| GE | 添加标签 (Granted Tags) | 持续时间 | 备注 |
|----|-------------------------|----------|------|
| GE_Sprint | `Player.Action.Running`, `Player.State.Danger` | 无限 | - |
| GE_Crouch | `Player.Action.Crouching` | 无限 | - |
| GE_Jumping | `Player.Action.Jumping` | 无限 | - |
| GE_Pushing | `Player.Action.Pushing`, `Player.State.Danger` | 无限 | - |
| GE_Dodging | `Player.Action.Dodging`, `Player.State.Danger` | 无限 | - |
| GE_Invincible | `Player.State.Invincible` | 无限 | - |
| GE_Aiming | `Player.Action.Aiming` | 无限 | - |
| GE_Aiming_Danger | `Player.State.Danger` | 0.25s | - |
| GE_Throwing | `Player.Action.Throwing`, `Player.State.Danger` | 无限 | - |
| GE_Staggered | `Player.State.Staggered` | 无限 | - |
| GE_Fallen | `Player.State.Fallen` | 无限 | 只包含状态标签 |
| GE_Fallen_Danger | `Player.State.Danger` | 无限 | 只在蒙太奇时应用 |
| GE_Exhausted | `Player.State.Exhausted` | 无限 | - |
| GE_StopMove | - | 无限 | 使 SpeedRate × 0 |
| GE_Buff_Lightning | `Player.State.Buffed.Lightning` | 10s | - |
| GE_Buff_Shield | `Player.State.Buffed.Shield` | 30s | - |
| GE_Damage_Detect | - | 实时 | SetByCaller 伤害 |
| GE_Cooldown_Attacked | `Effect.Cooldown.Attacked` | 2s | 受击冷却 |
| GE_Attack | `Player.State.Attacked` | 无限 | 受击状态（GA 手动移除） |
| GE_Dead | `Player.State.Dead` | 无限 | 死亡状态 |

---

## 二、配置后激活阻止矩阵

行：当前状态  
列：尝试激活的技能  
✅ = 可激活 / ❌ = 被阻止

| 当前状态 ↓ | Sprint | Crouch | Jump | Push | Dodge | Aim | Throw | Stagger | Fall |
|------------|:------:|:------:|:----:|:----:|:-----:|:---:|:-----:|:-------:|:----:|
| Sprint | - | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| Crouch | ✅ | - | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| Jump | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| Push | ✅ | ✅ | ✅ | - | **❌** | ✅ | ❌ | ✅ | ✅ |
| Dodge | ✅ | ✅ | ✅ | **❌** | - | ✅ | ❌ | ✅ | ✅ |
| Aim | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ✅ | ✅ | ✅ |
| Throw | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ | ✅ | ✅ |
| **Stagger** | **❌** | **❌** | **❌** | **❌** | **❌** | **❌** | **❌** | ❌ | ✅ |
| **Fall** | **❌** | **❌** | **❌** | **❌** | **❌** | **❌** | **❌** | ✅ | ❌ |
| Invincible | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| Exhausted | ❌ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ |

> [!NOTE]
> **加粗** 表示本次配置变更的新增互斥关系。

---

## 三、已确认配置变更

### 3.1 失衡/摔倒阻止其他技能

| GA | 需添加激活阻止标签 |
|----|------------------|
| GA_Sprint | `Player.State.Staggered`, `Player.State.Fallen` |
| GA_Jump | `Player.State.Staggered`, `Player.State.Fallen` |
| GA_Crouch | `Player.State.Staggered`, `Player.State.Fallen` |
| GA_Push | `Player.State.Staggered`, `Player.State.Fallen` |
| GA_Dodge | `Player.State.Staggered`, `Player.State.Fallen` |
| GA_Aim | `Player.State.Staggered`, `Player.State.Fallen` |
| GA_Throw | `Player.State.Staggered`, `Player.State.Fallen` |

### 3.2 推搡/闪避互斥

| GA | 需添加激活阻止标签 |
|----|------------------|
| GA_Push | `Player.Action.Dodging` |
| GA_Dodge | `Player.Action.Pushing` |

### 3.3 进入失衡/摔倒时取消正在进行的技能

| GA | 需添加「取消技能标签」|
|----|---------------------|
| GA_Stagger | `Player.Action.Aiming`, `Player.Action.Throwing`, `Ability.Require.Stamina` |
| GA_Fall | `Player.Action.Aiming`, `Player.Action.Throwing`, `Ability.Require.Stamina` |

### 3.4 禁止移动（GE_StopMove）

新增独立 GE 用于禁止移动，配置到 DA_PushSystemConfig 的 Effect Container 中。

| GE | 配置 |
|----|------|
| **GE_StopMove** | Modifier: `BAS_Core.SpeedRate` × 0 <br> Duration: Infinite <br> Stack: By Source (Limit 1) |

**配置应用**：
- DA_PushSystemConfig.StaggerEffectContainer → Add `GE_StopMove`
- DA_PushSystemConfig.FallEffectContainer → Add `GE_StopMove`

> [!NOTE]
> 使用 `SpeedRate × 0` 而非 `SetMovementMode(MOVE_None)`，保持重力正常运作。跳跃中触发失衡时角色会自然下落，落地后因 SpeedRate=0 无法移动。

### 3.5 蹲行状态处理

失衡/摔倒时阻止 GA_Crouch 激活，但不取消已应用的 GE_Crouch。失衡前是蹲着的，结束后仍保持蹲行。

---

## Phase 6 / 6.5 已完成

- [x] GA_Attacked 动作互斥配置（资产标签：`Player.Action.BeingAttacked`）
- [x] GE_Damage_Detect / GE_Cooldown_Attacked / GE_Attack / GE_Dead 添加到 GE 表格
- [x] 所有主动技能添加激活阻止标签 `Player.State.Dead`
- [x] 所有主动技能添加激活阻止标签 `Player.State.Attacked`

---

## 相关文档

- [推搡系统.md](推搡系统.md)
- [伤害系统.md](伤害系统.md)
- [瞄准投掷系统.md](../道具/瞄准投掷系统.md)
- [体力系统.md](体力系统.md)
- [GameplayTags.csv](../../00-通用逻辑/GameplayTags.csv)
