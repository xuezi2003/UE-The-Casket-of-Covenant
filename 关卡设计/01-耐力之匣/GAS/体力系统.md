# 体力系统（关卡1、5 专属）

## 设计思想：标签驱动

体力系统采用 **监听 Gameplay Tag 变化** 的方式来触发 GE 的应用/移除。

**核心思路**：
1. Ability 只负责添加/移除自己的 Action 标签
2. 组件监听标签变化，根据标签状态应用/移除对应的 GE
3. GE 通过 Target Tag Reqs 自动判断是否生效

**好处**：
- 解耦：Ability 不需要知道体力消耗的具体实现
- 灵活：可以轻松添加新的消耗条件
- 可扩展：其他系统也可以监听同样的标签做出响应

---

## 体力消耗

### 持续消耗（Periodic）

| GE | 触发标签 | 效果 | 实现状态 |
|----|----------|------|----------|
| GE_StaminaDrain_Sprint | `Player.Action.Running` | -0.5/0.1s | ✅ 已实现 |

**配置要点**：
- 持续时间：无限
- 周期：0.1s，勾选「对应用执行周期影响」
- Target Tag Reqs：需要对应的 Action 标签 + `Player.State.Moving`

**触发方式**：监听标签变化，标签存在时 Apply，标签移除时 Remove。

### 按次消耗（通用 GE_StaminaCost）

采用 **SetByCaller** 设计，一个通用 GE 支持不同消耗值。

| GE | 配置 | 实现状态 |
|----|------|----------|
| GE_StaminaCost | Instant, Stamina Add, SetByCaller (`Effect.Cost.Stamina`) | ✅ 已实现 |

**各技能消耗值**：

| 技能 | SetByCaller 幅度 | 实现状态 |
|------|-----------------|----------|
| GA_Jump | -15 | ✅ 已实现 |
| GA_Push | -15 | ❌ 待实现 |
| GA_Dodge | -20 | ❌ 待实现 |

**配置要点**：
- 持续时间：实时（Instant）
- 修饰符幅度：由调用者设置（SetByCaller）
- 数据标签：`Effect.Cost.Stamina`
- 通过 Effect Container Map 在 GA 中设置具体消耗值

---

## 体力回复

| GE | 条件 | 效果 | 实现状态 |
|----|------|------|----------|
| GE_StaminaRegen | 非奔跑时 | +0.5/0.1s | ✅ 已实现 |

**配置要点**：
- 持续时间：无限
- 周期：0.1s
- Target Tag Reqs - 必须不能有：`Player.Action.Running`, `Player.Action.Jumping`

**触发方式**：通过 AbilitySet 的 Granted Effects 赋予，角色初始化时自动应用，通过 Tag Reqs 自动控制生效。

---

## 力竭机制

力竭时需要取消正在执行的体力消耗 Ability（如奔跑）。由于 GE 只能 Block 不能 Cancel 已激活的 Ability，采用 **GE 赋予 GA，GA 取消 Ability** 的方案。

### 实现架构

```
Stamina = 0 → Apply GE_Exhausted
                    ↓
            GE_Exhausted 添加 Exhausted 标签
                    ↓
            GE_Exhausted 通过 Grant Abilities While Active 赋予 GA_Exhausted
                    ↓
            GA_Exhausted 设置了 Activate on Granted，立即激活
                    ↓
            GA_Exhausted 的 Cancel Abilities With Tag 取消所有 Ability.Require.Stamina
                    ↓
            GA_Sprint 被取消，移除 Running 标签
                    ↓
Stamina ≥ 15 → Remove GE_Exhausted → 可重新奔跑
```

### GE_Exhausted 配置

| 设置 | 值 |
|------|-----|
| 持续时间策略 | 无限 |
| Target Tags | 添加 `Player.State.Exhausted` |
| Grant Abilities While Active | GA_Exhausted（移除策略：立即取消能力） |

### GA_Exhausted 配置

| 设置 | 值 |
|------|-----|
| Activate on Granted | ✅ 勾选 |
| 取消带标签的能力 | `Ability.Require.Stamina` |

### GA_Sprint 配置

| 设置 | 值 |
|------|-----|
| 资产标签 | `Ability.Require.Stamina`, `Player.Action.Running` |
| 激活阻止标签 | `Player.State.Exhausted` |

**注意**：Running 标签由 GE_Sprint 的 Target Tags Granted 添加，而非 GA 的激活已拥有标签。

### 触发方式

在 Comp_Character_Endurance 中通过 `GSCCore.OnAttributeChange` 官方事件监听 Stamina 属性变化，采用**滞后阈值**逻辑：

```
Has Tag (Player.State.Exhausted)?
    ├─ 否 + Stamina = 0 → ApplyGameplayEffectToSelf(GE_Exhausted)
    └─ 是 + Stamina ≥ 15 → RemoveActiveGameplayEffectBySourceEffect(GE_Exhausted)
```

**设计思路**：
- 单一阈值会导致边界抖动（体力在 19-21 反复弹跳）
- 滞后阈值（0 进入 / 15 退出）避免这个问题
- 所有按次消耗技能耗费 ≥15，确保力竭时无法激活

**注意**：使用 GSCCore 官方提供的属性变化事件绑定，不再使用自定义 Async Task。

### 实现状态

| 组件 | 状态 |
|------|------|
| GE_Exhausted | ✅ 已实现 |
| GA_Exhausted | ✅ 已实现 |
| Ability.Require.Stamina 标签 | ✅ 已添加 |
