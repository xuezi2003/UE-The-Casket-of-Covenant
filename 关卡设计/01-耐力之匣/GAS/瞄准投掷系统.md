# 瞄准投掷系统

**父类**：GSCGameplayAbility

## 设计概述

瞄准投掷系统允许玩家使用投掷类道具攻击其他玩家。

**核心机制**：
- 按住右键进入瞄准状态，松开取消
- 瞄准中按左键投掷道具
- 投掷后自动结束瞄准状态
- 手持道具通过 Multicast RPC 同步显示

**数据资产**：详见 [DA_ItemSystemConfig.md](DA_ItemSystemConfig.md)

---

## GA_Aim（瞄准能力）

**路径**：`Content/0_/Level/1_Endurance/GAS/GA/GA_Aim`

### 标签配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Aiming` |
| 激活阻止标签 | `Player.Action.Aiming`, `Player.Action.Throwing` |

### 高级配置

| 配置项 | 值 |
|--------|-----|
| 网络执行策略 | 本地预测 |
| 实例化策略 | 每个 Actor 实例化 |
| 重新触发实例化能力 | ✅ |

### 变量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| ConfigAsset | DA_ItemSystemConfig | 数据资产引用 |
| Effect Container | Array\<Handle\> | GE Handle 缓存 |

### 事件图表

```
Event ActivateAbility
    ↓
Check Have Throwable (宏)
    └─ Call GetThrowItemID → Is Valid?
    ├─ False → End Ability
    └─ True ↓
CommitAbility → Apply Effect Container (AimEffectContainer) → SET Effect Container
    ↓
ShowSMProp(true)  ← 显示手持道具
    ↓
Wait Input Release (IA_Endurance_Aim)
    │
    ├─【On Release】→ End Ability
    │
    └─【同时】Wait Gameplay Event (Gameplay.Event.Aim.End)
            ↓ Event Received
        End Ability  ← 投掷完成时由 GA_Throw 发送事件触发

---
Event OnEndAbility
    ↓
ShowSMProp(false)  ← 隐藏手持道具
    ↓
For Each (Effect Container) → RemoveGEFromOwnerWithHandle
    ↓
Array Clear
```

> [!NOTE]
> **双重结束机制**：GA_Aim 可通过两种方式结束：
> 1. 玩家松开右键（Wait Input Release）
> 2. 投掷完成后收到 `Gameplay.Event.Aim.End` 事件（由 GA_Throw 发送）

### ShowSMProp(IsShow) 函数

```
Has Authority?
    └─ True ↓
Get Avatar Actor → Cast to BP_Character_Game
    ↓
GetComponentByClass (Comp_Character_Endurance)
    ↓
Call Multicast_ShowPropInHand(IsShow)
```

### 待实现

- [x] Wait Input Release 节点 ✅
- [x] 手持道具显示 (PropMesh via Multicast) ✅
- [ ] 预测线（Spline Mesh）

---

## GA_Throw（投掷能力）

**路径**：`Content/0_/Level/1_Endurance/GAS/GA/GA_Throw`

### 标签配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Throwing` |
| **激活所需标签** | `Player.Action.Aiming` |
| 激活阻止标签 | `Player.Action.Throwing` |

### 高级配置

| 配置项 | 值 |
|--------|-----|
| 网络执行策略 | 服务器已启动 |
| 实例化策略 | 每个 Actor 实例化 |
| 重新触发实例化能力 | ✅ |

### 变量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| ConfigAsset | DA_ItemSystemConfig | 数据资产引用 |
| Effect Container | Array\<Handle\> | GE Handle 缓存 |
| ThrowItemID | DataTableRowHandle | 缓存的道具 ID |
| ThrowItem | BP_Item_Base | 生成的道具引用 |

### 事件图表

```
Event ActivateAbility
    ↓
Cast to BP_Character_Game → GetThrowItemID → SET ThrowItemID
    ↓
CommitAbility → Apply Effect Container (ThrowEffectContainer) → SET Effect Container
    ↓
PlayMontageAndWaitForEvent (Anim_Throw_Montage)
    │
    ├─【Event Received】(Gameplay.Event.Montage.Throw)
    │       ↓
    │   Switch Has Authority
    │       ↓ Authority
    │   SpawnAndThrow → End Ability
    │
    ├─【On Cancelled】 → End Ability
    │
    └─【On Interrupted】 → End Ability

---
Event OnEndAbility
    ↓
SendGameplayEventToActor (Gameplay.Event.Aim.End)  ← 通知 GA_Aim 结束
    ↓
For Each (Effect Container) → RemoveGEFromOwnerWithHandle
    ↓
Array Clear
```

### SpawnAndThrow 函数

```
SpawnAndThrow
    ↓
SpawnItem() → SET ThrowItem
    ↓
ThrowItem.ProjectileMovement.Velocity = GetVel()
    ↓
ClearThrowItemID
```

**辅助函数**：

| 函数 | 返回类型 | 逻辑 |
|------|----------|------|
| `SpawnItem` | BP_Item_Base | Spawn at Socket_Throw, InitialState=Flying |
| `GetVel` | Vector | LaunchForce × Normalize(Forward×0.7 + Up×0.3) |

### 待实现

- [x] 动画蓝图 Layered Blend Per Bone ✅
- [x] InitialState 枚举控制状态机 ✅
- [x] 投掷后结束瞄准（通过事件通知）✅
- [x] 网络同步测试 ✅
- [ ] 投掷过渡蒙太奇（暂定）
- [ ] OnHit 子类实现（Banana/Bomb）

---

## GE 配置

### GE_Aiming

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA_Aim 手动移除） |
| Granted Tags | `Player.Action.Aiming` |
| 用途 | AnimBP 检测瞄准姿态 |

### GE_Aiming_Danger

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 0.25s（自动过期） |
| Granted Tags | `Player.State.Danger` |
| 用途 | 瞄准动作的短暂危险期（红灯检测用） |

### GE_Throwing

| 配置项 | 值 |
|--------|-----|
| 持续时间 | 无限（由 GA_Throw 手动移除） |
| Granted Tags | `Player.Action.Throwing`, `Player.State.Danger` |
| 用途 | 投掷动作期间的危险状态 |

---

## 动画蓝图集成 (ABP_Character)

### 变量

| 变量名 | 类型 | 用途 |
|--------|------|------|
| bIsAiming | Boolean | 瞄准状态标记 |

### Event Graph

```
Event Blueprint Update Animation
    ↓
Get Ability System Component
    ↓
Has Matching Gameplay Tag (Player.Action.Aiming)
    ↓
SET bIsAiming
```

### AnimGraph 配置

```
Main States (Cache)
    ↓
Slot 'DefaultSlot' ──────┐
                         ↓ (Base)
                    Layered Blend Per Bone  ←── [Weight: bIsAiming (Smoothed)]
                         ↑ (Blend Pose 0)
Anim_Aim (Seq) ────→ Slot 'UpperBody'
```

**Layered Blend Per Bone 设置**：

| 配置项 | 值 |
|--------|-----|
| Branch Filter | `spine_01` |
| Blend Depth | 1 |
| Mesh Space Rotation Blend | ✅ |

**平滑处理**：使用 `FInterpTo` 对 bIsAiming 进行插值（Interp Speed ≈ 10）

---

## 输入绑定

| Input Action | 按键 | 触发器 | 说明 |
|--------------|------|--------|------|
| IA_Endurance_Aim | 鼠标右键 | 已按下 | 瞄准（按住维持，松开取消） |
| IA_Endurance_Throw | 鼠标左键 | 已按下 | 投掷（需瞄准状态） |

---

## 相关文档

- [道具系统.md](../道具系统.md)
- [DA_ItemSystemConfig.md](DA_ItemSystemConfig.md)
- [BP_Item_Base.md](../核心类/BP_Item_Base.md)
- [Comp_Character_Endurance.md](../核心类/Comp_Character_Endurance.md)
