# 关卡1 耐力之匣 (L_Endurance)

## 核心玩法

**红绿灯机制**
- 红灯：鬼转头监视，玩家必须静止，任何移动→死亡
- 绿灯：鬼背对，可自由移动
- 视线遮挡：躲在障碍物或其他玩家后面可规避检测

## 死亡条件

1. 红灯时被木偶"看到"处于危险状态
2. 游戏开始后一直呆在起点不出来（逼迫玩家前进）

## 开始/结束条件

**开始条件**：所有玩家加载完成，AI 填充空位

**结束条件**（满足任一）：
1. 限时结束（In Progress 阶段计时）
2. 终点前方没有"活人"了（玩家+AI 都到终点或死亡）
3. 真人玩家全部死亡（用户感知不到，后台判断）

## 玩家状态

| 安全状态 | 危险状态 |
|:---------|:-----------------------|
| 静止、被遮挡、**失衡** | 行走（包括蹲行）、奔跑、跳跃、**蹲下/起身过程**、推搡、闪避、投掷、摔倒、麻痹 |

## 玩家操作/技能

| 操作 | 说明 |
|:-----|:-----|
| 行走 | 普通移动 |
| 奔跑 | 加速移动（使用倍率实现） |
| 蹲行 | 低姿态，可利用遮挡 |
| 跳跃 | 跳跃 |
| 推搡 | 使目标失衡 |
| 闪避 | 躲避推搡 |
| 投掷 | 使用投掷道具 |
| 失衡 | 必须要QTE恢复，不然会摔倒 |
| 摔倒 | 摔倒包括摔倒+起身 |
| 麻痹 | 被炸弹击中，触电般抖动，算移动 |

## 特殊状态

| 状态 | 持续时间 | 是否算"移动" | 可中断 |
|:-----|:---------|:------------:|:------:|
| **1. 失衡** | 最长8秒 | ❌ **不算** | ✅ QTE成功可结束 |
| **2. 摔倒** | 约3秒 | ✅ **算移动** | ❌ 不可中断 |
| **3. 麻痹** | 约3秒 | ✅ **算移动** | ❌ 不可中断 |

- 什么时候会进入失衡： 被其他玩家推搡、被死亡惊吓、被香蕉皮作用
- 什么时候会摔倒： 失衡QTE失败、推人被闪避
- 什么时候会麻痹： 被炸弹击中

## 道具系统

所有的道具都是碰到就算拾取

### 投掷类（单槽位，新覆盖旧）

使用 **MOTS 插件** 实现投掷系统，关卡1 和关卡5 均使用此机制，部分逻辑相似。

**投掷流程**（两阶段）：
1. **瞄准阶段**：按住按键 → 显示投掷预测线 → 可调整方向
2. **抛出阶段**：松开按键 → 物体飞出

**危险状态**：瞄准和抛出阶段都算危险状态（红灯时会被判定死亡）

**道具状态**：Idle（场景中）→ Held（手持）→ Flying（飞行中）→ Triggered/Trap（触发/陷阱）

**持有规则**：
- 一次只能持有一个投掷道具
- 碰到新道具时覆盖旧道具
- 手持状态下不能拾取新道具

| 道具 | 命中玩家 | 落地 |
|:-----|:---------|:-----|
| 香蕉皮 | 失衡 | 变陷阱 |
| 炸弹 | 麻痹 | 范围爆炸 |

**动作互斥**（GAS Ability Tags）：
- 瞄准/投掷时：不能推搡、闪避、奔跑
- 被推搡/失衡时：打断瞄准状态

### Buff 类

再次拾取时间会被覆盖

| 道具 | 效果 |
|:-----|:-----|
| 跑鞋 | 加速 |
| 护盾 | 免疫一次伤害/失衡 |
| 磁铁 | 自动吸附金币 |

### 资源类

| 道具 | 说明 |
|:-----|:-----|
| 金币 | 积分 |

金币存在玩家的属性里面，跨关卡存在

## 场景

空旷的教室，前方巨型木偶监视，散落着桌椅

- 空旷场地，前方巨型木偶监视
- 障碍物随机分布（遮挡用，可用PCG）
- 道具随机刷新（可用PCG）

## 其他机制

- **死亡广播**：范围伤害，周围玩家失衡

---

## 技术设计要点

### 木偶视线检测

**架构设计**：木偶（表现层）与监视器（逻辑层）分离

| Actor | 职责 | 说明 |
|-------|------|------|
| BP_Puppet | 表现层 | 骨骼网格 + 动画，红绿灯切换时播放转身动画，发现玩家时播放 Anim_Detect_Face_Montage |
| BP_Monitor | 逻辑层 | 横跨场地的 Box Collision，Line Trace 检测玩家是否被遮挡 |

**BP_Puppet 动画素材**：详见 [BP_Puppet.md](核心类/BP_Puppet.md#动画资源)。

**BP_Monitor 检测逻辑**：
- 从玩家头部向 +X 方向发射 Line Trace
- 射线命中 BP_Monitor = 无遮挡 → 检查 Danger 标签
- 射线命中障碍物/其他玩家 = 有遮挡 → 安全
- 检测逻辑仅在 DS 执行

**检测时机**：
- 木偶转身完成后（HandleIsRedLightChange 延时触发）
- GS.IsDetecting = true 时 Monitor 开始定时检测

**击杀流程**：
```
红灯 → Puppet 转身 → Delay → GS.IsDetecting = true
    ↓
Monitor Line Trace → 命中 Monitor + Danger 标签
    ↓
Multicast_PlayerDetected → Puppet 播放 Anim_Detect_Face_Montage
    ↓
对玩家造成伤害 → HP 归零 → 淘汰
```

**好处**：
- 木偶动画和检测逻辑解耦，调试方便
- 视线遮挡机制自然实现（障碍物、玩家互相遮挡）
- 检测逻辑可复用到其他关卡

### 玩家状态判定

**Gameplay Tags 设计**（完整定义见 [GameplayTags.csv](../00-通用逻辑/GameplayTags.csv)）：

| 类型 | 标签 | 说明 |
|------|------|------|
| Action | Player.Action.Walking | 行走 |
| Action | Player.Action.Running | 奔跑 |
| Action | Player.Action.Crouching | 蹲行 |
| Action | Player.Action.Jumping | 跳跃 |
| Action | Player.Action.Pushing | 推搡 |
| Action | Player.Action.Dodging | 闪避 |
| Action | Player.Action.Aiming | 瞄准 |
| Action | Player.Action.Throwing | 投掷 |
| State | Player.State.Danger | 危险状态 |
| State | Player.State.Staggered | 失衡 |
| State | Player.State.Fallen | 摔倒 |
| State | Player.State.Paralyzed | 麻痹 |
| State | Player.State.Exhausted | 力竭 |
| State | Player.State.Invincible | 免伤 |

**危险状态映射**：
- 行走、奔跑、蹲行、跳跃、推搡、闪避、瞄准、投掷 → GE 添加 `Player.State.Danger`
- 蹲下/起身过程（0.2秒） → Comp_Character_Endurance.HandleCrouching 临时应用 GE_Moving
- 摔倒、麻痹 → GE 添加 `Player.State.Danger`
- 失衡 → **不添加** Danger（安全状态）

木偶检测到玩家后，检查是否有 `Player.State.Danger` 标签

### 体力机制（关卡1、5 专属）

详见 [GAS/体力系统.md](GAS/体力系统.md)

- 使用 `BAS_Core` 中的 Stamina/MaxStamina 属性
- 奔跑：持续消耗（GE_StaminaDrain_Sprint）
- 跳跃：按次消耗
- 推搡/闪避：按次消耗
- 自动回复：非奔跑时生效（GE_StaminaRegen）
- 力竭：体力耗尽时阻止奔跑（GE_Exhausted）

**注意**：其他关卡（2、3、4）奔跑、跳跃不消耗体力。

### 动作互斥

- 使用 GAS 的 **Ability Tags** 机制（Block/Cancel）
- 示例：推搡时不能闪避，失衡时不能再次失衡

### 道具状态管理

- 使用 **MOTS 插件** 实现投掷系统
- 道具状态：Idle → Held → Flying → Triggered/Trap
- 投掷作为 GAS Ability，与其他技能统一管理互斥关系

### 关卡专属类

| 类 | 用途 | 实现状态 | 详细文档 |
|----|------|----------|----------|
| GM_Endurance | 关卡1 GameMode | ✅ 已配置 | [GM_Endurance.md](核心类/GM_Endurance.md) |
| GS_Endurance | 关卡1 GameState | ✅ 已实现 | [GS_Endurance.md](核心类/GS_Endurance.md) |
| ST_Endurance | 关卡1 子状态树（红绿灯切换） | ✅ 已实现 | [ST_Endurance.md](核心类/ST_Endurance.md) |
| Comp_Character_Endurance | 关卡1 操作组件（移动检测） | ✅ 已实现 | - |
| Comp_PC_Endurance | 关卡1 PC 组件（QTE/投票/交互） | ✅ 已完成添加步骤 | [Comp_PC_Endurance.md](核心类/Comp_PC_Endurance.md) |
| BP_Puppet | 木偶（表现层） | ✅ 已实现 | [BP_Puppet.md](核心类/BP_Puppet.md) |
| BP_Monitor | 监视器（逻辑层） | ✅ 已实现 | [BP_Monitor.md](核心类/BP_Monitor.md) |

| 类 | 用途 | 实现状态 | 详细文档 |
|----|------|----------|----------|
| WBP_Core_Main | 顶层 HUD 容器 | ✅ 框架已实现 | [UI/WBP_Core_Main.md](../00-通用逻辑/UI/WBP_Core_Main.md) |
| WBP_Core_Status | 状态面板（头像 + HP/Stamina/SpeedRate） | ✅ **已实现** | [UI/WBP_Core_Status.md](../00-通用逻辑/UI/WBP_Core_Status.md) |
| WBP_Core_Avatar | 动态头像组件 | ✅ **已实现** | [UI/WBP_Core_Avatar.md](../00-通用逻辑/UI/WBP_Core_Avatar.md) |
| Comp_UI_Core | 通用 UI 管理组件 | ✅ **已实现** | [UI/Comp_UI_Core.md](../00-通用逻辑/UI/Comp_UI_Core.md) |
| WBP_LevelHUD_Endurance | 关卡1 专属 HUD（QTE、道具栏） | ❌ 待实现 | [UI/README.md](UI/README.md) |

| BT_Endurance | 关卡1 AI 行为树 | ⚠️ 空壳已创建 | - |
| AbilitySet_Endurance | 关卡1 技能集 | ✅ 已配置（含 GA_Sprint） | - |
| IMC_Endurance | 关卡1 输入映射 | ✅ 已创建 | [输入映射.md](输入映射.md) |
| GA_Sprint | 奔跑技能 | ✅ 已实现 | - |
| GE_Sprint | 奔跑效果（SpeedRate × 1.5） | ✅ 已实现 | - |
| GE_Crouch | 蹲行效果（SpeedRate × 0.6 + Crouching 标签） | ✅ 已实现 | [蹲行系统](GAS/蹲行系统.md) |
| GA_Crouch | 蹲行技能（Toggle 模式） | ✅ 已实现 | [蹲行系统](GAS/蹲行系统.md) |
| GE_Moving | 移动状态 GE | ✅ 已实现 | - |
| GE_StaminaDrain_Sprint | 奔跑体力消耗 | ✅ 已实现 | [体力系统](GAS/体力系统.md) |
| GE_StaminaRegen | 体力自动回复 | ✅ 已实现 | [体力系统](GAS/体力系统.md) |
| GE_Exhausted | 力竭状态 | ✅ 已实现 | [体力系统](GAS/体力系统.md) |
| GA_Exhausted | 力竭时取消体力 Ability | ✅ 已实现 | [体力系统](GAS/体力系统.md) |
| GA_Jump | 跳跃技能 | ✅ 已实现 | [跳跃系统](GAS/跳跃系统.md) |
| GE_Jumping | 跳跃状态 GE | ✅ 已实现 | [跳跃系统](GAS/跳跃系统.md) |
| GE_StaminaCost | 通用体力消耗（SetByCaller） | ✅ 已实现 | [体力系统](GAS/体力系统.md) |
| GA_Push | 推搡技能 | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GE_Pushing | 推搡状态 GE | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GA_Stagger | 失衡技能 | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GE_Staggered | 失衡状态 GE | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GA_Fall | 摔倒技能 | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GE_Fallen | 摔倒状态 GE | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GA_Dodge | 闪避技能 | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GE_Dodging | 闪避状态 GE | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |
| GE_Invincible | 无敌状态 GE | ✅ 已实现 | [推搡系统](GAS/推搡系统.md) |

**注意**：不需要 AIC_Endurance，使用通用的 AIC_Core + BT_Endurance 即可。

> [!NOTE]
> **状态机重构计划**：`ST_Endurance` 及其他涉及「状态」「阶段」切换的流程和物体，计划使用 **Logic Driver Lite** 重构（经评估，Lite 版本已满足项目需求：基础 FSM、网络复制、嵌套状态机、Any State、事件驱动转换）。AI 行为（`BT_Endurance`）暂定继续使用 Behavior Tree。
