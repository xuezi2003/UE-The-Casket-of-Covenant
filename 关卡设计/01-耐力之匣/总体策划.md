# 关卡1 耐力之匣 (L_Endurance)

## 核心玩法

**红绿灯机制**
- 红灯：鬼转头监视，玩家必须静止，被检测到每次扣 34 HP
- 绿灯：鬼背对，可自由移动
- 视线遮挡：躲在障碍物或其他玩家后面可规避检测

## 淘汰条件

1. HP 归零（被木偶多次检测到、被炸弹击中等）
2. 游戏开始后一直呆在起点不出来（逼迫玩家前进）

## 开始/结束条件

**开始条件**：所有玩家加载完成，AI 填充空位

**关卡结束条件**（触发 InProgress → Settlement 阶段转换）：
1. **限时结束**：InProgress 阶段计时器到期
2. **无存活进行者**：未完成且未淘汰的玩家数量为 0（所有玩家都到达终点或被淘汰）

**游戏会话结束条件**（DS 关闭）：
- 所有真人玩家死亡或掉线（即使 AI 仍存活）
- 完成全部 5 个关卡后的最终结算

## 玩家状态

| 安全状态 | 危险状态 |
|:---------|:-----------------------|
| 静止、被遮挡、**失衡** | 行走（包括蹲行）、奔跑、跳跃、**蹲下/起身过程**、推搡、闪避、投掷、摔倒 |

## 玩家操作/技能

| 操作 | 说明 |
|:-----|:-----|
| 行走 | 普通移动 |
| 奔跑 | 加速移动（使用倍率实现） |
| 蹲行 | 低姿态，可利用遮挡 |
| 跳跃 | 跳跃 |
| 推搡 | 使目标失衡 |
| 闪避 | 躲避推搡 |
| 投掷 | 使用投掷道具 |
| 失衡 | 必须要QTE恢复，不然会摔倒 |
| 摔倒 | 摔倒包括摔倒+起身 |

## AI 行为

详见 [AI/BT_Endurance.md](AI/BT_Endurance.md)。

### AI 能力清单

**会做的**：
- 走走停停地移动到终点（80% 移动 200-300cm，20% 等待）
- 红灯时：原地不动(80%) / 往前偷偷动(20%)
- 绿灯时：推搡附近玩家(60%) / 闪避推搡(50%) / 移动到终点（Move To → Push）
- 碰撞拾取道具（被动）
- 失衡QTE判定（AISuccessRate = 0.5）

**不会做的**：
- 跳跃
- 蹲行
- 奔跑（已删除）
- 主动寻找道具
- 瞄准投掷
- 躲避到障碍物后面

## 特殊状态

| 状态 | 持续时间 | 是否算"移动" | 可中断 |
|:-----|:---------|:------------:|:------:|
| **1. 失衡** | 最长8秒 | ❌ **不算** | ✅ QTE成功可结束 |
| **2. 摔倒** | 5秒 | ✅ **算移动** | ❌ 不可中断 |

- 什么时候会进入失衡： 
  - **推搡/道具造成**：被其他玩家推搡、被香蕉皮/陷阱作用（播放踉跄蒙太奇）
  - **死亡广播造成**：被死亡惊吓（原地愣住，不播放蒙太奇）
- 什么时候会摔倒： 失衡QTE失败、推人被闪避、被炸弹击中

## 道具系统

详见 [道具系统.md](道具/道具系统.md)。

| 类型 | 道具 | 效果 |
|------|------|------|
| **投掷** | Banana、Bomb | 失衡/摔倒 |
| **Buff** | Lightning、Shield、MedicalKit | 加速/护盾/回血 |
| **资源** | Coin | 积分 |

## 场景

详见 [场景设计](./场景/场景设计.md) 与 [场景组件](./场景/场景组件.md)。

- 空旷场地，前方巨型木偶监视
- 障碍物随机分布（遮挡用，IA Scatter）
- 道具随机刷新（IA Scatter）

## 其他机制

- **死亡广播**：范围伤害，周围玩家失衡

---

## 技术设计要点

### 木偶视线检测

**架构设计**：木偶（表现层）与监视器（逻辑层）分离

| Actor | 职责 | 说明 |
|-------|------|------|
| BP_Puppet | 表现层 | 骨骼网格 + 动画，红绿灯切换时播放转身动画，发现玩家时播放 Anim_Detect_Face_Montage |
| BP_Monitor | 逻辑层 | 横跨场地的 Box Collision，Line Trace 检测玩家是否被遮挡 |

**BP_Puppet 动画素材**：详见 [BP_Puppet.md](场景/木偶与监视器/BP_Puppet.md#动画资源)。

**BP_Monitor 检测逻辑**：
- 从玩家头部向 +X 方向发射 Line Trace
- 射线命中 BP_Monitor = 无遮挡 → 检查 Danger 标签
- 射线命中障碍物/其他玩家 CharacterMesh = 有遮挡 → 安全
- 检测逻辑仅在 DS 执行

**检测时机**：
- 木偶转身完成后（HandleIsRedLightChange 延时触发）
- GS.IsDetecting = true 时 Monitor 开始定时检测

**击杀流程**：
```
红灯 → Puppet 转身 → Delay → GS.IsDetecting = true
    ↓
Monitor Line Trace → 命中 Monitor + Danger 标签
    ↓
Multicast_PlayerDetected → Puppet 播放 Anim_Detect_Face_Montage
    ↓
SendGameplayEventToActor → 触发 GA_Attacked
    ↓
GA_Attacked：Cooldown 检查 → Shield 抵消/扣血 (-34 HP)
    ↓
HP 归零 → 死亡广播 → 档案记录淘汰 → 关卡结束检查
```

**好处**：
- 木偶动画和检测逻辑解耦，调试方便
- 视线遮挡机制自然实现（障碍物、玩家互相遮挡）
- 检测逻辑可复用到其他关卡

### 玩家状态判定

**Gameplay Tags 设计**（完整定义见 [GameplayTags.csv](../00-通用逻辑/GameplayTags.csv)）：

| 类型 | 标签 | 说明 |
|------|------|------|
| Action | Player.Action.Walking | 行走 |
| Action | Player.Action.Running | 奔跑 |
| Action | Player.Action.Crouching | 蹲行 |
| Action | Player.Action.Jumping | 跳跃 |
| Action | Player.Action.Pushing | 推搡 |
| Action | Player.Action.Dodging | 闪避 |
| Action | Player.Action.Aiming | 瞄准 |
| Action | Player.Action.Throwing | 投掷 |
| State | Player.State.Danger | 危险状态 |
| State | Player.State.Staggered | 失衡 |
| State | Player.State.Fallen | 摔倒 |
| State | Player.State.Exhausted | 力竭 |
| State | Player.State.Invincible | 免伤 |

**危险状态映射**：
- 行走、奔跑、蹲行、跳跃、推搡、闪避、瞄准、投掷 → GE 添加 `Player.State.Danger`
- 蹲下/起身过程（0.2秒） → Comp_Character_Endurance.HandleCrouching 临时应用 GE_Moving
- 摔倒 → GE 添加 `Player.State.Danger`
- 失衡 → **不添加** Danger（安全状态）

木偶检测到玩家后，检查是否有 `Player.State.Danger` 标签

### 体力机制（关卡1、5 专属）

详见 [GAS/体力系统.md](GAS/体力系统.md)

- 使用 `BAS_Core` 中的 Stamina/MaxStamina 属性
- 奔跑：持续消耗（GE_StaminaDrain_Sprint）
- 跳跃：按次消耗
- 推搡/闪避：按次消耗
- 自动回复：非奔跑时生效（GE_StaminaRegen）
- 力竭：体力耗尽时阻止奔跑（GE_Exhausted）

**注意**：其他关卡（2、3、4）奔跑、跳跃不消耗体力。

### 动作互斥

- 使用 GAS 的 **Ability Tags** 机制（Block/Cancel）
- 示例：推搡时不能闪避，失衡时不能再次失衡

### 道具状态管理

- 道具状态：InField → (拾取销毁) | Flying → Trap/Destroy
- 投掷作为 GAS Ability，与其他技能统一管理互斥关系
- 详见 [道具系统.md](道具/道具系统.md)、[瞄准投掷系统.md](道具/瞄准投掷系统.md) 和 [BP_Item_Base.md](道具/BP_Item_Base.md)

---

## 开发阶段

| 阶段 | 内容 | 状态 |
|:----:|------|:----:|
| Phase 0 | 测试环境搭建 | ✅ |
| Phase 1 | 基础移动 + 玩家交互 | ✅ |
| Phase 1.5 | GA_Aim 集成 | ✅ |
| Phase 2 | 道具系统（投掷/Buff/金币） | ✅ |
| Phase 3 | 动作互斥（Ability Tags） | ✅ |
| Phase 4 | Logic Driver 重构（关卡流程状态机） | ✅ |
| Phase 5 | 场景搭建（IA Scatter + Modular Snap System） | ✅ |
| Phase 5.5 | 场景测试（组件验证/文档同步） | ✅ |
| Phase 6 | 伤害判定（扣血/淘汰/死亡广播/护盾抵消） | ✅ |
| Phase 6.5 | 动作互斥系统测试 | ✅ |
| Phase 7 | AI 行为（BT_Endurance） | ✅ 已完成 |
| Phase 8 | UI 完善（菜单/道具栏/Buff 倒计时） | ❌ |
| Phase 9 | 特效/音效（爆炸 VFX/Gameplay Cue） | ❌ |

