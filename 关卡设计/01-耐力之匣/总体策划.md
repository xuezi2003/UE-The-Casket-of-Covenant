# 关卡1 耐力之匣 (L_Endurance)

## 核心玩法

**红绿灯机制**
- 红灯：鬼转头监视，玩家必须静止，被检测到每次扣 34 HP
- 绿灯：鬼背对，可自由移动
- 视线遮挡：躲在障碍物或其他玩家后面可规避检测

## 淘汰条件

1. HP 归零（被木偶多次检测到、被炸弹击中等）
2. 游戏开始后一直呆在起点不出来（逼迫玩家前进）

## 开始/结束条件

**开始条件**：所有玩家加载完成，AI 填充空位

**结束条件**（满足任一）：
1. 限时结束（In Progress 阶段计时）
2. 终点前方没有"活人"了（玩家+AI 都到终点或死亡）
3. 真人玩家全部死亡（用户感知不到，后台判断）

## 玩家状态

| 安全状态 | 危险状态 |
|:---------|:-----------------------|
| 静止、被遮挡、**失衡** | 行走（包括蹲行）、奔跑、跳跃、**蹲下/起身过程**、推搡、闪避、投掷、摔倒 |

## 玩家操作/技能

| 操作 | 说明 |
|:-----|:-----|
| 行走 | 普通移动 |
| 奔跑 | 加速移动（使用倍率实现） |
| 蹲行 | 低姿态，可利用遮挡 |
| 跳跃 | 跳跃 |
| 推搡 | 使目标失衡 |
| 闪避 | 躲避推搡 |
| 投掷 | 使用投掷道具 |
| 失衡 | 必须要QTE恢复，不然会摔倒 |
| 摔倒 | 摔倒包括摔倒+起身 |

## 特殊状态

| 状态 | 持续时间 | 是否算"移动" | 可中断 |
|:-----|:---------|:------------:|:------:|
| **1. 失衡** | 最长8秒 | ❌ **不算** | ✅ QTE成功可结束 |
| **2. 摔倒** | 5秒 | ✅ **算移动** | ❌ 不可中断 |

- 什么时候会进入失衡： 被其他玩家推搡、被死亡惊吓、被香蕉皮作用
- 什么时候会摔倒： 失衡QTE失败、推人被闪避、被炸弹击中

## 道具系统

详见 [道具系统.md](道具/道具系统.md)。

| 类型 | 道具 | 效果 |
|------|------|------|
| **投掷** | Banana、Bomb | 失衡/摔倒 |
| **Buff** | Lightning、Shield、MedicalKit | 加速/护盾/回血 |
| **资源** | Coin | 积分 |

## 场景

详见 [场景设计](./场景/场景设计.md) 与 [场景组件](./场景/场景组件.md)。

- 空旷场地，前方巨型木偶监视
- 障碍物随机分布（遮挡用，IA Scatter）
- 道具随机刷新（IA Scatter）

## 其他机制

- **死亡广播**：范围伤害，周围玩家失衡

---

## 技术设计要点

### 木偶视线检测

**架构设计**：木偶（表现层）与监视器（逻辑层）分离

| Actor | 职责 | 说明 |
|-------|------|------|
| BP_Puppet | 表现层 | 骨骼网格 + 动画，红绿灯切换时播放转身动画，发现玩家时播放 Anim_Detect_Face_Montage |
| BP_Monitor | 逻辑层 | 横跨场地的 Box Collision，Line Trace 检测玩家是否被遮挡 |

**BP_Puppet 动画素材**：详见 [BP_Puppet.md](场景/木偶与监视器/BP_Puppet.md#动画资源)。

**BP_Monitor 检测逻辑**：
- 从玩家头部向 +X 方向发射 Line Trace
- 射线命中 BP_Monitor = 无遮挡 → 检查 Danger 标签
- 射线命中障碍物/其他玩家 = 有遮挡 → 安全
- 检测逻辑仅在 DS 执行

**检测时机**：
- 木偶转身完成后（HandleIsRedLightChange 延时触发）
- GS.IsDetecting = true 时 Monitor 开始定时检测

**击杀流程**：
```
红灯 → Puppet 转身 → Delay → GS.IsDetecting = true
    ↓
Monitor Line Trace → 命中 Monitor + Danger 标签
    ↓
Multicast_PlayerDetected → Puppet 播放 Anim_Detect_Face_Montage
    ↓
对玩家造成 34 点伤害（HP 归零 → 淘汰）
```

**好处**：
- 木偶动画和检测逻辑解耦，调试方便
- 视线遮挡机制自然实现（障碍物、玩家互相遮挡）
- 检测逻辑可复用到其他关卡

### 玩家状态判定

**Gameplay Tags 设计**（完整定义见 [GameplayTags.csv](../00-通用逻辑/GameplayTags.csv)）：

| 类型 | 标签 | 说明 |
|------|------|------|
| Action | Player.Action.Walking | 行走 |
| Action | Player.Action.Running | 奔跑 |
| Action | Player.Action.Crouching | 蹲行 |
| Action | Player.Action.Jumping | 跳跃 |
| Action | Player.Action.Pushing | 推搡 |
| Action | Player.Action.Dodging | 闪避 |
| Action | Player.Action.Aiming | 瞄准 |
| Action | Player.Action.Throwing | 投掷 |
| State | Player.State.Danger | 危险状态 |
| State | Player.State.Staggered | 失衡 |
| State | Player.State.Fallen | 摔倒 |
| State | Player.State.Exhausted | 力竭 |
| State | Player.State.Invincible | 免伤 |

**危险状态映射**：
- 行走、奔跑、蹲行、跳跃、推搡、闪避、瞄准、投掷 → GE 添加 `Player.State.Danger`
- 蹲下/起身过程（0.2秒） → Comp_Character_Endurance.HandleCrouching 临时应用 GE_Moving
- 摔倒 → GE 添加 `Player.State.Danger`
- 失衡 → **不添加** Danger（安全状态）

木偶检测到玩家后，检查是否有 `Player.State.Danger` 标签

### 体力机制（关卡1、5 专属）

详见 [GAS/体力系统.md](GAS/体力系统.md)

- 使用 `BAS_Core` 中的 Stamina/MaxStamina 属性
- 奔跑：持续消耗（GE_StaminaDrain_Sprint）
- 跳跃：按次消耗
- 推搡/闪避：按次消耗
- 自动回复：非奔跑时生效（GE_StaminaRegen）
- 力竭：体力耗尽时阻止奔跑（GE_Exhausted）

**注意**：其他关卡（2、3、4）奔跑、跳跃不消耗体力。

### 动作互斥

- 使用 GAS 的 **Ability Tags** 机制（Block/Cancel）
- 示例：推搡时不能闪避，失衡时不能再次失衡

### 道具状态管理

- 道具状态：InField → (拾取销毁) | Flying → Trap/Destroy
- 投掷作为 GAS Ability，与其他技能统一管理互斥关系
- 详见 [道具系统.md](道具/道具系统.md)、[瞄准投掷系统.md](道具/瞄准投掷系统.md) 和 [BP_Item_Base.md](道具/BP_Item_Base.md)

### 关卡资产清单

| 类别 | 资产 / 类名 | 用途 | 实现状态 | 详细文档 |
|:----:|------------|------|:--------:|----------|
| **架构** | GM_Endurance | 关卡1 GameMode | ✅ 已实现 | [GM_Endurance.md](架构/GM_Endurance.md) |
| **架构** | GS_Endurance | 关卡1 GameState | ✅ 已实现 | [GS_Endurance.md](架构/GS_Endurance.md) |
| **架构** | SM_Endurance | 子状态机（红绿灯） | ✅ 已实现 | [SM_Endurance.md](架构/SM_Endurance.md) |
| **组件** | Comp_Character_Endurance | 移动检测/体力管理 | ✅ 已实现 | [Comp_Character_Endurance.md](架构/Comp_Character_Endurance.md) |
| **组件** | Comp_PC_Endurance | QTE/投票/交互 | ✅ 已实现 | [Comp_PC_Endurance.md](架构/Comp_PC_Endurance.md) |
| **角色** | BP_Puppet | 木偶（表现层） | ✅ 已实现 | [BP_Puppet.md](场景/木偶与监视器/BP_Puppet.md) |
| **角色** | BP_Monitor | 监视器（逻辑层） | ⏳ 部分实现 | [BP_Monitor.md](场景/木偶与监视器/BP_Monitor.md) |
| **结构** | BP_Section_Wall | 场地侧墙 | ✅ 已实现 | [BP_Section_Wall.md](场景/结构组件/BP_Section_Wall.md) |
| **结构** | BP_Section_Pillar | 场地边缘柱子 | ✅ 已实现 | [BP_Section_Pillar.md](场景/结构组件/BP_Section_Pillar.md) |
| **结构** | BP_Section_Floor | 场地地板 | ✅ 已实现 | [BP_Section_Floor.md](场景/结构组件/BP_Section_Floor.md) |
| **结构** | BP_Section_Ceil | 场地天花板 | ✅ 已实现 | [BP_Section_Ceil.md](场景/结构组件/BP_Section_Ceil.md) |
| **结构** | BP_Section_Start | 起点封闭墙 | ✅ 已完成 | [BP_Section_Start.md](场景/结构组件/BP_Section_Start.md) |
| **结构** | BP_Section_End | 终点封闭墙 | ✅ 已完成 | [BP_Section_End.md](场景/结构组件/BP_Section_End.md) |
| **功能** | BP_VideoBoard | 终点视频黑板 | ⏳ 待测试 | [BP_VideoBoard.md](场景/功能组件/BP_VideoBoard.md) |
| **功能** | BP_StartLine | 起点线触发器 | ✅ 已实现 | [BP_StartLine.md](场景/功能组件/BP_StartLine.md) |
| **功能** | BP_FinishLine | 终点线触发器 | ✅ 已实现 | [BP_FinishLine.md](场景/功能组件/BP_FinishLine.md) |
| **功能** | BP_BornVol | 出生体积 | ✅ 已实现 | [BP_BornVol.md](场景/功能组件/BP_BornVol.md) |
| **装饰** | BP_BlackboardWall | 黑板墙管理器 | ✅ 已实现 | [BP_BlackboardWall.md](场景/装饰组件/BP_BlackboardWall.md) |
| **装饰** | BP_Camera | 监控摄像头 | ✅ 已实现 | [BP_Camera.md](场景/装饰组件/BP_Camera.md) |
| **装饰** | BP_Obstacle | 障碍物（桌椅） | ✅ 已实现 | [BP_Obstacle.md](场景/装饰组件/BP_Obstacle.md) |
| **UI** | WBP_Core_Status | 状态面板（HP/Stamina） | ✅ 已实现 | [UI/WBP_Core_Status.md](../00-通用逻辑/UI/WBP_Core_Status.md) |
| **UI** | WBP_LevelHUD_Endurance | 关卡1 专属 HUD | ❌ 待实现 | [UI/README.md](UI/README.md) |
| **技能** | GA_Sprint / GE_Sprint | 奔跑系统 | ✅ 已实现 | - |
| **技能** | GA_Crouch / GE_Crouch | 蹲行系统 | ✅ 已实现 | [GAS/蹲行系统.md](GAS/蹲行系统.md) |
| **技能** | GA_Jump / GA_Push | 跳跃 / 推搡 | ✅ 已实现 | [GAS/跳跃系统.md](GAS/跳跃系统.md) / [推搡系统.md](GAS/推搡系统.md) |
| **技能** | GA_Stagger / GA_Fall | 失衡 / 摔倒 | ✅ 已实现 | [GAS/推搡系统.md](GAS/推搡系统.md) |
| **技能** | GA_Dodge / GE_Invincible | 闪避 / 无敌 | ✅ 已实现 | [GAS/推搡系统.md](GAS/推搡系统.md) |
| **数据** | Set_Endurance | 技能集配置 | ✅ 已实现 | - |
| **数据** | IMC_Endurance | 输入映射 | ✅ 已实现 | [输入映射.md](输入映射.md) |

**注意**：不需要 AIC_Endurance，使用通用的 AIC_Core + BT_Endurance 即可。

> [!NOTE]
> **状态机架构**：`SM_Endurance` 及其他涉及「状态」「阶段」切换的流程和物体，使用 [Logic Driver Lite](../../../参考文档/Plugins/Logic Driver Lite API 参考.md) 状态机。AI 行为（`BT_Endurance`）继续使用 Behavior Tree。

---

## 开发阶段

> 详细待办见 [待办文档/](../../待办文档/) 目录

| 阶段 | 内容 | 状态 |
|:----:|------|:----:|
| Phase 0 | 测试环境搭建 | ✅ |
| Phase 1 | 基础移动 + 玩家交互 | ✅ |
| Phase 1.5 | GA_Aim 集成 | ✅ |
| Phase 2 | 道具系统（投掷/Buff/金币） | ✅ |
| Phase 3 | 动作互斥（Ability Tags） | ✅ |
| Phase 4 | Logic Driver 重构（关卡流程状态机） | ✅ |
| Phase 5 | 场景搭建（IA Scatter + Modular Snap System） | ✅ |
| Phase 5.5 | 场景测试（组件验证/文档同步） | 🔄 |
| Phase 6 | 伤害判定（扣血/淘汰/死亡广播/Shield 检测减半） | ❌ |
| Phase 6.5 | 动作互斥系统测试 | ❌ |
| Phase 7 | AI 行为（BT_Endurance） | ❌ |
| Phase 8 | UI 完善（菜单/道具栏/Buff 倒计时） | ❌ |
| Phase 9 | 特效/音效（爆炸 VFX/Gameplay Cue） | ❌ |

