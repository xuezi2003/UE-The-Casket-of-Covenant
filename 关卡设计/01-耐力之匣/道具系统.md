# 道具系统

> 关卡1（耐力之匣）道具系统设计

---

## 持有规则

| 类型 | 规则 |
|------|------|
| **投掷类** | 最多 **1 个**，后捡覆盖 |
| **Buff 类** | 可同时 **多种**，同种重复 **重置时间** |
| **资源类** | 拾取即生效 |

---

## 道具总览

| 类型 | 道具 | 效果 | 模型 |
|------|------|------|------|
| 投掷 | Banana | 命中失衡，落地变陷阱（触发一次销毁） | Show + Prop |
| 投掷 | Bomb | 范围摔倒 | Show + Prop |
| Buff | Lightning | SpeedRate ×1.5（与 Sprint 叠加） | 仅 Show |
| Buff | Shield | 抵消任意攻击 / 检测伤害减半 | 仅 Show |
| Buff | MedicalKit | HP +50 | 仅 Show |
| 资源 | Coin | 积分 +1 | 仅 Show |

**资源路径**：`Content/0_/Resource/Mesh/Prop_Endurance/`

---

### BP_Item_Base 架构

> [!NOTE]
> 详细组件结构、变量定义及函数实现请参考：[BP_Item_Base 实现文档](核心类/BP_Item_Base.md)

#### 状态机（Logic Driver Lite）✅

详细配置及状态实现见 [BP_Item_Base.md](核心类/BP_Item_Base.md#状态机-logic-driver-lite)。

> [!IMPORTANT]
> **无 Held 状态**：拾取后 BP_Item 销毁，只存储 ItemID 到角色。瞄准时由 GA_Aim 直接显示 PropMesh，投掷时 Spawn 新 BP_Item（初始状态 = Flying）。

### 数据结构 (S_ItemData) ✅

**路径**：`Content/0_/Blueprints/Structs/S_ItemData`

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| Name | Text | - | 道具名称 |
| Icon | Texture2D | - | UI 图标 |
| ShowMesh | Static Mesh | - | 场地展示模型 |
| PropMesh | Static Mesh | None | 手持模型（Buff/Resource 为 None） |
| ItemType | EItemType | Throwable | 逻辑类型 |
| LaunchForce | Float | 1500.0 | 投掷力度（仅 Throwable 用） |
| ItemAbility | GA Class | None | 拾取时触发的 GA（Buff/Resource 用） |

### 数据表 (DT_ItemData) ⏳

> **当前进度**：Mesh 数据已填充，Icon 和 ItemAbility 待后续补充

**路径**：`Content/0_/DataTables/DT_ItemData`

**行结构**：S_ItemData

| RowName | Name | ShowMesh | PropMesh | Type | LaunchForce | ItemAbility |
|---------|------|----------|----------|------|-------------|-------------|
| Banana | 香蕉皮 | Banana_Peel_Show | Banana_Peel_Prop | Throwable | 1500 | None |
| Bomb | 炸弹 | Bomb_Show | Bomb_Prop | Throwable | 1200 | None |
| Lightning | 闪电 | Lightning_Show | None | Buff | - | GA_Item_Lightning |
| Shield | 护盾 | Shield_Show | None | Buff | - | GA_Item_Shield |
| MedicalKit | 急救包 | MedicalKit_Show | None | Buff | - | GA_Item_MedicalKit |
| Coin | 金币 | Coin_Show | None | Resource | - | GA_Item_Coin |

**资源路径**：`Content/0_/Resource/Mesh/Prop_Endurance/<ItemName>/SM/`

详细检测逻辑见 [BP_Item_Base.md](核心类/BP_Item_Base.md#双框检测实现-✅)。

---

## 瞄准系统 (GA_Aim) ✅ 主要逻辑已完成，未测试

> [!NOTE]
> **输入设计**：按住右键瞄准，松开取消；瞄准中按左键投掷。

**路径**：`Content/0_/Level/1_Endurance/GAS/GA/GA_Aim`

### 高级配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Aiming` |
| 激活阻止标签 | `Player.Action.Aiming`, `Player.Action.Throwing` |
| 网络执行策略 | 本地预测 |

### 变量

| 变量 | 类型 | 说明 |
|------|------|------|
| ConfigAsset | DA_ItemSystemConfig | 数据资产引用 |
| Effect Container | Array\<Handle\> | GE Handle 缓存 |

### 事件图表 ✅

```
Event ActivateAbility
    ↓
Check Have Throwable (宏)
    └─ Call GetThrowItemID → Is Valid?
    ├─ False → End Ability
    └─ True ↓
CommitAbility → Apply Effect Container (AimEffectContainer) → SET Effect Container
    ↓
Wait Input Release (IA_Endurance_Aim)
    ↓ On Release
End Ability

---
Event OnEndAbility
    ↓
For Each (Effect Container) → RemoveGEFromOwnerWithHandle
    ↓
Array Clear
```

### 待实现

- [x] Wait Input Release 节点 ✅
- [ ] 预测线（Spline Mesh）

---

## 动画蓝图集成 (ABP_Character) ✅

### 变量与逻辑 (Event Graph)

1.  **变量**: 新增 `bIsAiming` (Boolean).
2.  **更新逻辑 (Event Blueprint Update Animation)**:
    *   获取 `AbilitySystemComponent` (通常从 Owner 获取).
    *   调用 `HasMatchingGameplayTag`.
    *   Tag: `Player.Action.Aiming`.
    *   将结果赋值给 `bIsAiming`.

### AnimGraph 配置

**结构**:
*   **Base Pose**: `Main States` (缓存姿态) -> `DefaultSlot`.
*   **Blend Pose 0**: `Anim_Aim` (Sequence Player, 循环) -> `UpperBody` (Slot).
*   **Blend Weights 0**: 绑定 `bIsAiming` (Bool -> Float)。
*   **平滑处理**: 在 Update 中使用 `FInterpTo` 对 float 变量进行插值 (Interp Speed ≈ 10)，实现平滑举手/放下效果。

```
Main States (Cache)
    ↓
Slot 'DefaultSlot' ──────┐
                         ↓ (Base)
                    Layered Blend Per Bone  ←── [Weight: bIsAiming (Smoothed)]
                         ↑ (Blend Pose 0)
Anim_Aim (Seq) ────→ Slot 'UpperBody'
```

3.  **GE 配置 (Gameplay Effect)**:
    *   **GE_Aiming** (Duration: Infinite / by GA):
    *   **Granted Tags**: 添加 `Player.Action.Aiming` 和 `Player.State.Danger`。
    *   **注**: `Player.Action.Aiming` 用于 AnimBP 检测瞄准姿态；`Player.State.Danger` 用于木偶检测。

**Layered Blend Per Bone 设置**:

| 配置项 | 值 |
|--------|-----|
| Branch Filter | `spine_01` (或更高节点) |
| Blend Depth | 1 |
| Mesh Space Rotation Blend | ✅ |

---

## 投掷系统 (GA_Throw) ✅ 主要逻辑已完成，未测试

**路径**：`Content/0_/Level/1_Endurance/GAS/GA/GA_Throw`

### 高级配置

| 配置项 | 值 |
|--------|-----|
| 资产标签 | `Player.Action.Throwing` |
| **激活所需标签** | `Player.Action.Aiming` |
| 激活阻止标签 | `Player.Action.Throwing` |
| 网络执行策略 | 服务器已启动 |

### 变量

| 变量 | 类型 | 说明 |
|------|------|------|
| ConfigAsset | DA_ItemSystemConfig | 数据资产引用 |
| Effect Container | Array\<Handle\> | GE Handle 缓存 |
| ThrowItemID | DataTableRowHandle | 缓存的道具 ID |
| ThrowItem | BP_Item_Base | 生成的道具引用 |

### 事件图表 ✅

```
Event ActivateAbility
    ↓
Cast to BP_Character_Game → Call GetThrowItemID → SET ThrowItemID
    ↓
CommitAbility → Apply Effect Container (ThrowEffectContainer)
    ↓
PlayMontageAndWaitForEvent (Anim_Throw_Montage)
    │
    ├─【Event Received】(Gameplay.Event.Montage.Throw)
    │       ↓
    │   Switch Has Authority
    │       ↓ Authority
    │   SpawnAndThrow 函数：
    │       → Spawn Actor at Socket_Throw (ItemID Expose on Spawn)
    │       → SET ThrowItem
    │       → ThrowItem.PropMesh.AddImpulse((Forward + Up) × LaunchForce × 0.7, bVelChange=true)
    │       → Call ClearThrowItemID (Server)
    │
    ├─【Completed/Blend Out】 → End Ability
    │
    └─【Cancelled/Interrupted】 → End Ability
```

### 待实现

- [x] 动画蓝图 Layered Blend Per Bone ✅
- [ ] OnHit 子类实现（Banana/Bomb）
- [ ] 网络同步测试

---

## 护盾机制 (Shield)

**GE_Buff_Shield**：添加 `Player.State.Shielded`，Duration 30s

| 场景 | 行为 | 实现状态 |
|------|------|:--------:|
| 被推搡 | 抵消，消耗护盾 | ❌ |
| 被炸弹 | 抵消，消耗护盾 | ❌ |
| 被检测 | 伤害减半，消耗护盾 | ❌ |
| 受惊吓 | 抵消，消耗护盾 | ❌ |

---

## Buff 效果

| 道具 | GE | 效果 | 实现状态 |
|------|-----|------|:--------:|
| Lightning | GE_Buff_Lightning | SpeedRate ×1.5 | ❌ |
| Shield | GE_Buff_Shield | Shielded 标签 | ❌ |
| MedicalKit | GE_Buff_MedicalKit | HP +50 | ❌ |

---

## UI 预留

| 元素 | 事件源 | 实现状态 |
|------|--------|:--------:|
| 道具栏 | `Comp_Character_Endurance.OnThrowItemChanged` | ❌ |
| Buff 倒计时 | `OnGameplayEffectTimeChange` | ❌ |
| 准星 | GA_Aim | ❌ |

---

## 通用接口

> [!IMPORTANT]
> 统一的函数/事件，兼容玩家（GA）和 AI（行为树）。

| 接口 | 位置 | 说明 | 状态 |
|------|------|------|:----:|
| `OnPickup(Character)` | BP_Item_Base | 拾取（存 ItemID 到角色，销毁） | ✅ |
| `OnTrap(Character)` | BP_Item_Base | 陷阱触发（虚函数，子类重写） | ✅ |
| `GetThrowItemID()` | Comp_Character_Endurance | 获取持有道具 ID | ✅ |
| `SetThrowItemID(ItemID)` | Comp_Character_Endurance | 设置持有道具 ID | ✅ |
| `ClearThrowItemID()` | Comp_Character_Endurance | 清除持有道具 | ✅ |

---

## Gameplay Cue 预留 (Phase 9)

| Cue Tag | 特效 | 状态 |
|---------|------|:----:|
| `GameplayCue.Buff.Lightning` | 加速拖尾 | ❌ |
| `GameplayCue.Buff.Shield` | 护盾光环 | ❌ |
| `GameplayCue.Item.Bomb.Explode` | 爆炸 VFX/SFX | ❌ |

---

## 相关文档

- [BP_Item_Base.md](核心类/BP_Item_Base.md)
- [总体策划.md](总体策划.md)
- [输入映射.md](输入映射.md)
- [推搡系统.md](GAS/推搡系统.md)

