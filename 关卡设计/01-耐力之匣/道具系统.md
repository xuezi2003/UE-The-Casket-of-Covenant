# 道具系统

> 关卡1（耐力之匣）道具系统设计

---

## 持有规则

| 类型 | 规则 |
|------|------|
| **投掷类** | 最多 **1 个**，后捡覆盖 |
| **Buff 类** | 可同时 **多种**，同种重复 **重置时间** |
| **资源类** | 拾取即生效 |

---

## 道具总览

| 类型 | 道具 | 效果 | 模型 |
|------|------|------|------|
| 投掷 | Banana | 命中失衡，落地变陷阱（永久） | Show + Prop |
| 投掷 | Bomb | 范围摔倒 | Show + Prop |
| Buff | Lightning | SpeedRate ×1.5（与 Sprint 叠加） | 仅 Show |
| Buff | Shield | 抵消任意攻击 / 检测伤害减半 | 仅 Show |
| Buff | MedicalKit | HP +50 | 仅 Show |
| 资源 | Coin | 积分 +1 | 仅 Show |

**资源路径**：`Content/0_/Resource/Mesh/Prop_Endurance/`

---

## BP_Item_Base 架构

### 组件结构

```
BP_Item_Base (Actor)
├── Root (Scene)
├── ShowMesh (Static Mesh) ← 场地状态，大模型
├── PropMesh (Static Mesh) ← 手持状态，小模型（默认隐藏）
├── DetectionBox (Sphere, 半径 200) ← 高亮提示
└── PickupBox (Sphere, 半径 50) ← 触发拾取
```

### 状态机（Logic Driver Lite）

| 状态 | Mesh | 逻辑 | 实现状态 |
|------|------|------|:--------:|
| InField | ShowMesh | 启用双框检测 | ❌ |
| Held | PropMesh | Attach 到 hand_r，禁用碰撞 | ❌ |
| Flying | PropMesh | Physics + Impulse | ❌ |
| Triggered | - | 执行效果后销毁/重生 | ❌ |

### 变量

| 变量 | 类型 | 说明 |
|------|------|------|
| ItemType | Enum | Throwable / Buff / Resource |
| ItemIcon | Texture2D | UI 图标 |
| LaunchForce | Float | 投掷力度（默认 1500） |
| OwnerCharacter | Character | 持有者引用 |

### 事件/函数

| 名称 | 说明 |
|------|------|
| `OnPickup(Character)` | 拾取 → 状态切换到 Held |
| `OnUse(Character)` | 使用（投掷 / Apply GE） |
| `Launch(Direction, Force)` | 投掷 → 状态切换到 Flying |
| `SetHighlight(bool)` | 高亮控制 |
| `OnHeldItemChanged` | 事件分发器，通知 UI |

---

## 双框检测机制

```
DetectionBox (大)
    ↓ OnBeginOverlap
SetHighlight(true) ← 高亮显示

PickupBox (小)
    ↓ OnBeginOverlap
OnPickup(Character) ← 执行拾取
```

---

## 瞄准系统 (GA_Aim)

**玩家专用**，输入：鼠标右键按下

| 步骤 | 实现状态 |
|------|:--------:|
| Apply GE_Aiming (Danger 标签) | ❌ |
| 动画蓝图启用 Aim Offset | ❌ |
| 预测线 (Predict Projectile Path → Spline Mesh) | ❌ |

**松开右键**：隐藏预测线 → 移除 GE → 激活 GA_Throw

---

## 投掷系统 (GA_Throw)

**通用接口**，玩家/AI 均可调用

```
ActivateAbility
    ↓
检查 HeldItem → Apply GE_Throwing → PlayMontage
    ↓
AnimNotify → HeldItem.Launch()
    ↓
SET HeldItem = None → EndAbility
```

---

## 护盾机制 (Shield)

**GE_Buff_Shield**：添加 `Player.State.Shielded`，Duration 30s

| 场景 | 行为 | 实现状态 |
|------|------|:--------:|
| 被推搡 | 抵消，消耗护盾 | ❌ |
| 被炸弹 | 抵消，消耗护盾 | ❌ |
| 被检测 | 伤害减半，消耗护盾 | ❌ |
| 受惊吓 | 抵消，消耗护盾 | ❌ |

---

## Buff 效果

| 道具 | GE | 效果 | 实现状态 |
|------|-----|------|:--------:|
| Lightning | GE_Buff_Lightning | SpeedRate ×1.5 | ❌ |
| Shield | GE_Buff_Shield | Shielded 标签 | ❌ |
| MedicalKit | GE_Buff_MedicalKit | HP +50 | ❌ |

---

## UI 预留

| 元素 | 事件源 | 实现状态 |
|------|--------|:--------:|
| 道具栏 | `OnHeldItemChanged` | ❌ |
| Buff 倒计时 | `OnGameplayEffectTimeChange` | ❌ |
| 准星 | GA_Aim | ❌ |

---

## 通用接口

> [!IMPORTANT]
> 统一的函数/事件，兼容玩家（GA）和 AI（行为树）。

| 接口 | 位置 | 说明 |
|------|------|------|
| `OnPickup(Character)` | BP_Item | 拾取 |
| `OnUse(Character)` | BP_Item | 使用 |
| `GetHeldItem()` | Character | 获取持有道具 |
| `SetHeldItem(Item)` | Character | 设置持有道具 |
| `UseHeldItem()` | Character | 使用持有道具 |

---

## Gameplay Cue 预留 (Phase 9)

| Cue Tag | 特效 | 状态 |
|---------|------|:----:|
| `GameplayCue.Buff.Lightning` | 加速拖尾 | ❌ |
| `GameplayCue.Buff.Shield` | 护盾光环 | ❌ |
| `GameplayCue.Item.Bomb.Explode` | 爆炸 VFX/SFX | ❌ |

---

## 相关文档

- [总体策划.md](总体策划.md)
- [输入映射.md](输入映射.md)
- [推搡系统.md](GAS/推搡系统.md)
