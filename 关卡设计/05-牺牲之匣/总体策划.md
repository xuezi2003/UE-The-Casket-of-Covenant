# 关卡5 牺牲之匣 (L_Sacrifice)

## 核心玩法

**场景**: 高空悬空玻璃桥，由多对玻璃板组成（每排左右各一块）  
**视角**: 第三人称  
**核心体验**: 观察、测试、博弈  
**核心隐喻**: 牺牲——为了前进，可能需要牺牲别人或自己

**移动方式**: 跳跃通过玻璃桥（存在坠落到缝隙的风险）

---

## 玻璃板机制

### 玻璃类型

| 类型 | 承重 | 触发条件 | 玻璃状态 | 掉落人数 |
|:-----|:-----|:---------|:---------|:---------|
| **真玻璃** | ≤2人 | 第 3 人踏上 | 不破碎 | 随机 1 人（从 3 人中选） |
| **假玻璃** | 0人 | 任何人踏上 | 破碎消失 | 踏上的人 |

### "牺牲"的隐喻

- 如果 2 人已站在真玻璃上，第 3 人跳上去是冒险行为
- 有 1/3 概率自己被挤下去，2/3 概率把别人挤下去
- 为了前进，可能需要牺牲别人（或自己）

### 死亡机制

- 所有死亡情况（假玻璃破碎、真玻璃拥挤、失衡 QTE 失败、推搡掉落、跳跃失误）都归结为"坠落碰到死亡体积"
- 玻璃桥下方设置 Kill Volume，触发 `Gameplay.Event.Player.Eliminated`
- 死亡逻辑统一处理

---

## 观察系统

**分段式观察机制**——前半段可区分，后半段不可区分

**前半段（可区分）**:
- 真玻璃和假玻璃有视觉差异（光泽、折射率、厚度等）
- 使用 Volumetric Glass 插件实现差异化材质效果
- 奖励仔细观察的玩家，提供策略优势

**后半段（不可区分）**:
- 视觉差异消失或被干扰（如灯光变暗）
- 玩家只能依赖: 金币测试、观察他人、博弈推搡
- 强化"牺牲"主题的博弈感和紧张感

**设计意图**:
- 前半段: 技巧型玩家可通过观察获得优势
- 后半段: 所有人平等面对未知，加剧博弈和冲突
- 整体体验: 从"有技巧的观察"过渡到"纯粹的博弈与牺牲"

**设计灵感**: 参考《鱿鱼游戏》玻璃桥情节

---

## 金币测试

**机制**: 消耗金币投掷到玻璃上，通过声音判断真假

**金币来源**:
- 这是最后一关，金币来自前面关卡的积累
- 赋予金币跨关卡的战略意义

**声音反馈**:
- 所有玩家都能听到（3D 空间音效）
- 设计意图: 增加博弈深度——我花金币测试，别人也能白嫖信息（先动者劣势）
- 策略: 等别人先测试？还是抢先探路？

**投掷后处理**:
- 金币发出声音后直接消失

---

## 移动规则

- 自由移动，无固定顺序
- 玻璃碎了就是碎了（留下空隙）
- 玩家需要跳跃通过玻璃桥

---

## 玩家交互

### 推搡/失衡/闪避机制

- **参考关卡1的推搡系统**（失衡 → QTE），但不直接复用 GAS 能力
- 关卡5需要创建自己的 GAS 能力：GA_Sacrifice_Push、GA_Sacrifice_Stagger、GA_Sacrifice_Dodge、GA_Sacrifice_Jump
- 原因：关卡5的失衡后果、推搡限制等机制与关卡1不同

### 推搡限制

- **只有同一块玻璃上的玩家才能互相推搡**
- 推搡失败无提示，操作直接无效（保持紧张感）

### 失衡后果

| 阶段 | 关卡1（耐力之匣） | 关卡5（牺牲之匣） |
|------|------------------|------------------|
| 被推搡 | 进入失衡状态 | 进入失衡状态 |
| QTE 成功 | 恢复正常 | 恢复正常 |
| QTE 失败 | 摔倒（危险状态，可被救） | **直接掉落死亡** |

**设计意图**:
- 玻璃桥高空场景，没有"摔倒后还能爬起来"的余地
- 强化风险感: 每一次推搡都是生死博弈
- 简化机制: 不需要危险状态、救援等复杂逻辑

---

## 淘汰条件

1. 坠落碰到 Kill Volume（假玻璃破碎、真玻璃拥挤、失衡 QTE 失败、推搡掉落、跳跃失误）

---

## 开始/结束条件

**开始条件**: 所有玩家加载完成，AI 填充空位

**关卡结束条件**（触发 InProgress → Settlement 阶段转换）:
1. **限时结束**: InProgress 阶段计时器到期
2. **无存活进行者**: 未完成且未淘汰的玩家数量为 0（所有玩家都到达终点或被淘汰）

**游戏会话结束条件**（DS 关闭）:
- 所有真人玩家死亡或掉线（即使 AI 仍存活）
- 完成全部 5 个关卡后的最终结算

---

## 策略要素

- **观察**: 前半段通过视觉差异判断真假玻璃
- **测试**: 消耗金币测试前方玻璃，但所有人都能听到声音
- **推搡**: 把人推到未知玻璃上测试（生死博弈）
- **等待**: 等别人先测试？还是抢先探路？
- **合作与背叛**: 两人同站真玻璃安全，第三人加入触发拥挤机制

---

## 场景

**玻璃桥生成架构**（三层蓝图结构）:
```
BP_GlassBridge（玻璃桥生成器）
    ↓ 沿样条线生成多个
BP_GlassPair（双排玻璃板）
    ↓ 管理 2 块
BP_GlassPanel（单块玻璃板）
```

**设计思路**:
- 参考黑板墙生成器（BP_BlackboardWall），父 Actor 管理子 Actor
- 使用样条线支持任意形状，可视化编辑方便
- 层级清晰、扩展性强

**为什么不用 IA Scatter**: 多人游戏中存在局限性

---

## 与关卡1的差异

### 系统层面

| 系统 | 关卡1（耐力之匣） | 关卡5（牺牲之匣） | 设计意图 |
|------|------------------|------------------|---------|
| **HP系统** | ✅ 需要（木偶检测扣血、炸弹伤害） | ❌ 不需要（无伤害来源） | 简化机制，专注博弈 |
| **Stamina系统** | ✅ 需要（奔跑、跳跃消耗体力） | ❌ 不需要 | 简化机制，专注博弈 |
| **死亡触发** | HP归零 | 碰到Kill Volume | 统一死亡处理 |
| **道具系统** | 投掷道具（Banana、Bomb）+ Buff道具（Lightning、Shield、MedicalKit）+ 金币（积分） | 金币（测试玻璃） | 金币跨关卡战略意义 |
| **失衡后果** | QTE失败→摔倒（危险状态，可被救） | QTE失败→直接掉落死亡 | 强化风险感 |
| **推搡限制** | 无限制 | 只能推同一块玻璃上的人 | 增加策略深度 |

### 玩法模式

| 维度 | 关卡1（耐力之匣） | 关卡5（牺牲之匣） |
|------|------------------|------------------|
| **核心主题** | 耐力——持续压力下的生存 | 牺牲——博弈中的冒险与背叛 |
| **玩法节奏** | 持续压力（红绿灯循环） | 离散决策（观察→测试→跳跃） |
| **压力来源** | 木偶监视、体力管理、道具对抗 | 真假玻璃选择、拥挤机制、推搡博弈 |
| **策略深度** | 时机把握（红绿灯切换）、资源管理（体力、道具） | 信息博弈（观察、测试）、风险决策（跳跃、推搡） |

---

---

## 开发阶段

| 阶段 | 内容 | 核心类 | 状态 |
|:----:|------|--------|:----:|
| Phase 0 | 测试环境搭建 + 架构文档目录 | GM_Sacrifice, GS_Sacrifice | ✅ |
| Phase 1 | 核心类架构 | Comp_Character_Sacrifice, Comp_PC_Sacrifice, AbilitySet_Sacrifice, IMC_Sacrifice, SM_Sacrifice | ✅ 已完成 |
| Phase 2 | 玻璃桥生成系统 + 布局同步 | - | ❌ |
| Phase 3 | 玻璃承重逻辑（基础） | Comp_Character_Sacrifice（基础站立检测） | ❌ |
| Phase 3.5 | 拥挤机制 + 多人检测 | Comp_Character_Sacrifice（拥挤逻辑） | ❌ |
| Phase 3.6 | 观察系统（视觉差异 + 分段切换） | GS_Sacrifice, SM_Sacrifice | ❌ |
| Phase 4 | Kill Volume 死亡触发 + 深渊效果 | Comp_Character_Sacrifice（死亡处理） | ❌ |
| Phase 5 | 推搡系统集成（完整GAS） | Comp_Character_Sacrifice（推搡限制 + 失衡调整） | ❌ |
| Phase 6 | 金币测试系统（复用瞄准） | Comp_Character_Sacrifice, Comp_PC_Sacrifice, GA_ThrowCoin | ❌ |
| Phase 7 | 场景完善（MRI 主题） | - | ❌ |
| Phase 8 | AI 行为 | BT_Sacrifice, GM_Sacrifice（配置BT） | ❌ |
| Phase 9 | UI 完善 | Comp_PC_Sacrifice | ❌ |
| Phase 10 | 特效/音效 | - | ❌ |

### Phase 详细说明

#### Phase 0: 测试环境搭建 + 架构文档目录
- 创建 L_Dev_Sacrifice 测试地图
- 创建 GM_Sacrifice（继承 GM_Core）
- 创建 GS_Sacrifice（继承 GS_Core，配置 PreparingDuration、InProgressDuration）
- 基础出生点（BP_BornVol）、起点线（BP_StartLine）和终点（BP_FinishLine）
- **创建架构文档目录**：`05-牺牲之匣/架构/`（空文档，仿照关卡1）
  - GM_Sacrifice.md
  - GS_Sacrifice.md
  - Comp_Character_Sacrifice.md
  - Comp_PC_Sacrifice.md
  - SM_Sacrifice.md

#### Phase 1: 核心类架构
- 创建 Comp_Character_Sacrifice（继承 ActorComponent）
  - 实现 HandlePlayerStart（切换碰撞、应用GE_Start、赋予AbilitySet）
  - 实现 HandlePlayerFinish（应用GE_Finish、切换碰撞、清理AbilitySet）
- 创建 Comp_PC_Sacrifice（继承 ActorComponent）
- 创建 AbilitySet_Sacrifice（**Phase 1 暂时为空，Phase 5 再配置 GAS 能力**）
- 创建 IMC_Sacrifice（输入映射）
- 创建 SM_Sacrifice（子状态机）
  - FirstHalf 状态（前半段，视觉差异可见）
  - SecondHalf 状态（后半段，视觉差异消失）
  - LevelComplete 状态（结束状态）
- 在 GM_Sacrifice 中配置：
  - Level Ability Set = AbilitySet_Sacrifice
  - Level Character Component Class = Comp_Character_Sacrifice
  - Level PC Component Class = Comp_PC_Sacrifice
  - Level IMC = IMC_Sacrifice
  - Level Sub SM = SM_Sacrifice

> [!NOTE]
> **Phase 1 不包含 GAS 能力创建**：关卡5需要创建自己的 GAS 能力（参考关卡1），但 Phase 1 只创建架构，Phase 5 再创建 GA_Sacrifice_Push、GA_Sacrifice_Stagger、GA_Sacrifice_Dodge、GA_Sacrifice_Jump 等能力。

#### Phase 2: 玻璃桥生成系统 + 布局同步
- BP_GlassPanel（单块玻璃板）
- BP_GlassPair（双排玻璃板）
- BP_GlassBridge（玻璃桥生成器，样条线支持）
  - 真假玻璃布局在 DS 生成时确定（随机种子）
  - 布局信息通过 RepNotify 变量同步到客户端
  - **标记居中玻璃对为触发器**（用于观察系统分段切换）

#### Phase 3: 玻璃承重逻辑（基础）
- 在 Comp_Character_Sacrifice 中实现基础玻璃站立检测
- 在 BP_GlassPanel 中实现：
  - 真假玻璃类型设置
  - 单人站立检测
  - 假玻璃破碎消失

#### Phase 3.5: 拥挤机制 + 多人检测
- 在 BP_GlassPanel 中实现：
  - 多人站立检测（检测玻璃上的玩家数量）
  - 拥挤机制（第3人踏上真玻璃时，随机挤掉1人）
  - 网络同步处理（服务端权威，客户端表现）

#### Phase 3.6: 观察系统（视觉差异 + 分段切换）
- 前半段视觉差异（Volumetric Glass 材质）
  - 真玻璃和假玻璃使用不同的材质参数
- 后半段视觉差异消失
  - 灯光变暗或材质统一
- **分段切换机制**：
  - 居中玻璃对触发器直接调用 GS_Sacrifice 函数
  - SM_Sacrifice 从 FirstHalf 切换到 SecondHalf
  - GS_Sacrifice.CanObserve 变量控制视觉差异显示（RepNotify 同步）

#### Phase 4: Kill Volume 死亡触发 + 深渊效果
- 设置 Kill Volume（玻璃桥下方）
- 在 Comp_Character_Sacrifice 中处理 Kill Volume 触发
- 发送 Gameplay.Event.Player.Eliminated
- 复用 Core 架构的档案管理逻辑
- **死亡表现**：
  - Volumetric Glass 深渊效果（纯黑材质模拟深渊）
  - Character 坠落进入深渊后逐渐淡出（iTween）
  - 可以不销毁 Character，只是隐藏

#### Phase 5: 推搡系统集成（完整GAS）
- **创建关卡5专属的 GAS 能力**（参考关卡1，但不直接复用）：
  - GA_Sacrifice_Push（参考 GA_Push）
  - GA_Sacrifice_Stagger（参考 GA_Stagger）
  - GA_Sacrifice_Dodge（参考 GA_Dodge）
  - GA_Sacrifice_Jump（参考 GA_Jump）
- 配置 AbilitySet_Sacrifice（添加上述能力）
- 在 Comp_Character_Sacrifice 中实现推搡限制
  - 检测是否在同一块玻璃上（只能推同一块玻璃上的人）
  - 推搡失败无提示，操作直接无效
- **调整失衡后果**：
  - QTE 失败时不播放摔倒蒙太奇
  - 直接触发掉落（调用 Kill Volume 逻辑）
- 调整相关蒙太奇（如果需要）
- **失衡 QTE UI**：复用关卡1的 WBP_Endurance_QTE_Stagger

> [!NOTE]
> **为什么不直接复用关卡1的 GAS 能力**：关卡5的失衡后果（QTE 失败直接掉落）、推搡限制（只能推同一块玻璃上的人）等机制与关卡1不同，需要创建关卡5专属的 GAS 能力。关卡1的能力只是提供"参考"。

#### Phase 6: 金币测试系统（复用瞄准）
- **复用 GA_Aim**：
  - 瞄准逻辑（按住右键进入瞄准状态）
  - 预测线显示
  - 手持道具显示
- 创建 GA_ThrowCoin（参考 GA_Throw，简化投掷流程）
- 创建 BP_Item_Coin_Test（测试用金币）
  - 碰撞玻璃后发出声音（3D 空间音效）
  - 声音反馈后消失
- **重新设计互斥关系**：
  - 瞄准时不能推搡、跳跃等
  - 关卡5 没有其他投掷道具，互斥关系更简单
- 在 Comp_PC_Sacrifice 中实现金币数量显示

#### Phase 7: 场景完善（MRI 主题）
- MRI 主题场景搭建
- 起点台子（送入玩家）
- 灯光（手术灯）
- 装饰品

#### Phase 8: AI 行为
- 创建 BT_Sacrifice 行为树
- AI 观察逻辑
- AI 跳跃决策
- AI 推搡策略
- 在 GM_Sacrifice 中配置 Level Behavior Tree = BT_Sacrifice

#### Phase 9: UI 完善
- （预留，根据实际需要添加其他UI功能）

#### Phase 10: 特效/音效
- 玻璃破碎特效
- 坠落音效
- 金币测试音效

---

## 相关文档

- [系统架构.md](../00-通用逻辑/系统架构.md) - Core 层架构
- [关卡1 总体策划.md](../01-耐力之匣/总体策划.md) - 关卡1 设计参考
- [BP_BlackboardWall.md](../01-耐力之匣/场景/装饰组件/BP_BlackboardWall.md) - 黑板墙生成器参考
