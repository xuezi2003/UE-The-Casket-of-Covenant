# 输入与属性系统

## 一、输入映射

### IMC 架构设计

**每关卡独立 IMC 模式**：
- 每个关卡一个完整的 IMC（如 IMC_Endurance）
- IMC 包含通用输入（复制自 IMC_Core）+ 关卡专属输入
- Input Action 资产跨关卡共用（如 IA_Core_Move、IA_Core_Sprint）
- 不使用多 IMC 组合，简化管理

| IMC | 内容 | 使用场景 | 实现状态 |
|-----|------|----------|----------|
| IMC_Core | 移动、视角、跳跃、奔跑（模板） | 作为其他 IMC 的基础 | ✅ 已实现 |
| IMC_Endurance | IMC_Core 内容 + 蹲行、推搡、闪避、道具使用 | 关卡1、5 | ✅ 已创建 |
| IMC_Courage | IMC_Core 内容 + 戴/摘面具 | 关卡3 | ❌ 待实现 |

**配置方式**：
- GM 在 Spawn Character 时传入 LevelIMC
- BP_Character_Game.InitPlayer 里设置 GSCAbilityInputBinding.InputMappingContext = LevelIMC

**各关卡输入详情**：
- [关卡1/5 输入](../01-耐力之匣/输入映射.md)
- [关卡3 输入](../03-勇气之匣/输入映射.md)

### IMC_Core 输入动作列表

| Input Action | 按键 | 触发器 | 实现状态 |
|--------------|------|--------|----------|
| IA_Core_Move | WASD | - | ✅ 已实现 |
| IA_Core_Look | 鼠标 | - | ✅ 已实现 |
| IA_Core_Jump | 空格 | 已按下 + 已松开 | ✅ 已实现 |
| IA_Core_Sprint | 左Shift | 下移 (0.5) | ✅ 已实现 |

### 移动输入配置

| 按键 | 修改器 |
|------|--------|
| W | 拼合输入轴值 (YXZ) |
| S | 拼合输入轴值 (YXZ) + 否定 |
| A | 否定 (XYZ) |
| D | - |

### 视角输入配置

- 输入：鼠标 XY 2D轴
- 修改器：否定 (Z轴)

---

## 二、属性集 (BAS_Core)

使用 **Blueprint Attributes** 插件创建的蓝图 AttributeSet（`BAS_Core`），实现所有 GAS 属性。

> [!NOTE]
> 项目保持 **C++ 与蓝图混合架构**，便于后期扩展（原 C++ 实现的 `AS_Core` 已删除）。

### 属性列表

| 属性 | 基础值 | 最小值 | 最大值 | 说明 |
|------|--------|--------|--------|------|
| Coin | 0 | 0 | 无限制 | 金币（跨关卡） |
| Health | 100 | 0 | MaxHealth | 生命值 |
| MaxHealth | 100 | - | - | 最大生命值 |
| Stamina | 100 | 0 | MaxStamina | 体力 |
| MaxStamina | 100 | - | - | 最大体力 |
| SpeedRate | 1.0 | - | - | 速度倍率 |
| BaseSpeed | 350 | - | - | 基础速度 |

### 属性用途

- **Coin**：金币积分，跨关卡保留
- **Health**：生命值，归零即淘汰
- **MaxHealth**：最大生命值
- **Stamina**：体力，用于奔跑等消耗（关卡1、5）
- **MaxStamina**：最大体力
- **SpeedRate**：速度倍率，奔跑时修改此值
- **BaseSpeed**：基础移动速度

### 速度计算

```
最大行走速度 = Base Speed × Speed Rate
```

### 速度计算
```
最大行走速度 = Base Speed × Speed Rate
```

采用 **双重保险方案** 确保多端同步：

1. **BAS_Core (AttributeSet 蓝图)**：重写 `PostAttributeChange` 事件（覆盖 Server/Simulated）
2. **BP_Character_Game**：监听 `OnAttributeChange` 委托（补充本地预测）

```
Event PostAttributeChange (BAS_Core)
    ↓
HandleSpeedRateChanged

On Attribute Change (BP_Character_Game)
    ↓
HandleSpeedRateChanged
```

> [!NOTE]
> 这种组合方式既利用了 GAS 的底层复制通知，又通过本地委托处理了即时预测，确保在所有网络端和边缘情况下速度都能正确刷新。

---

## 三、GSC 组件配置

### GSCCore

| 设置 | 值 | 说明 |
|------|-----|------|
| 组件复制 | ✅ | ASC 需要复制属性到客户端 |
| 启用 Tick | ✅ | 可选，不需要可关闭 |
| 自动启用 | ❌ | 由系统自动管理 |

### GSCAbilityInputBinding

| 设置 | 值 | 说明 |
|------|-----|------|
| 组件复制 | ❌ | 输入绑定只在本地客户端 |
| Input Mapping Context | 运行时设置 | 由 InitPlayer 设置为 LevelIMC |
| 自动启用 | ❌ | - |

**注意**：组件默认不配置 IMC，在 InitPlayer 里根据 LevelIMC 变量动态设置。
