# 《契约之匣》系统架构文档

> 本文档为系统架构权威来源，各类详细实现见 [核心类/](核心类/) 目录。

---

## 一、核心设计理念

### 档案驱动实体 (Record-Driven Architecture)

**核心原则**：档案（GameInstance）存储数据，实体（PlayerState/Character）表现状态。

- 所有参赛者（真人+AI）的身份数据持久化存储在 `GI_FiveBox.PlayerRecords` 数组中
- 每关开始时从档案还原存活者，确保跨关卡数据一致性
- 真人与 AI 共享同一套 PlayerState 体系，便于统一管理

### 核心概念辨析

> [!IMPORTANT]
> 以下三个概念在系统中有明确的作用域和触发条件，请勿混淆。

#### 1. 玩家淘汰 (Player Elimination)

- **作用域**：跨关卡的永久状态
- **存储位置**：`GI_FiveBox.PlayerRecords[].IsEliminated`
- **触发时机**：
  - 关卡进行中死亡/失败（如血量归零时立即调用 `SetPlayerEliminate`）
  - 关卡结束时未完成的玩家（Settlement 阶段处理）
- **影响**：被淘汰的玩家不再参与后续任何关卡
- **相关文档**：[GI_FiveBox.md](核心类/GI_FiveBox.md#setplayereliminated-int-playernum--已实现)

#### 2. 关卡结束 (Level End)

- **作用域**：单个关卡的 InProgress 阶段结束
- **触发条件**（满足任一）：
  1. **限时结束**：`InProgressDuration` 到期
  2. **无存活进行者**：未完成且未淘汰的玩家数量为 0（`CheckLevelEndCondition` 返回 true）
- **触发机制**：`GS_Core.CheckLevelShouldEnd()` → 广播 `OnLevelShouldEnd` → MainSM 转换 InProgress → Settlement
- **后续流程**：进入 Settlement 阶段，然后无缝切换到下一关
- **相关文档**：[GS_Core.md](核心类/GS_Core.md#checklevelshoulden-已实现), [GI_FiveBox.md](核心类/GI_FiveBox.md#checklevelendcondition--已实现)

#### 3. 游戏会话结束 (Game Session End / DS Shutdown)

- **作用域**：整个游戏会话结束，Dedicated Server 关闭
- **触发条件**（满足任一）：
  1. **所有真人离场**：所有真人玩家死亡或掉线（即使 AI 仍存活）
  2. **所有关卡完成**：完成全部 5 个关卡后的最终结算
- **说明**：DS 不会在单个关卡结束后关闭，而是继续运行下一关
- **相关文档**：[总体策划.md](总体策划.md#关卡结束条件)

---

## 二、类层级结构

### Core 层（通用基类）

| 类名 | 类型 | 职责 | 详细文档 |
|------|------|------|----------|
| GI_FiveBox | GameInstance | 唯一编号工厂，跨关卡数据持久化 | [GI_FiveBox.md](核心类/GI_FiveBox.md) |
| GS_Core | GameState | 关卡状态管理，状态机驱动 | [GS_Core.md](核心类/GS_Core.md) |
| GM_Core | GameMode | 玩家登录、出生、AI 管理 | [GM_Core.md](核心类/GM_Core.md) |
| PC_Core | PlayerController | 玩家控制器基类 | [PC_Core.md](核心类/PC_Core.md) |
| PS_FiveBox | PlayerState | 玩家身份数据载体 | [PS_FiveBox.md](核心类/PS_FiveBox.md) |
| AIC_Core | AIController | AI 控制器，行为树驱动 | [AIC_Core.md](核心类/AIC_Core.md) |
| BP_Character_Game | Character | 玩家角色，移动与外观 | [BP_Character_Game.md](核心类/BP_Character_Game.md) |

### 关卡特化层

| 类名 | 父类 | 关键配置 |
|------|------|----------|
| GM_Endurance | GM_Core | GS: GS_Endurance, AbilitySet, AI_BT |
| GS_Endurance | GS_Core | PreparingDuration, InProgressDuration |

---

## 三、数据结构

### S_PlayerRecord（玩家档案）

| 字段 | 类型 | 默认值 | 用途 |
|------|------|--------|------|
| PlayerNum | 整数 | -1 | 玩家唯一编号（1-999） |
| AvatarData | S_AvatarData | - | 外观数据 |
| IsHuman | 布尔 | true | 是否真人玩家 |
| IsEliminated | 布尔 | false | 是否已淘汰 |
| IsFinished | 布尔 | false | 是否完成关卡目标 |
| IsConnected | 布尔 | true | 是否在线连接 |

**重要特性**：PlayerRecords 在第一关 FillAI 后数量固定，永不删除记录。

### S_AvatarData（外观数据）

| 字段 | 类型 |
|------|------|
| HairIndex | 整数 |
| EyeIndex | 整数 |
| FaceIndex | 整数 |
| ClothIndex | 整数 |

---

## 四、状态机系统

详见 [SM_LevelFlow_Main.md](核心类/SM_LevelFlow_Main.md)。

### SM_LevelFlow_Main 流程

```
Preparing (Init → WaitingStart → SetLock → FillAI)
    ↓
InProgress (Init → StartLevelSM → WaitingSettle → Complete)
    ↓
Settlement
```

**InProgress 结束条件**（双触发）：
- Timer：`InProgressDuration` 到期
- 事件：`GS_Core.OnLevelShouldEnd` 广播

---

## 五、数据流向

### 玩家登录流程
```
玩家连接 → OnPostLogin → GetUniquePlayerNum → RandomAvatar → PS 设置 → GI_FiveBox.AddPlayerRecord
```

### 外观同步流程
```
服务端修改 PS → OnRep → 广播事件 → Character 更新材质
```

### 关卡流转流程
```
GS_Core.BeginPlay → 状态机驱动 → 无缝切换到下一关
```

---

## 六、相关文档

- [外观加载.md](外观加载.md) - 玩家外观初始化与同步系统
- [输入系统.md](输入系统.md) - 输入映射架构
- [UI 架构概述](UI/架构概述.md) - UI 分类与 Widget 架构
- [属性系统.md](属性系统.md) - GAS 属性集配置
- [等待大厅.md](等待大厅.md) - 匹配等待系统（待实现）
- [GameplayTags.csv](GameplayTags.csv) - Gameplay Tags 定义

