# 《契约之匣》系统架构文档

> 本文档为系统架构权威来源，各类详细实现见 [核心类/](核心类/) 目录。

---

## 一、核心设计理念

### 档案驱动实体 (Record-Driven Architecture)

**核心原则**：档案（GameInstance）存储数据，实体（PlayerState/Character）表现状态。

- 所有参赛者（真人+AI）的身份数据持久化存储在 `GI_FiveBox.PlayerRecords` 数组中
- 每关开始时从档案还原存活者，确保跨关卡数据一致性
- 真人与 AI 共享同一套 PlayerState 体系，便于统一管理

### 核心概念辨析

> [!IMPORTANT]
> 以下三个概念在系统中有明确的作用域和触发条件，请勿混淆。

#### 1. 玩家淘汰 (Player Elimination)

- **作用域**：跨关卡的永久状态
- **存储位置**：`GI_FiveBox.PlayerRecords[].IsEliminated`
- **触发时机**：
  - 关卡进行中死亡/失败（如血量归零时立即调用 `SetPlayerEliminate`）
  - 关卡结束时未完成的玩家（Settlement 阶段处理）
- **影响**：被淘汰的玩家不再参与后续任何关卡
- **相关文档**：[GI_FiveBox.md](核心类/GI_FiveBox.md#setplayereliminated-int-playernum--已实现)

#### 2. 关卡结束 (Level End)

- **作用域**：单个关卡的 InProgress 阶段结束
- **触发条件**（满足任一）：
  1. **限时结束**：`InProgressDuration` 到期
  2. **无存活进行者**：未完成且未淘汰的玩家数量为 0（`CheckLevelEndCondition` 返回 true）
- **触发机制**：`GS_Core.CheckLevelShouldEnd()` → 广播 `OnLevelShouldEnd` → MainSM 转换 InProgress → Settlement
- **后续流程**：进入 Settlement 阶段，然后无缝切换到下一关
- **相关文档**：[GS_Core.md](核心类/GS_Core.md#checklevelshoulden-已实现), [GI_FiveBox.md](核心类/GI_FiveBox.md#checklevelendcondition--已实现)

#### 3. 游戏会话结束 (Game Session End / DS Shutdown) ⚠️ 待实现

- **作用域**：整个游戏会话结束，Dedicated Server 关闭
- **触发条件**（满足任一）：
  1. **所有真人离场**：所有真人玩家死亡或掉线（即使 AI 仍存活）
  2. **所有关卡完成**：完成全部 5 个关卡后的最终结算
- **说明**：DS 不会在单个关卡结束后关闭，而是继续运行下一关
- **相关文档**：[总体策划.md](总体策划.md#关卡结束条件)

> [!WARNING]
> **实现状态**：⚠️ 待实现
> 
> DS 结束判定尚未实现，计划在开发完至少两个关卡后再实现。
> 
> **需要实现的功能**：
> - `GI_FiveBox.CheckAllHumansEliminated()` - 检查所有真人是否已淘汰或掉线
> - `GM_Core` 或 `GS_Core` 中的 DS 关闭逻辑
> - `PC_Core.HandlePlayerEliminate` 中触发 DS 结束检查
> 
> **当前已实现**：
> - ✅ 关卡结束判定（`GI_FiveBox.CheckLevelEndCondition`）
> - ✅ 单个玩家的真人检查（`GI_FiveBox.CheckIsHuman`）

---

## 二、类层级结构

### Core 层（通用基类）

| 类名 | 类型 | 职责 | 详细文档 |
|------|------|------|----------|
| GI_FiveBox | GameInstance | 唯一编号工厂，跨关卡数据持久化 | [GI_FiveBox.md](核心类/GI_FiveBox.md) |
| GS_Core | GameState | 关卡状态管理，状态机驱动 | [GS_Core.md](核心类/GS_Core.md) |
| GM_Core | GameMode | 玩家登录、出生、AI 管理 | [GM_Core.md](核心类/GM_Core.md) |
| PC_Core | PlayerController | 玩家控制器基类 | [PC_Core.md](核心类/PC_Core.md) |
| PS_FiveBox | PlayerState | 玩家身份数据载体 | [PS_FiveBox.md](核心类/PS_FiveBox.md) |
| AIC_Core | AIController | AI 控制器，行为树驱动 | [AIC_Core.md](核心类/AIC_Core.md) |
| BP_Character_Game | Character | 玩家角色，移动与外观 | [BP_Character_Game.md](核心类/BP_Character_Game.md) |

### 关卡特化层

| 类名 | 父类 | 关键配置 |
|------|------|----------|
| GM_Endurance | GM_Core | GS: GS_Endurance, AbilitySet, AI_BT |
| GS_Endurance | GS_Core | PreparingDuration, InProgressDuration |

---

## 三、数据结构

### S_PlayerRecord（玩家档案）

| 字段 | 类型 | 默认值 | 用途 |
|------|------|--------|------|
| PlayerNum | 整数 | -1 | 玩家唯一编号（1-999） |
| AvatarData | S_AvatarData | - | 外观数据 |
| IsHuman | 布尔 | true | 是否真人玩家 |
| IsEliminated | 布尔 | false | 是否已淘汰 |
| IsFinished | 布尔 | false | 是否完成关卡目标 |
| IsConnected | 布尔 | true | 是否在线连接 |

**重要特性**：PlayerRecords 在第一关 FillAI 后数量固定，永不删除记录。

### S_AvatarData（外观数据）

| 字段 | 类型 |
|------|------|
| HairIndex | 整数 |
| EyeIndex | 整数 |
| FaceIndex | 整数 |
| ClothIndex | 整数 |

---

## 四、状态机系统

详见 [SM_LevelFlow_Main.md](核心类/SM_LevelFlow_Main.md)。

### SM_LevelFlow_Main 流程

```
Preparing (Init → WaitingStart → SetLock → FillAI)
    ↓
InProgress (Init → StartLevelSM → WaitingSettle → Complete)
    ↓
Settlement
```

**InProgress 结束条件**（双触发）：
- Timer：`InProgressDuration` 到期
- 事件：`GS_Core.OnLevelShouldEnd` 广播

---

## 五、数据流向

### 玩家登录流程
```
玩家连接 → OnPostLogin → GetUniquePlayerNum → RandomAvatar → PS 设置 → GI_FiveBox.AddPlayerRecord
    ↓
Spawn Default Pawn For → BP_Character_Game
    ↓
BP_Character_Game.BeginPlay → WaitForPlayerState → InitPlayer → HandlePlayerRecord（绑定事件监听，Server Only）
```

### 外观同步流程
```
服务端修改 PS → OnRep → 广播事件 → Character 更新材质
```

### 关卡流转流程
```
GS_Core.BeginPlay → 状态机驱动 → 无缝切换到下一关
```

### 玩家淘汰流程
```
玩家死亡 → Comp_Character_Endurance.HandleHealthChanged
    ├─ 应用死亡标签（GE_Dead）
    ├─ 死亡广播（周围玩家触发 Stagger.DeathBroadcast 类型失衡）
    ├─ 掉落金币
    ├─ Ragdoll 表现
    └─ 发送 Gameplay.Event.Player.Eliminated
        ↓
        ├─ BP_Character_Game.HandlePlayerEliminate（监听事件，Server Only）
        │   ├─ GI_FiveBox.SetPlayerEliminated(PlayerNum)
        │   └─ GS_Core.CheckLevelShouldEnd()
        │
        └─ PC_Core.HandlePlayerEliminate（监听事件，仅真人）
            ├─ UnPossess()
            └─ 返回主菜单（待实现）
```

### 玩家完成流程
```
玩家到达终点 → BP_FinishLine.OnComponentEndOverlap
    └─ 发送 Gameplay.Event.Player.Finished
        ↓
        ├─ BP_Character_Game.HandlePlayerFinish（监听事件，Server Only）
        │   ├─ GI_FiveBox.SetPlayerFinished(PlayerNum)
        │   └─ GS_Core.CheckLevelShouldEnd()
        │
        └─ Comp_Character_Endurance.HandlePlayerFinish（监听事件，All Clients）
            ├─ 应用 GE_Finish（添加 Player.State.Finished 标签）
            └─ 切换碰撞通道（PawnBlock → Pawn）
```

---

## 六、职责分工

### 核心类职责

| 类 | 职责 | 关键函数 |
|---|------|----------|
| **GI_FiveBox** | 档案管理、唯一编号工厂 | AddPlayerRecord, SetPlayerEliminated, SetPlayerFinished, CheckLevelEndCondition |
| **GM_Core** | 玩家登录、出生、AI 管理 | OnPostLogin, RestoreAISurvivors, FillAIPlayers |
| **GS_Core** | 关卡状态管理、状态机驱动、**关卡结束检查** | CheckLevelShouldEnd, OnLevelShouldEnd |
| **PC_Core** | 玩家控制器、UI 管理、**真人特殊逻辑** | HandlePlayerEliminate（UnPossess + 返回主菜单） |
| **PS_FiveBox** | 玩家身份数据载体 | PlayerNum, AvatarData |
| **BP_Character_Game** | 角色移动、外观表现、**档案事件监听** | InitPlayer, UpdateAvatar, HandlePlayerRecord, HandlePlayerFinish, HandlePlayerEliminate |

### 关卡组件职责

| 组件 | 职责 | 关键函数 |
|------|------|----------|
| **Comp_Character_Endurance** | 角色层面的死亡表现、状态标记、碰撞切换 | HandleHealthChanged, HandlePlayerStart, HandlePlayerFinish |
| **BP_FinishLine** | 场景触发、事件发送 | OnComponentEndOverlap, CheckHasThrough |
| **BP_StartLine** | 场景触发、事件发送 | OnComponentEndOverlap, CheckHasThrough |

### 架构优势

**档案驱动**：
- GI 存储数据（PlayerRecords）
- Character 监听事件并更新档案（HandlePlayerFinish/HandlePlayerEliminate）
- PS/Character 表现状态（标签、外观、碰撞）

**职责清晰**：
- 场景 Actor 只负责触发和事件发送
- Character 组件负责角色层面的表现逻辑
- Character 基类负责通用的档案管理逻辑
- GM 只负责玩家登录和 AI 管理
- PC 只负责真人玩家的特殊逻辑

**生命周期一致**：
- Character 在 BeginPlay 时自己绑定事件监听器
- 监听器生命周期与 Character 一致，无需手动管理
- 真人和 AI 使用完全相同的逻辑

---

## 七、相关文档

- [外观加载.md](外观加载.md) - 玩家外观初始化与同步系统
- [输入系统.md](输入系统.md) - 输入映射架构
- [UI 架构概述](UI/架构概述.md) - UI 分类与 Widget 架构
- [属性系统.md](属性系统.md) - GAS 属性集配置
- [等待大厅.md](等待大厅.md) - 匹配等待系统（待实现）
- [GameplayTags.csv](GameplayTags.csv) - Gameplay Tags 定义

