# 通用逻辑 总体策划

## 游戏流程

### 关卡阶段 (Match.Phase.Main)

每个关卡都经历三个阶段，由状态树 `ST_LevelFlow` 管理：

| 阶段 | Tag | 说明 |
|------|-----|------|
| 准备阶段 | Match.Phase.Main.Preparing | 玩家登记、AI 填充、倒计时 |
| 进行阶段 | Match.Phase.Main.InProgress | 名单锁定，比赛正式开始 |
| 结算阶段 | Match.Phase.Main.Settlement | 展示结果与 MVP |

各关卡的"进行阶段"玩法不同，可加载子状态树实现。

### 运行状态 (Match.Status)

| 状态 | Tag | 说明 |
|------|-----|------|
| 名单锁定 | Match.Status.Locked | 准备阶段结束，不再接受新玩家 |
| 比赛中止 | Match.Status.Aborted | 特殊原因导致比赛强行中止 |

### 关卡结束条件

每个关卡结束由以下任一条件触发：
1. **关卡胜利条件**：各关卡各不相同
2. **限时结束**：进行阶段计时器到期
3. **无真人在场**：所有真人死亡或掉线 → DS 关闭

### 玩家身份

- 每关开始时，玩家的 PlayerNum、Avatar 必须初始化到 PlayerState
- AI 也有 PlayerState，与真人统一处理
- 掉线玩家由 AI 接管

## GAS 使用原则

- 无缝切换保留 PlayerState → GSC 挂载的属性也保留
- 每个关卡使用独立的 Ability Set
- 不设计跨关卡道具，简化系统复杂度

## 核心架构总结

### 档案驱动实体 (Record-Driven Architecture)

- **唯一编号工厂**：GI_FiveBox 维护 1-999 随机去重编号池
- **全局数据账本**：GI_FiveBox.PlayerRecords 存储所有参赛者档案
- **身份动态注入**：RestoreAISurvivors 为存活 AI 还原实体并注入档案

### 生成系统

- **出生点拦截**：GM_Core 重写 OnRestartPlayer，改用 RestartPlayerAtTransform
- **虚函数坐标**：GetSpawnPos 由子类提供具体坐标（如 GM_Level1 的 BornVol）

### 状态树流程

完整链路：Preparing → SetLock → FillAI → InProgress → Settlement

- 自定义任务需补全 Finish Task 节点
- 利用子状态层级确保时序正确

---

## AI 与玩家统一设计（待实现）

### 核心原则

**操作层统一，触发层分离**
- 玩家和 AI 共享同一套操作接口
- 玩家通过输入触发，AI 通过行为树触发

### 感知系统

**前方检测框（DetectionBox）**
- 位置：挂在 `BP_Character_Game` 前方
- 作用：检测可交互对象（其他玩家、道具）
- 接口：`GetOverlappingPlayers()`、`GetOverlappingItems()`
- 玩家用于 UI 提示，AI 用于行为树决策

### 输入系统

**IMC 分层**

| IMC | 内容 | 使用场景 |
|-----|------|----------|
| IMC_Core | 移动、视角、跳跃 | 所有关卡，始终激活 |
| IMC_Endurance | 蹲、奔跑 | 关卡1、5 |
| IMC_Courage | 戴/摘面具 | 关卡3 |

**输入管理方式**
- GAS 操作 → Ability Set 自动绑定/解绑
- 非 GAS 操作 → 手动 Add/Remove MappingContext

### 操作系统

**组件化 + GM 配置驱动**

| 组件 | 关卡 | 职责 |
|------|------|------|
| Comp_Endurance | 1、5 | 推搡、闪避、投掷、体力管理 |
| Comp_Logic | 2 | 选房间、答题 |
| Comp_Courage | 3 | 戴/摘面具、收集线索 |
| Comp_Insight | 4 | 站队投票 |

**GM 子类配置**

| GM | LevelComponentClass | AI_BT | AbilitySet | IMC |
|----|---------------------|-------|------------|-----|
| GM_Endurance | Comp_Endurance | BT_Endurance | AbilitySet_Endurance | IMC_Endurance |
| GM_Logic | Comp_Logic | BT_Logic | 无 | 无 |
| GM_Courage | Comp_Courage | BT_Courage | 无 | IMC_Courage |
| GM_Insight | Comp_Insight | BT_Insight | 无 | 无 |
| GM_Sacrifice | Comp_Endurance | BT_Sacrifice | AbilitySet_Endurance | IMC_Endurance |

**生成流程**
```
GM_Xxx.OnPostLogin / RestoreAISurvivors
    ↓
SpawnCharacter (BP_Character_Game)
    ↓
AddComponent(LevelComponentClass)
    ↓
GiveAbilitySet + AddMappingContext
```

### AI 控制器

- `AIC_Core` 通用，**不需要子类**
- 行为树由 GM 子类的 `AI_BT` 配置
- AI 通过 GSC 的 `BTTask_TriggerAbility` 触发 GAS 操作
- AI 通过自定义 BTTask 调用组件的 `TryXxx()` 接口

### QTE 处理

```
触发失衡 → IsLocallyControlled?
    ├── True（玩家）→ QTE UI → 等待输入
    └── False（AI）→ 服务器按概率判定
```

### 类职责总览

| 类/组件 | 职责 | 实现状态 |
|---------|------|----------|
| BP_Character_Game | 唯一 Character（通用 + DetectionBox） | ⚠️ DetectionBox 待实现 |
| GM_Xxx | 配置关卡专属：组件、行为树、技能集、输入 | ⚠️ 待实现 |
| Comp_Xxx | 关卡专属操作接口（TryXxx） | ❌ 待实现 |
| AIC_Core | 通用 AI 控制器 | ✅ 已实现 |
| BT_Xxx | 关卡专属行为树 | ❌ 待实现 |
| AbilitySet_Xxx | 关卡专属技能集 | ❌ 待实现 |
| IMC_Core | 通用输入 | ✅ 已实现 |
| IMC_Xxx | 关卡专属非 GAS 输入 | ❌ 待实现 |
