# 通用逻辑 总体策划

> 本文档为设计概述，详细架构见 [系统架构.md](系统架构.md)，各类详细文档见 [核心类/](核心类/) 目录。

## 游戏流程

### 关卡阶段与状态

- 每个关卡经历三个阶段：准备 → 进行 → 结算，由 [SM_LevelFlow_Main](核心类/SM_LevelFlow_Main.md) 管理
- 完整 Gameplay Tags 定义见 [GameplayTags.csv](GameplayTags.csv)

### 关卡结束条件

每个关卡结束由以下任一条件触发：
1. **关卡胜利条件**：各关卡各不相同
2. **限时结束**：进行阶段计时器到期
3. **无真人在场**：所有真人死亡或掉线 → DS 关闭

### 玩家身份

- 每关开始时，玩家的 PlayerNum、Avatar 必须初始化到 PlayerState
- AI 也有 PlayerState，与真人统一处理
- 掉线玩家由 AI 接管

## GAS 使用原则

- 无缝切换保留 PlayerState → GSC 挂载的属性也保留
- 每个关卡使用独立的 Ability Set
- 不设计跨关卡道具，简化系统复杂度
- 详细属性配置见 [属性系统.md](属性系统.md)

## 核心架构

> 详细架构、类层级、数据结构见 [系统架构.md](系统架构.md)

核心设计理念：
- **档案驱动实体**：GameInstance 存储数据，PlayerState/Character 表现状态
- **GM 配置驱动**：各关卡通过 GM 子类配置组件、行为树、技能集
- **状态机流程**：Preparing → InProgress → Settlement

---

## AI 与玩家统一设计（待实现）

### 核心原则

**操作层统一，触发层分离**
- 玩家和 AI 共享同一套操作接口
- 玩家通过输入触发，AI 通过行为树触发
- AI 控制器使用通用 [AIC_Core](核心类/AIC_Core.md)，不需要子类

### 感知系统

**前方检测框（DetectionBox）**
- 位置：挂在 [BP_Character_Game](核心类/BP_Character_Game.md) 前方
- 作用：检测可交互对象（其他玩家、道具）
- 玩家用于 UI 提示，AI 用于行为树决策

### 输入与操作系统

- **输入映射**：IMC 分层设计，详见 [输入系统.md](输入系统.md)
- **操作组件**：各关卡专属组件（Comp_Xxx），GM 配置驱动，详见 [GM_Core.md](核心类/GM_Core.md)

### QTE 处理

```
触发失衡 → IsLocallyControlled?
    ├── True（玩家）→ QTE UI → 等待输入
    └── False（AI）→ 服务器按概率判定
```
