# 输入系统

## 一、IMC 架构设计

### 每关卡独立 IMC 模式

- 每个关卡一个完整的 IMC（如 IMC_Endurance）
- IMC 包含通用输入（复制自 IMC_Core）+ 关卡专属输入
- Input Action 资产可跨关卡使用（如 IA_Core_Move、IA_Core_Sprint）
- 不使用多 IMC 组合，简化管理

### IMC 列表

| IMC | 内容 | 使用场景 | 状态 |
|-----|------|----------|------|
| IMC_Core | 移动、视角、跳跃、奔跑（模板） | 作为其他 IMC 的基础 | ✅ |
| IMC_Endurance | IMC_Core 内容 + 蹲行、推搡、闪避、道具 | 关卡1、5 | ✅ |
| IMC_Courage | IMC_Core 内容 + 戴/摘面具 | 关卡3 | ❌ |

### 配置方式

```
GM 在 Spawn Character 时传入 LevelIMC（Expose on Spawn）
    ↓
LevelIMC 复制到客户端 → 触发 OnRep_LevelIMC
    ↓
OnRep_LevelIMC（仅 IsLocallyControlled）
    → GSCAbilityInputBinding.InputMappingContext = LevelIMC
```

> [!NOTE]
> **为什么使用 RepNotify**：在 Dedicated Server 模式下，客户端的 `LevelIMC` 通过复制获取，时序不确定。使用 `OnRep_LevelIMC` 确保复制完成后再设置，避免间歇性输入失效。

---

## 二、IMC_Core 输入动作

| Input Action | 按键 | 触发器 | 状态 |
|--------------|------|--------|------|
| IA_Core_Move | WASD | - | ✅ |
| IA_Core_Look | 鼠标 | - | ✅ |
| IA_Core_Jump | 空格 | 已按下 + 已松开 | ✅ |
| IA_Core_Sprint | 左Shift | 下移 (0.5) | ✅ |

### 移动输入配置

| 按键 | 修改器 |
|------|--------|
| W | 拼合输入轴值 (YXZ) |
| S | 拼合输入轴值 (YXZ) + 否定 |
| A | 否定 (XYZ) |
| D | - |

### 视角输入配置

- 输入：鼠标 XY 2D轴
- 修改器：否定 (Z轴)

---

## 三、输入分层

| 输入类型 | 管理位置 | 实现方式 |
|----------|----------|----------|
| **游戏技能输入** | Character | `GSCAbilityInputBinding` |
| **关卡特殊输入** | `Comp_PC_<Level>` | InputAction + ServerRPC |
| **QTE 输入** | `Comp_PC_<Level>` | InputAction（客户端判定） |
| **菜单操作（ESC）** | `PC_Core` | InputAction → `Comp_UI_Core.ToggleGameMenu()` |

### 关卡特殊输入 RPC

```
Comp_PC_<Level>
├── BindInputAction(IA_Vote_Yes) → ServerRPC_SubmitVote(true)
├── BindInputAction(IA_Vote_No) → ServerRPC_SubmitVote(false)
├── BindInputAction(IA_Interact) → ServerRPC_Interact(Target)
└── BindInputAction(IA_QTE) → 客户端判定 → Server_QTEResult
```

---

## 四、GSCAbilityInputBinding 配置

| 设置 | 值 | 说明 |
|------|-----|------|
| 组件复制 | ❌ | 输入绑定只在本地客户端 |
| Input Mapping Context | 运行时设置 | 由 InitPlayer 设置为 LevelIMC |
| 自动启用 | ❌ | - |

> **注意**：组件默认不配置 IMC，在 InitPlayer 里根据 LevelIMC 变量动态设置。

---

## 五、关卡专属输入

各关卡专属输入详见：

- [关卡1 输入映射](../01-耐力之匣/输入映射.md)
- [关卡3 输入映射](../03-勇气之匣/输入映射.md)（待创建）

---

## 相关文档

- [属性系统.md](属性系统.md)
- [UI 架构概述](UI/架构概述.md)
- [GM_Core.md](核心类/GM_Core.md)
