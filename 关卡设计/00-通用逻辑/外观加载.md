# 玩家外观初始化系统

## 核心设计思想

**事件驱动的延迟初始化 + 数据表驱动的动态贴图系统**

在 `BP_Character_Game` 中实现，确保 Character 能正确同步 PlayerState 上的外观数据。

---

## 一、初始化流程（时序保护）

1. `Event BeginPlay` → `Wait for Player State`
2. 设置 0.1 秒循环定时器轮询 `WaitForPlayerState`
3. 定时器回调中 `Cast To PS_FiveBox`
4. Cast 成功后：
   - 调用 `Init Player` 绑定事件
   - `Clear Timer` 停止轮询

这解决了 Character 生成时 PlayerState 可能还未复制到客户端的时序问题。

---

## 二、事件绑定（响应式监听）

`Init Player` 函数中：
- 保存 PS 引用
- 绑定 `On Player Avatar Change` → `HandleAvatarChange`
- 绑定 `On Player Num Change` → `HandleNumChange`

这样无论是初始化时还是运行时 PlayerState 数据变化，Character 都能正确同步外观。

---

## 三、外观更新函数

### Update Player Avatar

- 材质插槽：`Monitor`（SM Monitor 组件）
- 数据表：`DT_Tex_Avatar_Path`
- 输入：Avatar Data 结构体（Hair/Eye/Face/Cloth Index）
- 输出贴图参数：`Tex_Hair`、`Tex_Eye`、`Tex_Face`、`Tex_Cloth`

### Update Player Num

- 材质插槽：`Cloth`（Mesh 组件）
- 数据表：`DT_Tex_Num_Format`
- 输入：PlayerNum（1-999）
- 数字拆分：个位 `%10`、十位 `%100/10`、百位 `/100`
- 输出贴图参数：`Tex_1`、`Tex_10`、`Tex_100`

### 统一加载流程

```
Get Data Table Row → Format Text → Make Soft Object Path → Load Asset Blocking → Cast To Texture2D → Set Texture Parameter Value
```

---

## 四、关键资产

| 类型 | 名称 | 用途 |
|------|------|------|
| 数据表 | DT_Tex_Avatar_Path | 存储 Hair/Eye/Face/Cloth 贴图路径模板 |
| 数据表 | DT_Tex_Num_Format | 存储 0-9 数字贴图路径 |
| 动态材质 | Temp Monitor Mat | Avatar 外观材质实例 |
| 动态材质 | Temp Cloth Mat | 编号显示材质实例 |
